/* /di/css/lane.css */
/* =========================================================
   DiCo LANE – “Cute Neon Pulse” (FINAL)
   - NOTES(canvas) always on top
   - LANE behind canvas (no more notes-under-lane)
   - Visible breathing (strong amplitude)
   - Shimmer + melt fade top/bottom
   - Target synchronized pulse
   - Hit boost (Safari-safe fallback)
   - Bright judge + light result
   ========================================================= */

/* =========================================================
   0) LAYER FIX (MOST IMPORTANT)
   ========================================================= */

/* notes canvas -> front */
.noteCanvas{
  position: relative;
  z-index: 8;          /* ✅ notes are always above the lane */
}

/* tap/hit FX layer -> above notes */
.hitZone{
  position:absolute;
  inset:0;
  z-index: 9;
  pointer-events:none;
}

/* target/judge/result -> top */
.targetRoot{ z-index: 10; }
.judge{ z-index: 11; }
.result{ z-index: 20; }

/* =========================================================
   1) CENTER LANE (behind canvas)
   ========================================================= */

/* Lane body (glass) */
.stage::before{
  content:"";
  position:absolute;
  left:50%;
  top:-14vh;                 /* extend beyond screen */
  bottom:-16vh;
  transform: translateX(-50%) translateZ(0);

  /* ✅ lane width: adjust here */
  width: min(190px, 50vw);

  /* ✅ LANE BEHIND CANVAS */
  z-index: 2;
  pointer-events:none;

  border-radius: 30px;

  background:
    linear-gradient(180deg,
      rgba(255,255,255,.10),
      rgba(255,255,255,.03) 42%,
      rgba(255,255,255,.02) 100%
    );

  outline: 1px solid rgba(255,255,255,.11);

  box-shadow:
    inset 2px 0 0 rgba(0,240,255,.58),
    inset -2px 0 0 rgba(156,60,255,.48),
    inset 0 0 44px rgba(0,240,255,.06),
    inset 0 0 72px rgba(156,60,255,.05),
    0 18px 70px rgba(0,0,0,.12),
    0 0 40px rgba(0,240,255,.10);

  backdrop-filter: blur(9px);
  -webkit-backdrop-filter: blur(9px);

  opacity: .74;

  will-change: opacity, filter, box-shadow;
  animation: laneBreatheStrong 2.4s ease-in-out infinite;
}

/* Shimmer layer (cute disco gloss) */
.stage::after{
  content:"";
  position:absolute;
  left:50%;
  top:-14vh;
  bottom:-16vh;
  transform: translateX(-50%) translateZ(0);

  width: min(230px, 56vw);

  /* ✅ behind canvas too */
  z-index: 2;
  pointer-events:none;

  border-radius: 30px;

  background:
    linear-gradient(115deg,
      transparent 0%,
      rgba(0,240,255,.20) 18%,
      rgba(156,60,255,.16) 46%,
      rgba(230,201,107,.12) 62%,
      transparent 82%
    );

  background-size: 520px 100%;
  background-position: 0 0;

  mix-blend-mode: screen;

  opacity: .46;
  filter: blur(.25px);

  will-change: opacity, filter, background-position;

  animation:
    laneShimmer 2.2s linear infinite,
    laneBreatheStrong 2.4s ease-in-out infinite;
}

/* Smooth top/bottom fade (melt into screen) */
.stage::before,
.stage::after{
  -webkit-mask-image: linear-gradient(to bottom, transparent, #000 10%, #000 90%, transparent);
  mask-image: linear-gradient(to bottom, transparent, #000 10%, #000 90%, transparent);
}

@keyframes laneShimmer{
  0%   { background-position: -320px 0; }
  100% { background-position:  320px 0; }
}

/* ✅ Strong visible breathing (what you asked for) */
@keyframes laneBreatheStrong{
  0%,100%{
    opacity: .70;
    filter: brightness(1.00) saturate(1.08);
    box-shadow:
      inset 2px 0 0 rgba(0,240,255,.55),
      inset -2px 0 0 rgba(156,60,255,.45),
      inset 0 0 44px rgba(0,240,255,.06),
      inset 0 0 78px rgba(156,60,255,.05),
      0 16px 64px rgba(0,0,0,.10),
      0 0 28px rgba(0,240,255,.10);
  }
  50%{
    opacity: .92; /* ✅ peak is obvious */
    filter: brightness(1.20) saturate(1.28);
    box-shadow:
      inset 2px 0 0 rgba(0,240,255,.86),
      inset -2px 0 0 rgba(156,60,255,.76),
      inset 0 0 62px rgba(0,240,255,.12),
      inset 0 0 100px rgba(156,60,255,.10),
      0 20px 84px rgba(0,0,0,.08),
      0 0 58px rgba(0,240,255,.20);
  }
}

/* =========================================================
   2) TARGET (synchronized pulse)
   ========================================================= */

.targetRoot{
  position:absolute;
  left:50%;
  top:50%;
  transform: translate(-50%, -50%) translateZ(0);
  width: 178px;
  height: 178px;
  pointer-events:none;

  will-change: transform, filter;
  animation: targetBreathe 2.4s ease-in-out infinite;
}

.targetOuter, .targetCore, .targetRing{
  position:absolute;
  inset:0;
  border-radius:999px;
}

.targetOuter{
  background:
    radial-gradient(circle at 50% 50%,
      rgba(255,255,255,.07) 0%,
      rgba(255,255,255,.04) 44%,
      rgba(0,0,0,.12) 78%,
      rgba(0,0,0,.18) 100%);
  outline: 1px solid rgba(255,255,255,.14);

  box-shadow:
    0 12px 46px rgba(0,0,0,.18),
    0 0 34px rgba(0,240,255,.10);

  will-change: opacity, box-shadow, background;
  animation: outerPulse 2.4s ease-in-out infinite;
}

.targetCore{
  inset: 44px;
  background:
    radial-gradient(circle at 45% 40%,
      rgba(255,255,255,.32),
      rgba(255,255,255,.12) 40%,
      rgba(0,0,0,.08) 78%);

  border: 1px solid rgba(255,255,255,.18);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);

  will-change: opacity, background, box-shadow;
  animation: corePulse 2.4s ease-in-out infinite;
}

.targetRing{
  inset: 12px;
  border: 2px solid rgba(0,240,255,.34);

  box-shadow:
    0 0 0 1px rgba(156,60,255,.16),
    0 0 24px rgba(0,240,255,.22),
    0 0 34px rgba(156,60,255,.18),
    0 0 26px rgba(230,201,107,.12);

  will-change: border-color, box-shadow, filter, opacity;
  animation: ringPulse 2.4s ease-in-out infinite;
}

/* scan line */
.scanLine{
  position:absolute;
  left: 16px;
  right: 16px;
  top: 50%;
  height: 2px;
  transform: translateY(-50%);
  background: linear-gradient(90deg,
    transparent,
    rgba(0,240,255,.95),
    rgba(156,60,255,.70),
    transparent);
  opacity:0;
  filter: blur(.2px);
  will-change: opacity, transform, filter;
  animation: scanMove 1.05s ease-in-out infinite;
}
@keyframes scanMove{
  0%,100%{ transform: translateY(-50%) scaleX(.92); }
  50%    { transform: translateY(-50%) scaleX(1.10); }
}
.app[data-state="playing"] .scanLine{
  opacity:.92;
}

/* hit flash */
.hitFlash{
  position:absolute;
  inset:-12px;
  border-radius:999px;
  background:
    radial-gradient(circle at 50% 50%,
      rgba(0,240,255,.48),
      rgba(156,60,255,.24) 46%,
      transparent 70%);
  opacity:0;
  transform: scale(.98);
  transition: opacity .11s ease, transform .11s ease, filter .11s ease;
  filter: blur(.1px);
}

/* ✅ Hit boost (works if JS adds .hitActive on .app) */
.app.hitActive .stage::before{
  opacity: .98;
  filter: brightness(1.22) saturate(1.35);
}
.app.hitActive .targetRing{
  border-color: rgba(0,240,255,.62);
  box-shadow:
    0 0 0 1px rgba(156,60,255,.28),
    0 0 40px rgba(0,240,255,.34),
    0 0 54px rgba(156,60,255,.24),
    0 0 38px rgba(230,201,107,.18);
}

/* Optional :has() (nice-to-have, not required) */
.targetRoot:has(#hitFlash[style*="opacity: 1"]),
.targetRoot:has(#hitFlash[style*="opacity:1"]){
  filter: brightness(1.10) saturate(1.25);
}

/* sync keyframes */
@keyframes targetBreathe{
  0%,100%{
    transform: translate(-50%, -50%) scale(1);
    filter: saturate(1.06) brightness(1.00);
  }
  50%{
    transform: translate(-50%, -50%) scale(1.03);
    filter: saturate(1.18) brightness(1.08);
  }
}
@keyframes ringPulse{
  0%,100%{
    border-color: rgba(0,240,255,.30);
    opacity:.92;
    filter: brightness(1.0);
    box-shadow:
      0 0 0 1px rgba(156,60,255,.14),
      0 0 22px rgba(0,240,255,.18),
      0 0 30px rgba(156,60,255,.14),
      0 0 22px rgba(230,201,107,.10);
  }
  50%{
    border-color: rgba(0,240,255,.50);
    opacity:1;
    filter: brightness(1.12);
    box-shadow:
      0 0 0 1px rgba(156,60,255,.22),
      0 0 34px rgba(0,240,255,.28),
      0 0 44px rgba(156,60,255,.20),
      0 0 30px rgba(230,201,107,.14);
  }
}
@keyframes corePulse{
  0%,100%{
    opacity:.94;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.16), 0 10px 30px rgba(0,0,0,.18);
    background:
      radial-gradient(circle at 45% 40%,
        rgba(255,255,255,.30),
        rgba(255,255,255,.12) 42%,
        rgba(0,0,0,.08) 78%);
  }
  50%{
    opacity:1;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.18), 0 12px 34px rgba(0,0,0,.14);
    background:
      radial-gradient(circle at 45% 40%,
        rgba(255,255,255,.38),
        rgba(0,240,255,.12) 38%,
        rgba(0,0,0,.06) 78%);
  }
}
@keyframes outerPulse{
  0%,100%{
    opacity:.88;
    box-shadow:
      0 12px 46px rgba(0,0,0,.18),
      0 0 34px rgba(0,240,255,.10);
  }
  50%{
    opacity:.98;
    box-shadow:
      0 14px 52px rgba(0,0,0,.14),
      0 0 44px rgba(0,240,255,.14);
  }
}

/* =========================================================
   3) JUDGE
   ========================================================= */

.judge{
  position:absolute;
  left:50%;
  top: calc(50% - 150px);
  transform: translateX(-50%);
  pointer-events:none;
  text-align:center;

  padding: 10px 16px;
  border-radius: 999px;

  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.18);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);

  box-shadow:
    0 12px 38px rgba(0,0,0,.14),
    0 0 30px rgba(0,240,255,.16);

  opacity:0;
  will-change: opacity, transform;
}
.judgeMain{
  font-size: 20px;
  font-weight: 1000;
  letter-spacing: .10em;
  text-shadow:
    0 0 24px rgba(0,240,255,.24),
    0 0 16px rgba(156,60,255,.18);
}
.judgeSub{
  margin-top: 2px;
  font-size: 11px;
  letter-spacing: .22em;
  color: rgba(245,245,242,.84);
}
#judge[aria-hidden="false"]{ opacity:1; }

/* =========================================================
   4) RESULT (light)
   ========================================================= */

.result{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 18px;

  background: rgba(0,0,0,.34);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);

  opacity:0;
  pointer-events:none;
}
.resultCard{
  width: min(520px, 92vw);
  border-radius: var(--r2);
  border: 1px solid rgba(255,255,255,.18);

  background:
    linear-gradient(180deg,
      rgba(255,255,255,.14),
      rgba(255,255,255,.08)
    );

  box-shadow:
    0 22px 70px rgba(0,0,0,.20),
    0 0 40px rgba(0,240,255,.10);

  padding: 18px 18px 16px;
  animation: pop .18s ease both;
}
@keyframes pop{
  from{ transform: translateY(8px) scale(.98); opacity:.0; }
  to  { transform: translateY(0)  scale(1);   opacity:1; }
}
.resultTitle{
  font-weight: 1000;
  letter-spacing: .22em;
  font-size: 14px;
  color: rgba(245,245,242,.78);
}
.resultRow{
  display:flex;
  justify-content:space-between;
  align-items:baseline;
  padding: 10px 0 0;
}
.resultKey{
  color: rgba(245,245,242,.68);
  letter-spacing:.14em;
  font-size: 12px;
}
.resultVal{
  font-weight: 1000;
  font-size: 18px;
}
.resultDivider{
  height:1px;
  background: rgba(255,255,255,.14);
  margin: 14px 0;
}

/* ARU ring */
.aruWrap{ display:flex; flex-direction:column; gap: 10px; align-items:center; }
.aruRing{
  width: 220px;
  height: 220px;
  position:relative;
  display:grid;
  place-items:center;
}
.aruSvg{
  width: 220px;
  height: 220px;
  filter:
    drop-shadow(0 14px 40px rgba(0,0,0,.20))
    drop-shadow(0 0 22px rgba(0,240,255,.12));
}
.aruTrack{
  fill:none;
  stroke: rgba(255,255,255,.14);
  stroke-width: 10;
}
.aruProg{
  fill:none;
  stroke: url(#aruGrad);
  stroke-width: 10;
  stroke-linecap: round;
  stroke-dasharray: 276.46;
  stroke-dashoffset: 276.46;
  transition: stroke-dashoffset .18s ease;
}
.aruText{ position:absolute; text-align:center; }
.aruLabel{
  font-size: 11px;
  letter-spacing: .22em;
  color: rgba(245,245,242,.72);
}
.aruValue{
  margin-top: 4px;
  font-size: 22px;
  font-weight: 1000;
  text-shadow: 0 0 20px rgba(0,240,255,.14);
}
.dicoLine{
  text-align:center;
  max-width: 460px;
  font-size: 13px;
  color: rgba(245,245,242,.92);
}

.app[data-state="result"] #result{ opacity:1; pointer-events:auto; }
.app[data-state="result"] .judge{ opacity:0 !important; }
#result[aria-hidden="false"]{ opacity:1; pointer-events:auto; }

/* =========================================================
   5) Mobile tweaks
   ========================================================= */

@media (max-width: 720px){
  .targetRoot{ width: 160px; height: 160px; }
  .judge{ top: calc(50% - 132px); }
  .aruRing, .aruSvg{ width: 200px; height: 200px; }
}
@media (max-width: 560px){
  .stage::before{ width: min(180px, 56vw); border-radius: 28px; }
  .stage::after { width: min(220px, 62vw); border-radius: 28px; }
}
/* 入力遅延/スクロール介入を完全に潰す */
#hitZone, #stage, #noteCanvas {
  touch-action: none;
  -webkit-user-select: none;
  user-select: none;
}


/* =========================================================
   6) Accessibility
   ========================================================= */

@media (prefers-reduced-motion: reduce){
  .stage::before,
  .stage::after,
  .targetRoot,
  .targetOuter,
  .targetCore,
  .targetRing,
  .scanLine{
    animation: none !important;
  }
}
