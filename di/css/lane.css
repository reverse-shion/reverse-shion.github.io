/* /di/css/lane.css */
/* =========================================================
   DiCo LANE – “Single Lane Master” (FINAL)
   - ONE lane only (no double lane)
   - ::before + ::after same width (glow stays inside)
   - No transform wobble (stable on iOS Safari)
   - Notes(canvas) always on top
   ========================================================= */

/* =========================================================
   0) LAYER FIX (MOST IMPORTANT)
   ========================================================= */

.noteCanvas{
  position: relative;
  z-index: 8;
}

.hitZone{
  position:absolute;
  inset:0;
  z-index: 9;
  pointer-events:none;
}

.targetRoot{ position:absolute; z-index: 10; pointer-events:none; }
.judge{ position:absolute; z-index: 11; pointer-events:none; }
.result{ position:absolute; z-index: 20; }

/* =========================================================
   1) STAGE BASE (must be stable)
   ========================================================= */

/* stage should be the positioning context */
.stage{
  position: relative;
  overflow: hidden;           /* keeps lane effects clean */
  transform: translateZ(0);   /* stable compositor layer */
  will-change: auto;
}

/* =========================================================
   2) SINGLE CENTER LANE (ONE WIDTH ONLY)
   ========================================================= */

:root{
  /* ✅ HERE: the “real lane width” (match notes feel) */
  --laneW: min(190px, 50vw);
  --laneR: 30px;
}

/* Lane body (glass) */
.stage::before{
  content:"";
  position:absolute;
  left:50%;
  top:-14vh;
  bottom:-16vh;
  transform: translateX(-50%);     /* only centering (no animation transform!) */

  width: var(--laneW);
  border-radius: var(--laneR);

  z-index: 2;
  pointer-events:none;

  background:
    linear-gradient(180deg,
      rgba(255,255,255,.10),
      rgba(255,255,255,.035) 44%,
      rgba(255,255,255,.020) 100%
    );

  outline: 1px solid rgba(255,255,255,.11);

  box-shadow:
    inset 2px 0 0 rgba(0,240,255,.58),
    inset -2px 0 0 rgba(156,60,255,.48),
    inset 0 0 44px rgba(0,240,255,.06),
    inset 0 0 72px rgba(156,60,255,.05),
    0 18px 70px rgba(0,0,0,.12),
    0 0 40px rgba(0,240,255,.10);

  /* iOS Safari: heavy blur can shimmer; keep moderate */
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);

  opacity: .78;

  will-change: opacity, filter, box-shadow;
  animation: laneBreatheStable 2.4s ease-in-out infinite;
}

/* Shimmer film (SAME width = no double lane) */
.stage::after{
  content:"";
  position:absolute;
  left:50%;
  top:-14vh;
  bottom:-16vh;
  transform: translateX(-50%);     /* no wobble */

  /* ✅ SAME WIDTH as ::before (IMPORTANT) */
  width: var(--laneW);
  border-radius: var(--laneR);

  z-index: 2;
  pointer-events:none;

  background:
    linear-gradient(115deg,
      rgba(0,0,0,0) 0%,
      rgba(0,240,255,.18) 18%,
      rgba(156,60,255,.14) 46%,
      rgba(230,201,107,.10) 62%,
      rgba(0,0,0,0) 82%
    );

  background-size: 520px 100%;
  background-position: -320px 0;

  /* Safari can “flicker” with strong blend; keep screen but lighter */
  mix-blend-mode: screen;
  opacity: .40;
  filter: blur(.25px);

  will-change: opacity, filter, background-position;
  animation:
    laneShimmer 2.2s linear infinite,
    laneBreatheStable 2.4s ease-in-out infinite;
}

/* Fade top/bottom so lane melts into screen */
.stage::before,
.stage::after{
  -webkit-mask-image: linear-gradient(to bottom, transparent, #000 12%, #000 88%, transparent);
  mask-image: linear-gradient(to bottom, transparent, #000 12%, #000 88%, transparent);
}

/* shimmer slide */
@keyframes laneShimmer{
  0%   { background-position: -320px 0; }
  100% { background-position:  320px 0; }
}

/* ✅ stable breathing (NO transform scale) */
@keyframes laneBreatheStable{
  0%,100%{
    opacity: .74;
    filter: brightness(1.00) saturate(1.08);
    box-shadow:
      inset 2px 0 0 rgba(0,240,255,.55),
      inset -2px 0 0 rgba(156,60,255,.45),
      inset 0 0 44px rgba(0,240,255,.06),
      inset 0 0 78px rgba(156,60,255,.05),
      0 16px 64px rgba(0,0,0,.10),
      0 0 28px rgba(0,240,255,.10);
  }
  50%{
    opacity: .92;
    filter: brightness(1.14) saturate(1.20);
    box-shadow:
      inset 2px 0 0 rgba(0,240,255,.82),
      inset -2px 0 0 rgba(156,60,255,.70),
      inset 0 0 56px rgba(0,240,255,.10),
      inset 0 0 92px rgba(156,60,255,.09),
      0 20px 84px rgba(0,0,0,.08),
      0 0 52px rgba(0,240,255,.18);
  }
}

/* =========================================================
   3) TARGET (synchronized pulse — stable)
   ========================================================= */

.targetRoot{
  left:50%;
  top:50%;
  transform: translate(-50%, -50%); /* fixed centering only */
  width: 178px;
  height: 178px;

  will-change: filter, opacity;
  animation: targetPulseStable 2.4s ease-in-out infinite;
}

.targetOuter, .targetCore, .targetRing{
  position:absolute;
  inset:0;
  border-radius:999px;
}

.targetOuter{
  background:
    radial-gradient(circle at 50% 50%,
      rgba(255,255,255,.07) 0%,
      rgba(255,255,255,.04) 44%,
      rgba(0,0,0,.12) 78%,
      rgba(0,0,0,.18) 100%);
  outline: 1px solid rgba(255,255,255,.14);

  box-shadow:
    0 12px 46px rgba(0,0,0,.18),
    0 0 34px rgba(0,240,255,.10);

  opacity: .94;
}

.targetCore{
  inset: 44px;
  background:
    radial-gradient(circle at 45% 40%,
      rgba(255,255,255,.32),
      rgba(255,255,255,.12) 40%,
      rgba(0,0,0,.08) 78%);
  border: 1px solid rgba(255,255,255,.18);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  opacity: .96;
}

.targetRing{
  inset: 12px;
  border: 2px solid rgba(0,240,255,.34);
  box-shadow:
    0 0 0 1px rgba(156,60,255,.16),
    0 0 24px rgba(0,240,255,.22),
    0 0 34px rgba(156,60,255,.18),
    0 0 26px rgba(230,201,107,.12);
}

@keyframes targetPulseStable{
  0%,100%{
    filter: brightness(1.00) saturate(1.06);
  }
  50%{
    filter: brightness(1.08) saturate(1.14);
  }
}

/* scan line */
.scanLine{
  position:absolute;
  left: 16px;
  right: 16px;
  top: 50%;
  height: 2px;
  transform: translateY(-50%);

  background: linear-gradient(90deg,
    transparent,
    rgba(0,240,255,.95),
    rgba(156,60,255,.70),
    transparent);

  opacity:0;
  filter: blur(.2px);
  animation: scanMove 1.05s ease-in-out infinite;
}
@keyframes scanMove{
  0%,100%{ transform: translateY(-50%) scaleX(.92); }
  50%    { transform: translateY(-50%) scaleX(1.10); }
}
.app[data-state="playing"] .scanLine{ opacity:.92; }

/* Hit boost */
.app.hitActive .stage::before{
  opacity: .98;
  filter: brightness(1.18) saturate(1.24);
}
.app.hitActive .targetRing{
  border-color: rgba(0,240,255,.62);
  box-shadow:
    0 0 0 1px rgba(156,60,255,.28),
    0 0 40px rgba(0,240,255,.34),
    0 0 54px rgba(156,60,255,.24),
    0 0 38px rgba(230,201,107,.18);
}

/* =========================================================
   4) JUDGE / RESULT (keep as you had, stable)
   ========================================================= */

.judge{
  left:50%;
  top: calc(50% - 150px);
  transform: translateX(-50%);
  text-align:center;

  padding: 10px 16px;
  border-radius: 999px;

  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.18);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);

  box-shadow:
    0 12px 38px rgba(0,0,0,.14),
    0 0 30px rgba(0,240,255,.16);

  opacity:0;
}
#judge[aria-hidden="false"]{ opacity:1; }

.result{
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 18px;

  background: rgba(0,0,0,.34);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);

  opacity:0;
  pointer-events:none;
}
.app[data-state="result"] #result{ opacity:1; pointer-events:auto; }
#result[aria-hidden="false"]{ opacity:1; pointer-events:auto; }

/* =========================================================
   5) Mobile tweaks
   ========================================================= */

@media (max-width: 720px){
  .targetRoot{ width: 160px; height: 160px; }
  .judge{ top: calc(50% - 132px); }
}

@media (max-width: 560px){
  :root{ --laneW: min(180px, 56vw); --laneR: 28px; }
}

/* =========================================================
   6) Reduced motion
   ========================================================= */

@media (prefers-reduced-motion: reduce){
  .stage::before,
  .stage::after,
  .targetRoot,
  .scanLine{
    animation: none !important;
  }
}
