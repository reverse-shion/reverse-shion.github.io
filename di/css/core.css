/* /di/css/core.css */
/* STABLE VERSION – tap-safe + state control (idle still) */

*{ box-sizing:border-box; }
html,body{ height:100%; }

body{
  margin:0;
  font-family: var(--font);
  color: var(--text);
  background:#000; /* fallback only */
  overflow:hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* =========================
   App Container
   ========================= */
.app{
  position:relative;
  width:100%;
  height:100%;

  padding:
    env(safe-area-inset-top)
    env(safe-area-inset-right)
    calc(env(safe-area-inset-bottom) + var(--bottomH))
    env(safe-area-inset-left);

  user-select:none;
  -webkit-user-select:none;
  -webkit-tap-highlight-color: transparent;

  overscroll-behavior: none;
  -webkit-overflow-scrolling: auto;
}

/* オーバーレイ無効（あなたの方針を維持） */
.app::before{ display:none; }
.app::after{ display:none; }

/* =========================
   Background Video (pure)
   ========================= */
.bgVideo{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  object-position:center;

  opacity:1;
  filter: brightness(1.25) contrast(1.1) saturate(1.1);

  transform: translateZ(0);
  z-index:0;
  pointer-events:none;
}

/* =========================
   Idle Background (still image / particles base)
   ※ HTMLに <div id="idleBg" class="idleBg"> を足す想定
   ========================= */
.idleBg{
  position:absolute;
  inset:0;
  z-index:1;
  pointer-events:none;

  /* 「静止画＋軽パーティクル」用のベース。
     静止画を使うなら background-image を後で差し替え。 */
  background:
    radial-gradient(circle at 30% 20%, rgba(156,60,255,.22), transparent 45%),
    radial-gradient(circle at 75% 35%, rgba(0,240,255,.18), transparent 50%),
    radial-gradient(circle at 50% 85%, rgba(230,201,107,.10), transparent 55%),
    linear-gradient(180deg, #04050a 0%, #000 60%, #000 100%);
}

/* =========================
   FX layer
   ========================= */
.fxLayer{
  position:absolute;
  inset:0;
  z-index:6;
  pointer-events:none;
}

/* =========================
   Stage
   ========================= */
.stage{
  position:relative;
  z-index:4;

  width:100%;
  height:100%;

  display:flex;
  align-items:center;
  justify-content:center;

  padding:
    10px
    calc(var(--hudW) + var(--hudGap) + env(safe-area-inset-right))
    10px
    calc(var(--hudW) + var(--hudGap) + env(safe-area-inset-left));

  /* ここは “manipulation” より、タップの遅延/ズレを減らすため基本 none */
  touch-action: none;
}

/* =========================
   Gameplay Canvas
   ========================= */
.noteCanvas{
  width: min(720px, 100%);
  height: min(86vh, 900px);
  display:block;

  border-radius: var(--r2);

  /* 透明寄り：動画が見える */
  background: rgba(0,0,0,.05);

  box-shadow: 0 30px 80px rgba(0,0,0,.35);
  outline: 1px solid rgba(255,255,255,.15);

  backdrop-filter: blur(3px);
  -webkit-backdrop-filter: blur(3px);

  transform: translateZ(0);

  /* ✅重要：canvasは絶対にタップを奪わない（入力は hitZone だけ） */
  pointer-events:none;
}

/* =========================
   Bottom Controls
   ========================= */
.bottom{
  position:absolute;
  left:0; right:0;
  bottom:0;

  height: var(--bottomH);
  padding: 10px 14px calc(10px + env(safe-area-inset-bottom)) 14px;

  display:flex;
  gap:10px;
  align-items:center;
  justify-content:center;

  z-index:20;
  background: transparent;
}

.btn{
  appearance:none;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
  color: var(--text);

  border-radius: 999px;
  padding: 12px 16px;
  min-width: 110px;

  font-weight: 700;
  letter-spacing: .02em;

  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);

  cursor:pointer;
  transition: transform .08s ease, background .12s ease, border-color .12s ease;
}
.btn:active{ transform: translateY(1px) scale(.99); }
.btn:hover{ border-color: rgba(255,255,255,.32); }

.btn.primary{
  border-color: rgba(0,240,255,.40);
  background: linear-gradient(
    180deg,
    rgba(0,240,255,.35),
    rgba(156,60,255,.25)
  );
}

/* =========================
   State Control
   ========================= */

/* idle：動画は見せない（静止画＋軽パーティクル側へ） */
.app[data-state="idle"] .bgVideo{ display:none; }
.app[data-state="idle"] .idleBg{ display:block; }

/* playing/paused/result：動画を見せる（idleBgは不要） */
.app[data-state="playing"] .bgVideo,
.app[data-state="paused"]  .bgVideo,
.app[data-state="result"]  .bgVideo{ display:block; }
.app[data-state="playing"] .idleBg,
.app[data-state="paused"]  .idleBg,
.app[data-state="result"]  .idleBg{ display:none; }

/* =========================
   Responsive
   ========================= */
@media (max-width: 860px){
  :root{ --hudW: 210px; }
  .noteCanvas{
    width: min(620px, 100%);
    height: min(84vh, 820px);
  }
}
@media (max-width: 720px){
  :root{ --hudW: 170px; }
}
@media (max-width: 560px){
  :root{ --hudW: 150px; }
  .noteCanvas{
    border-radius: 18px;
    height: min(78vh, 760px);
  }
}
