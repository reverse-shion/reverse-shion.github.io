/* ============================================================
   HUD + FX FINAL GOD EDITION
   - Deterministic layering
   - Viewport-fixed FX layer
   - Resonance color sync via --res-color
   - Heartbeat safe animation
   - MAX divine flash
   - Ring absorption aura
   - iOS safe transforms
============================================================ */

:root{
  --pinkGold: rgba(236,191,152,.95);
  --pinkGoldSoft: rgba(236,191,152,.28);
  --pinkGoldGlow: rgba(236,191,152,.45);

  --res-color: rgba(0,240,255,.9);

  --hudW: 168px;
  --hudGap: 12px;
  --hudPad: 12px;
  --r: 16px;
  --blur: 14px;

  --bottomH: 76px;
}

/* ============================================================
   ROOT
============================================================ */

.app{
  position: relative;
  overflow: hidden;
  isolation: isolate;
}

/* ============================================================
   BACKGROUND
============================================================ */

.bgVideo{
  position:absolute;
  inset:0;
  z-index:0;
  pointer-events:none;
}

.stage{
  position:absolute;
  inset:0;
  z-index:4;
}

/* ============================================================
   FX LAYER (CRITICAL FIX)
   FIXED → viewport coordinate safe
============================================================ */

.fxLayer{
  position: fixed;       /* ★重要：absolute禁止 */
  inset: 0;
  z-index: 5;
  pointer-events: none;
  overflow: hidden;
}

/* ============================================================
   PARTICLE BASE (used by fx.js)
============================================================ */

.fxParticle{
  position:absolute;
  transform: translate(-50%,-50%) scale(.6);
  border-radius:999px;
  pointer-events:none;
  opacity:0;
  will-change: transform, opacity;
  backface-visibility:hidden;
}

/* Burst */
.fxParticle.burstGo{
  opacity:1;
  transform: translate(-50%,-50%) scale(2.4);
  transition: transform .45s ease, opacity .45s ease;
  opacity:0;
}

/* ============================================================
   DIVINE FULL FLASH (MAX)
============================================================ */

.fxFullFlash{
  position:absolute;
  inset:0;
  pointer-events:none;
  opacity:0;
  mix-blend-mode:screen;
}

.fxFullFlash.go{
  animation: divineFlash .6s ease forwards;
}

@keyframes divineFlash{
  0%{ opacity:0; }
  25%{ opacity:.35; }
  100%{ opacity:0; }
}

/* ============================================================
   SIDE HUD
============================================================ */

.sideHud{
  position:absolute;
  top: calc(env(safe-area-inset-top) + 12px);
  bottom: calc(env(safe-area-inset-bottom) + var(--bottomH) + 10px);
  width: var(--hudW);
  display:flex;
  flex-direction:column;
  gap: var(--hudGap);
  z-index: 6;
  pointer-events:none;
}

.sideHudLeft{
  left: calc(env(safe-area-inset-left) + 12px);
}
.sideHudRight{
  right: calc(env(safe-area-inset-right) + 12px);
}

/* ============================================================
   PLAYER CARD
============================================================ */

.sidePlayer{
  padding: 12px;
  overflow: visible;
  padding-right: 18px;
}

/* ============================================================
   AVATAR
============================================================ */

.sideAvatar{
  width: 72px;
  height: 72px;
  position:relative;
  flex:0 0 auto;
  border-radius:999px;
  overflow: visible;
}

/* ============================================================
   RING (GOD VERSION)
============================================================ */

.avatarRing{
  position:absolute;
  inset:-6px;
  border-radius:999px;
  pointer-events:none;

  background:
    radial-gradient(circle at 30% 25%, rgba(255,255,255,.18), transparent 55%),
    conic-gradient(from 0deg,
      transparent,
      var(--res-color),
      rgba(255,255,255,.25),
      var(--res-color),
      transparent
    );

  box-shadow:
    0 0 0 1px rgba(255,255,255,.15),
    0 0 28px var(--res-color),
    0 0 60px var(--res-color);

  mix-blend-mode: screen;
  opacity: .98;
  will-change: transform, box-shadow;
}

/* Inner lens */
.avatarRing::after{
  content:"";
  position:absolute;
  inset:2px;
  border-radius:999px;
  background:
    radial-gradient(circle at 50% 35%, rgba(0,0,0,0), rgba(0,0,0,.45));
  border:1px solid rgba(255,255,255,.16);
}

/* ============================================================
   RING ABSORPTION AURA (神吸収演出)
============================================================ */

.avatarRing.absorbPulse{
  animation: absorbGlow .6s ease-out forwards;
}

@keyframes absorbGlow{
  0%{
    box-shadow:
      0 0 0 1px rgba(255,255,255,.15),
      0 0 28px var(--res-color);
  }
  40%{
    box-shadow:
      0 0 0 1px rgba(255,255,255,.15),
      0 0 60px var(--res-color),
      0 0 120px var(--res-color);
  }
  100%{
    box-shadow:
      0 0 0 1px rgba(255,255,255,.15),
      0 0 28px var(--res-color);
  }
}

/* ============================================================
   HEARTBEAT (SAFE VERSION)
============================================================ */

.isHeartbeat .avatarRing{
  animation: heartbeat .65s ease-in-out infinite;
}

@keyframes heartbeat{
  0%{ transform: scale(1); }
  50%{ transform: scale(1.045); }
  100%{ transform: scale(1); }
}

/* ============================================================
   FACE
============================================================ */

.dicoFace{
  position:absolute;
  left:50%;
  top:50%;
  width:82px;
  height:82px;
  transform: translate(-50%,-50%);
  object-fit:cover;
  border-radius:999px;

  filter: brightness(1.10) contrast(1.05) saturate(1.06);

  outline:1px solid rgba(255,255,255,.20);
  box-shadow:0 10px 22px rgba(0,0,0,.35);

  backface-visibility:hidden;
}

.dicoFace.isSwap{
  transform: translate(-50%,-50%) scale(1.04);
  transition: transform .12s ease;
}

/* ============================================================
   RES TIER COLOR SYNC
============================================================ */

.app[data-res-tier="0"]{ --res-color: rgba(0,240,255,.9); }
.app[data-res-tier="1"]{ --res-color: rgba(156,60,255,.9); }
.app[data-res-tier="2"]{ --res-color: rgba(236,191,152,.95); }

/* ============================================================
   RESPONSIVE
============================================================ */

@media (max-width: 720px){
  :root{ --hudW: 160px; }
  .sideAvatar{ width: 66px; height:66px; }
  .dicoFace{ width: 76px; height:76px; }
}
