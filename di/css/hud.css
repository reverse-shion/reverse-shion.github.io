/* /di/css/hud.css
   ============================================================
   HUD — PRO FINAL (LIGHTWEIGHT + DETERMINISTIC)
   - iOS-safe deterministic stacking (isolation + fixed z map)
   - HARD state visibility guarantees (idle/playing/result/paused)
   - Side HUD glass cards
   - DiCo avatar: base ring + face + skin overlay (skin is FRONT of face)
   - Lightweight: avoid expensive blend on large areas, keep effects local
   ============================================================ */

:root{
  /* (themes.cssがあるなら上書きされない想定でもOK) */
  --pinkGold: rgba(236,191,152,.95);
  --pinkGoldSoft: rgba(236,191,152,.26);
  --pinkGoldGlow: rgba(236,191,152,.38);

  --hudW: 168px;
  --hudGap: 12px;
  --hudPad: 12px;
  --r: 16px;
  --blur: 14px;

  --bottomH: 76px;

  /* Avatar tuning */
  --av-size: 68px;           /* container size */
  --face-size: 78px;         /* face image size */
  --ring-inset: 12px;        /* base ring breathing */
  --skin-inset: 14px;        /* skin overlay breathing */
  --av-outline: rgba(255,255,255,.18);

  /* “反射”を入れて浮きを抑える（0..1） */
  --res-k: 0;
}

/* ------------------------------------------------------------
   0) ROOT LAYERING (deterministic)
   ------------------------------------------------------------ */

.app{
  position: relative;
  overflow: hidden;
  isolation: isolate;
}

/* Base video */
.bgVideo{
  position:absolute;
  inset:0;
  z-index: 0;
  pointer-events:none;
}

/* IDLE STACK */
.idleBg{
  position:absolute;
  inset:0;
  z-index: 1;
  pointer-events:none;
}

.idleBg .idleImg{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit: cover;
  z-index: 1;
  pointer-events:none;
}

#idleParticles.idleParticles{
  position:absolute;
  inset:0;
  z-index: 2;
  pointer-events:none;
  mix-blend-mode: screen;
  opacity: .85;
}

/* idle tagline */
.idleLine{
  position:absolute;
  left: 16px;
  right: 16px;
  bottom: calc(env(safe-area-inset-bottom) + var(--bottomH) + 16px);
  z-index: 3;
  pointer-events:none;
}

/* Stage */
.stage{
  position:absolute;
  inset:0;
  z-index: 4;
}

/* FX above stage */
.fxLayer{
  position:absolute;
  inset:0;
  z-index: 5;
  pointer-events:none;
}

/* Side HUD */
.sideHud{
  position:absolute;
  top: calc(env(safe-area-inset-top) + 12px);
  bottom: calc(env(safe-area-inset-bottom) + var(--bottomH) + 10px);
  width: var(--hudW);
  display:flex;
  flex-direction:column;
  gap: var(--hudGap);
  z-index: 6;
  pointer-events:none;
}

.sideHudLeft{
  left: calc(env(safe-area-inset-left) + 12px);
  align-items:stretch;
}
.sideHudRight{
  right: calc(env(safe-area-inset-right) + 12px);
  align-items:stretch;
}

/* Bottom controls */
.bottom{
  position:absolute;
  left:0;
  right:0;
  bottom: calc(env(safe-area-inset-bottom) + 10px);
  z-index: 7;

  display:flex;
  gap: 12px;
  justify-content:center;
  align-items:center;
  padding: 0 14px;
}

/* ------------------------------------------------------------
   1) STATE VISIBILITY (HARD GUARANTEE)
   ------------------------------------------------------------ */

.app[data-state="idle"] .stage{
  opacity:0;
  visibility:hidden;
  pointer-events:none;
}
.app[data-state="idle"] .bgVideo{
  opacity:0;
  visibility:hidden;
}

.app[data-state="playing"] .idleBg,
.app[data-state="result"]  .idleBg,
.app[data-state="paused"]  .idleBg{
  opacity:0;
  visibility:hidden;
  pointer-events:none;
}

.app[data-state="playing"] .idleLine,
.app[data-state="result"]  .idleLine,
.app[data-state="paused"]  .idleLine{
  opacity:0;
  visibility:hidden;
}

.app[data-state="paused"] .stage{
  opacity:1;
  visibility:visible;
  pointer-events:auto;
}

/* ------------------------------------------------------------
   2) CONTROLS VISIBILITY (HARD GUARANTEE)
   ------------------------------------------------------------ */

#stopBtn,
#restartBtn{ display:none; }

.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  line-height: 1;
  white-space:nowrap;
  user-select:none;
  -webkit-tap-highlight-color: transparent;
}

/* idle */
.app[data-state="idle"] #startBtn{ display:inline-flex; }
.app[data-state="idle"] #stopBtn,
.app[data-state="idle"] #restartBtn{ display:none; }

/* playing */
.app[data-state="playing"] #startBtn{ display:none; }
.app[data-state="playing"] #stopBtn,
.app[data-state="playing"] #restartBtn{ display:inline-flex; }

/* result */
.app[data-state="result"] #startBtn,
.app[data-state="result"] #stopBtn{ display:none; }
.app[data-state="result"] #restartBtn{ display:inline-flex; }

/* paused */
.app[data-state="paused"] #startBtn{ display:inline-flex; }
.app[data-state="paused"] #stopBtn{ display:none; }
.app[data-state="paused"] #restartBtn{ display:inline-flex; }

/* ------------------------------------------------------------
   3) START BUTTON (idle emphasis)
   ------------------------------------------------------------ */

.app[data-state="idle"] #startBtn{
  min-width: 210px;
  height: 58px;
  padding: 0 22px;
  border-radius: 999px;

  font-size: 16px;
  font-weight: 900;
  letter-spacing: .12em;

  border: 1px solid rgba(0,240,255,.38);
  background:
    radial-gradient(120% 160% at 30% 10%, rgba(0,240,255,.35), transparent 52%),
    linear-gradient(180deg, rgba(0,240,255,.24), rgba(156,60,255,.20));
  box-shadow:
    0 18px 50px rgba(0,0,0,.45),
    0 0 0 1px rgba(255,255,255,.10),
    0 0 26px rgba(0,240,255,.14);
}

@media (max-width: 420px){
  .app[data-state="idle"] #startBtn{
    min-width: 224px;
    height: 60px;
  }
}

/* ------------------------------------------------------------
   4) IDLE TAGLINE — neon glass
   ------------------------------------------------------------ */

.idleLine{
  padding: 12px 14px 12px 20px;
  border-radius: 14px;

  font-weight: 900;
  letter-spacing: .06em;
  line-height: 1.25;

  color: rgba(245,245,242,.92);
  background: rgba(10,14,22,.38);
  border: 1px solid rgba(255,255,255,.16);

  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);

  box-shadow:
    0 16px 42px rgba(0,0,0,.40),
    0 0 0 1px rgba(0,240,255,.10),
    0 0 28px rgba(0,240,255,.12);

  text-shadow:
    0 10px 30px rgba(0,0,0,.55),
    0 0 18px rgba(0,240,255,.16);
}

.idleLine::before{
  content:"";
  position:absolute;
  left: 10px;
  top: 10px;
  bottom: 10px;
  width: 3px;
  border-radius: 99px;
  background: linear-gradient(180deg,
    rgba(0,240,255,.95),
    rgba(156,60,255,.75),
    rgba(230,201,107,.70)
  );
  box-shadow: 0 0 18px rgba(0,240,255,.20);
}

/* ------------------------------------------------------------
   5) SIDE HUD CARDS (stable glass)
   ------------------------------------------------------------ */

.sideCard{
  pointer-events:none;
  border-radius: var(--r);
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 16px 42px rgba(0,0,0,.35);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  padding: var(--hudPad);
  position:relative;
  overflow:hidden;
}

.sideCard::before{
  content:"";
  position:absolute;
  inset:-1px;
  background:
    radial-gradient(420px 160px at 10% 0%, rgba(0,240,255,.14), transparent 55%),
    radial-gradient(420px 160px at 90% 20%, rgba(156,60,255,.12), transparent 58%),
    radial-gradient(420px 160px at 60% 100%, rgba(230,201,107,.10), transparent 60%);
  opacity:.85;
  pointer-events:none;
}

/* Score card */
.sideScore{ padding-top: 14px; }
.sideScoreValue{
  position:relative;
  font-size: 32px;
  font-weight: 900;
  letter-spacing: .06em;
  text-shadow: 0 0 18px rgba(0,240,255,.18);
}
.sideScoreSub{
  position:relative;
  margin-top: 6px;
  font-size: 12px;
  letter-spacing: .14em;
  color: rgba(245,245,242,.68);
}

/* Combo card */
.sideComboValue{
  position:relative;
  font-size: 30px;
  font-weight: 900;
  letter-spacing: .04em;
}
.sideComboLabel{
  position:relative;
  margin-top: 2px;
  font-size: 12px;
  letter-spacing: .18em;
  color: rgba(245,245,242,.68);
}
.sideComboMeta{
  position:relative;
  display:flex;
  gap:8px;
  align-items:baseline;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid rgba(255,255,255,.10);
}
.metaLabel{
  font-size: 11px;
  letter-spacing: .18em;
  color: rgba(245,245,242,.52);
}
.metaValue{
  font-size: 14px;
  font-weight: 800;
  color: rgba(245,245,242,.92);
}

/* ------------------------------------------------------------
   6) PLAYER CARD + DiCo AVATAR (LIGHT, FRONT-SKIN)
   ------------------------------------------------------------ */

.sidePlayer{
  padding: 12px;
  overflow: visible;
  padding-right: 18px;
}

.sideTop{
  position:relative;
  display:flex;
  gap: 12px;
  align-items:center;
  justify-content:space-between;
  margin-bottom: 10px;
}

.sideNameMain{
  font-weight: 900;
  letter-spacing: .02em;
  font-size: 20px;
  line-height: 1.1;
}
.sideNameSub{
  margin-top: 2px;
  font-size: 11px;
  letter-spacing: .20em;
  color: rgba(245,245,242,.68);
}

/* Avatar container */
.sideAvatar{
  width: var(--av-size);
  height: var(--av-size);
  position:relative;
  flex: 0 0 auto;
  border-radius: 999px;
  overflow: visible;
}

/* --- LAYER MAP (deterministic) ---
   0: base ring (#avatarRing)
   1: face (.dicoFace)
   2: skin overlay (#avatarRingSkin)  ← faceの前に出す
*/
#avatarRing{ position:absolute; inset: calc(var(--ring-inset) * -1); border-radius:999px; z-index:0; pointer-events:none; 
          /* ✅ JSが回転値を渡す。デフォは0 */
--ui-rot: 0deg;

/* ✅ transformはここで一本化（JSでtransform直書きしない） */
transform: rotate(var(--ui-rot)) translateZ(0);

will-change: transform, filter, opacity;
           }
.sideAvatar .dicoFace{ position:absolute; left:50%; top:50%; width: var(--face-size); height: var(--face-size);
  transform: translate(-50%,-50%) scale(var(--pulseScale, 1)) translateZ(0);
  border-radius:999px; object-fit:cover; z-index:1; pointer-events:none;
}
#avatarRingSkin{ position:absolute; inset: calc(var(--skin-inset) * -1); border-radius:999px; z-index:2; pointer-events:none; }

/* Base ring (pink-gold glass) */
#avatarRing{
  background:
    radial-gradient(circle at 30% 25%, rgba(255,255,255,.16), rgba(255,255,255,0) 55%),
    conic-gradient(from 0deg,
      rgba(236,191,152,.10),
      rgba(236,191,152,.62),
      rgba(255,255,255,.18),
      rgba(236,191,152,.62),
      rgba(236,191,152,.10)
    );
  box-shadow:
    0 0 0 1px rgba(255,255,255,.14),
    0 0 0 2px var(--pinkGoldSoft) inset,
    0 0 28px var(--pinkGoldGlow),
    0 12px 26px rgba(0,0,0,.28);
  opacity: .98;

  /* 局所だけ blend：大面積にしない */
  mix-blend-mode: screen;
}

/* inner lens (base ring) */
#avatarRing::after{
  content:"";
  position:absolute;
  inset: 0;
  border-radius:999px;
  background: radial-gradient(circle at 50% 35%, rgba(0,0,0,0), rgba(0,0,0,.42));
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: inset 0 0 18px rgba(0,0,0,.26);
}

/* Face tuning (lightweight “reflection”, avoids floating look) */
.sideAvatar .dicoFace{
  outline: 1px solid var(--av-outline);
  box-shadow: 0 10px 22px rgba(0,0,0,.35);
  backface-visibility:hidden;

  /* 反射：リングが光ってるほど顔が少しだけ乗る */
  filter:
    brightness(calc(1.08 + 0.10*var(--res-k)))
    contrast(1.05)
    saturate(calc(1.06 + 0.06*var(--res-k)));
}

/* swap micro-pop (ui.js adds .isSwap) */
.sideAvatar .dicoFace.isSwap{
  transform: translate(-50%,-50%) scale(1.03) translateZ(0);
  transition: transform .12s ease;
}

/* Skin overlay: FRONT of face (cheap) */
#avatarRingSkin{
  opacity: .92;

  /* “模様が前に乗ってる”感：薄く、軽く、上品 */
  filter: brightness(1.06) saturate(1.04);
  /* iOSでも軽い：ここでは影を増やさない */
}

/* ------------------------------------------------------------
   7) Resonance gauge (right card)
   ------------------------------------------------------------ */

.sideGauge{
  position:relative;
  padding-top: 6px;
}

.sideGaugeRow, .sideTimeRow{
  position:relative;
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:10px;
}

.sideGaugeLabel, .sideTimeLabel{
  font-size: 11px;
  letter-spacing: .20em;
  color: rgba(245,245,242,.68);
}
.sideGaugeValue, .sideTimeValue{
  font-size: 14px;
  font-weight: 900;
  letter-spacing: .02em;
}
.sideGaugeValue .pct{ opacity:.70; font-weight:800; margin-left:2px; }

.sideGaugeBar{
  position:relative;
  height: 10px;
  border-radius: 999px;
  margin-top: 8px;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.10);
  overflow:hidden;
}
.sideGaugeFill{
  position:absolute;
  inset:0;
  width: 0%;
  border-radius: 999px;
  background: linear-gradient(90deg,
    rgba(0,240,255,.90),
    rgba(156,60,255,.75),
    rgba(236,191,152,.82)
  );
  box-shadow: 0 0 20px rgba(0,240,255,.18);
  transition: width .12s ease;
}

/* legacy dup hidden */
#time_dup{ display:none; }
.facePool{ display:none; }

/* ------------------------------------------------------------
   8) Responsive tuning
   ------------------------------------------------------------ */

@media (max-width: 720px){
  :root{
    --hudW: 162px;
    --av-size: 64px;
    --face-size: 74px;
  }
  .sideScoreValue{ font-size: 28px; }
  .sideComboValue{ font-size: 26px; }
}

