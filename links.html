<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>TAROT BREAKER / 時間記録殿（Chronologium）</title>

<style>
:root{
  color-scheme: dark;
  --bg:#05070d;
  --glass:rgba(10,16,28,.55);
  --glass-strong:rgba(6,10,20,.78);
  --line:rgba(120,220,255,.35);
  --cyan:#7fe6ff;
  --violet:#c6a6ff;
  --amber:#ffe0a6;
  --muted:rgba(230,240,255,.7);
  --shadow:0 24px 60px rgba(0,0,0,.45);

  /* Safe area */
  --sat: env(safe-area-inset-top);
  --sab: env(safe-area-inset-bottom);

  /* JSで上書きされる。未対応環境の保険 */
  --vh: 1vh;

  /* 基本余白 */
  --pad-top: 120px;
  --pad-bottom: 140px;
}

*{ box-sizing:border-box; }

html,body{
  margin:0;
  padding:0;
  font-family:"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
  background:var(--bg);
  color:#edf7ff;
}

body{
  /* iOS系のvh揺れ対策：innerHeight基準（--vh）で固定 */
  min-height: calc(var(--vh) * 100);
  overflow-x:hidden;

  background-image:url("assets/chronologium.png");
  background-size:cover;
  background-position:center;
  background-attachment:fixed;
}

/* iOS/モバイルでfixed背景は不安定なので無効化 */
@media (max-width: 820px){
  body{ background-attachment:scroll; }
}

/* オーバーレイ表示中のスクロールロック用 */
body.is-locked{
  overflow:hidden !important;
  touch-action:none;
}

body::before,body::after{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:0;
}

body::before{
  background:
    linear-gradient(180deg, rgba(5,6,12,.48) 0%, rgba(6,8,16,.25) 40%, rgba(4,6,10,.50) 100%);
}

body::after{
  background-image:
    repeating-linear-gradient(0deg, rgba(255,255,255,.04), rgba(255,255,255,.04) 1px, transparent 1px, transparent 4px),
    radial-gradient(circle at 20% 20%, rgba(125,220,255,.10), transparent 40%),
    radial-gradient(circle at 80% 15%, rgba(205,170,255,.08), transparent 45%),
    radial-gradient(circle at 40% 80%, rgba(255,220,150,.05), transparent 50%);
  opacity:.6;
  mix-blend-mode:screen;
}

main{
  position:relative;
  z-index:1;

  /* safe-area吸収：上も下も必ず足す */
  padding:
    calc(var(--pad-top) + var(--sat))
    6vw
    calc(var(--pad-bottom) + var(--sab));

  display:flex;
  flex-direction:column;
  gap:36px;
}

/* 画面が狭い時の微調整（親指導線を守る） */
@media (max-width: 820px){
  main{
    padding-top: calc(100px + var(--sat));
    padding-bottom: calc(160px + var(--sab));
  }
}

header,.panel{
  width:min(1100px, 100%);
  margin:0 auto;

  background:var(--glass);
  border-radius:26px;
  border:1px solid rgba(120,220,255,.2);
  box-shadow:var(--shadow);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);

  padding:32px;
  position:relative;
  overflow:hidden;
}

header::before,
.panel::before{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(135deg, rgba(120,220,255,.10), rgba(198,166,255,.08), transparent 60%);
  opacity:.8;
  pointer-events:none;
}

header > *, .panel > *{
  position:relative;
  z-index:1;
}

header h1{
  margin:0 0 10px;
  color:var(--cyan);
  letter-spacing:.12em;
  text-shadow:0 0 20px rgba(120,220,255,.20);
}

header p{
  margin:0;
  color:var(--muted);
  letter-spacing:.10em;
  line-height:1.7;
}

.latest{
  display:grid;
  grid-template-columns:minmax(0,1fr) auto;
  gap:24px;
  align-items:start;
}

@media(max-width:820px){
  .latest{ grid-template-columns:1fr; }
}

.latest h2{
  margin:0 0 12px;
  color:var(--amber);
  letter-spacing:.20em;
  font-size:1.1rem;
}

#latestPreview{
  margin:0;
  background:rgba(6,10,20,.74);
  border:1px solid rgba(120,220,255,.25);
  border-radius:18px;
  padding:18px 20px;
  line-height:1.75;
  position:relative;
  overflow:hidden;
  white-space:pre-wrap;
  word-break:break-word;
}

/* scanline：動きは軽く、reduce-motionで停止 */
#latestPreview::after{
  content:"";
  position:absolute;
  inset:-10%;
  pointer-events:none;
  mix-blend-mode:screen;
  opacity:.32;
  background:
    repeating-linear-gradient(
      180deg,
      rgba(255,255,255,.06) 0px,
      rgba(255,255,255,.06) 1px,
      transparent 4px,
      transparent 6px
    );
  animation:scan 7s linear infinite;
}

@keyframes scan{
  from{ transform: translateY(-6%); }
  to  { transform: translateY( 6%); }
}

@media(prefers-reduced-motion:reduce){
  #latestPreview::after{ animation:none; }
}

/* 失敗表示 */
#latestPreview[data-error="true"]{
  color:#ffb1b1;
  border-color:rgba(255,120,120,.35);
}

/* アクション */
.actions{
  display:flex;
  flex-direction:column;
  gap:14px;
  align-items:stretch;
}

@media (max-width: 820px){
  .actions{
    flex-direction:row;
    flex-wrap:wrap;
  }
  .actions .btn{
    flex:1 1 160px;
  }
}

.btn{
  display:inline-flex;
  justify-content:center;
  align-items:center;
  gap:10px;

  text-decoration:none;
  text-align:center;
  padding:12px 18px;

  border-radius:14px;
  border:1px solid rgba(120,220,255,.45);
  color:#eef7ff;

  letter-spacing:.18em;
  text-transform:uppercase;

  background:linear-gradient(135deg, rgba(24,44,76,.90), rgba(14,22,40,.96));
  box-shadow:0 12px 30px rgba(0,0,0,.35);

  transition: transform .2s ease, box-shadow .2s ease;
}

.btn:hover,
.btn:focus-visible{
  transform:translateY(-2px);
  box-shadow:0 18px 40px rgba(75,190,255,.20);
  outline:none;
}

.btn.secondary{
  border-color:rgba(198,166,255,.45);
  color:var(--violet);
}

/* ログ帯 */
.log-band{
  padding:18px;
  padding-bottom: calc(18px + var(--sab)); /* 下の食い込み防止 */
  background:rgba(6,10,20,.65);
  border-radius:22px;
  border:1px solid rgba(120,220,255,.18);
  overflow:hidden;
}

.log-track{
  display:flex;
  gap:18px;
  align-items:center;
  width:max-content;
  animation:marquee 36s linear infinite;
}

@keyframes marquee{
  from{ transform: translateX(0); }
  to  { transform: translateX(-50%); }
}

@media(prefers-reduced-motion:reduce){
  .log-track{ animation:none; }
}

.log-item a{
  display:inline-flex;
  align-items:center;
  justify-content:center;

  color:var(--cyan);
  text-decoration:none;

  border:1px solid rgba(120,220,255,.25);
  padding:8px 12px;
  border-radius:999px;

  letter-spacing:.16em;
}

/* オーバーレイ */
.overlay{
  position:fixed;
  inset:0;
  z-index:10;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(3,6,12,.88);
  transition: opacity .35s ease, visibility .35s ease;
}

.overlay.hidden{
  opacity:0;
  visibility:hidden;
}

.boot-panel{
  width:min(620px, 90vw);
  background:var(--glass-strong);
  padding:28px 30px;
  border-radius:20px;
  border:1px solid rgba(120,220,255,.30);
  box-shadow:var(--shadow);
  letter-spacing:.18em;
  color:var(--muted);
  text-transform:uppercase;

  display:flex;
  flex-direction:column;
  gap:12px;
}

.boot-actions{
  display:flex;
  justify-content:flex-end;
}

.skip-button{
  border:1px solid rgba(198,166,255,.55);
  background:transparent;
  color:var(--violet);
  padding:8px 16px;
  border-radius:999px;
  cursor:pointer;
  letter-spacing:.2em;
}

.skip-button:focus-visible{
  outline:2px solid rgba(198,166,255,.6);
  outline-offset:2px;
}
</style>
</head>

<body>
  <div class="overlay" id="bootOverlay" role="dialog" aria-modal="true" aria-label="Chronologium boot">
    <div class="boot-panel">
      <div class="boot-line"></div>
      <div class="boot-line"></div>
      <div class="boot-line"></div>
      <div class="boot-line"></div>
      <div class="boot-line"></div>
      <div class="boot-actions">
        <button class="skip-button" type="button" id="skipBoot" aria-label="skip boot">SKIP</button>
      </div>
    </div>
  </div>

  <main>
    <header>
      <h1>時間記録殿（Chronologium）</h1>
      <p>これはリンク集ではない。<br>記録と不可逆を観測する装置である。</p>
    </header>

    <section class="panel latest" aria-labelledby="latest-title">
      <div>
        <h2 id="latest-title">最新話ログ</h2>
        <pre id="latestPreview" aria-live="polite">&gt; LOADING LOG...</pre>
      </div>
      <div class="actions">
        <a class="btn" href="https://ncode.syosetu.com/n8578lq/12/" target="_blank" rel="noopener noreferrer">▶ 再生</a>
        <a class="btn secondary" href="star-memory.html">STAR MEMORY</a>
      </div>
    </section>

    <section class="panel log-band" aria-label="流れるログ帯（タップで停止/再開）">
      <div class="log-track" role="list">
        <!-- 2周ぶん並べると「-50%」で途切れない -->
        <div class="log-item" role="listitem"><a href="https://ncode.syosetu.com/n8578lq/" target="_blank" rel="noopener noreferrer">NAROU</a></div>
        <div class="log-item" role="listitem"><a href="https://kakuyomu.jp/works/822139843408910379" target="_blank" rel="noopener noreferrer">KAKUYOMU</a></div>
        <div class="log-item" role="listitem"><a href="https://note.com/shion_uranai369" target="_blank" rel="noopener noreferrer">NOTE</a></div>
        <div class="log-item" role="listitem"><a href="https://x.com/TaroBure" target="_blank" rel="noopener noreferrer">X</a></div>
        <div class="log-item" role="listitem"><a href="https://www.instagram.com/shionverse_official" target="_blank" rel="noopener noreferrer">INSTAGRAM</a></div>

        <div class="log-item" role="listitem"><a href="https://ncode.syosetu.com/n8578lq/" target="_blank" rel="noopener noreferrer">NAROU</a></div>
        <div class="log-item" role="listitem"><a href="https://kakuyomu.jp/works/822139843408910379" target="_blank" rel="noopener noreferrer">KAKUYOMU</a></div>
        <div class="log-item" role="listitem"><a href="https://note.com/shion_uranai369" target="_blank" rel="noopener noreferrer">NOTE</a></div>
        <div class="log-item" role="listitem"><a href="https://x.com/TaroBure" target="_blank" rel="noopener noreferrer">X</a></div>
        <div class="log-item" role="listitem"><a href="https://www.instagram.com/shionverse_official" target="_blank" rel="noopener noreferrer">INSTAGRAM</a></div>
      </div>
    </section>
  </main>

<script>
/* =========================
   1) iOS/Chrome(iOS)ズレ対策：
      実測のinnerHeightをCSS変数に反映
========================= */
function setVH(){
  // 1vh = innerHeight * 0.01
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
setVH();

// iOSはアドレスバーの伸縮で頻繁に変わるので、resize + orientation + pageshow を拾う
window.addEventListener('resize', setVH, { passive:true });
window.addEventListener('orientationchange', setVH, { passive:true });
window.addEventListener('pageshow', setVH, { passive:true });

/* =========================
   2) BOOT（表示中スクロールロック）
========================= */
const overlay = document.getElementById("bootOverlay");
const skipButton = document.getElementById("skipBoot");
const bootLines = document.querySelectorAll(".boot-line");

// 日替わりログ
const seed = new Date().getDate();
const bootText = [
  "> CHRONOLOGIUM // BOOT",
  "> LINK : STAR MEMORY",
  "> NAME / REPLY / IRREVERSIBLE",
  seed % 2 ? "> SYNC ... DELTA" : "> SYNC ... STABLE",
  "> ACCESS GRANTED"
];
bootLines.forEach((l,i)=> l.textContent = bootText[i] ?? "");

// 1日1回の起動演出（必要ならOFF可）
const today = new Date();
const todayKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;
const storageKey = "chronologium-boot";
const shouldShow = localStorage.getItem(storageKey) !== todayKey;

function lockScroll(lock){
  document.body.classList.toggle("is-locked", lock);
}

function hideOverlay(){
  overlay.classList.add("hidden");
  overlay.setAttribute("aria-hidden","true");
  lockScroll(false);
  localStorage.setItem(storageKey, todayKey);
}

if (shouldShow){
  lockScroll(true);

  const timer = window.setTimeout(hideOverlay, 1800);

  overlay.addEventListener("click", () => {
    window.clearTimeout(timer);
    hideOverlay();
  });

  skipButton.addEventListener("click", (e) => {
    e.stopPropagation();
    window.clearTimeout(timer);
    hideOverlay();
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape"){
      window.clearTimeout(timer);
      hideOverlay();
    }
  });
}else{
  overlay.classList.add("hidden");
  overlay.setAttribute("aria-hidden","true");
  lockScroll(false);
}

/* =========================
   3) latest.txt（タイピング＋空/失敗対応）
========================= */
const preview = document.getElementById("latestPreview");
let typingTimer = null;
let typingAbort = null;

function setLoading(){
  preview.textContent = "> LOADING LOG...\n> PARSING...";
  preview.removeAttribute("data-error");
}

function setError(message){
  preview.textContent = message;
  preview.setAttribute("data-error", "true");
}

function typeText(text, speed = 16){
  if (typingTimer) window.clearInterval(typingTimer);
  if (typingAbort) typingAbort.aborted = true;

  const abort = { aborted:false };
  typingAbort = abort;

  preview.textContent = "";
  let i = 0;

  typingTimer = window.setInterval(() => {
    if (abort.aborted){
      window.clearInterval(typingTimer);
      typingTimer = null;
      return;
    }
    preview.textContent += text[i] ?? "";
    i++;
    if (i >= text.length){
      window.clearInterval(typingTimer);
      typingTimer = null;
    }
  }, speed);
}

async function loadLatest(){
  try{
    setLoading();
    const res = await fetch("./latest.txt", { cache:"no-store" });
    if (!res.ok) throw new Error("HTTP_NOT_OK");

    const raw = await res.text();
    const text = raw.trim();

    if (!text){
      setError("> ERROR: LOG_EMPTY\n> STATUS: NO_CONTENT");
      return;
    }
    typeText(text, 16);
  }catch{
    setError("> ERROR: LOG_FETCH_FAILED\n> STATUS: UNAVAILABLE");
  }
}
loadLatest();

/* =========================
   4) ログ帯：タップで停止/再開
========================= */
const band = document.querySelector(".log-band");
const track = document.querySelector(".log-track");
let paused = false;

band.addEventListener("click", () => {
  paused = !paused;
  track.style.animationPlayState = paused ? "paused" : "running";
});
</script>
</body>
</html>
