<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>TAROT BREAKER / 時間記録殿（Chronologium）</title>

<style>
:root{
  color-scheme: dark;
  --bg:#05070d;
  --glass:rgba(10,16,28,.55);
  --glass-strong:rgba(6,10,20,.78);
  --line:rgba(120,220,255,.35);
  --cyan:#7fe6ff;
  --violet:#c6a6ff;
  --amber:#ffe0a6;
  --muted:rgba(230,240,255,.7);
  --shadow:0 24px 60px rgba(0,0,0,.45);

  --sat: env(safe-area-inset-top);
  --sab: env(safe-area-inset-bottom);

  --vh: 1vh;
  --pad-top: 120px;
  --pad-bottom: 140px;

  /* ロール速度（秒） */
  --roll-speed: 90s; /* ★変更：体感を少し遅く */
}

*{ box-sizing:border-box; }

html,body{
  margin:0;
  padding:0;
  font-family:"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
  background:var(--bg);
  color:#edf7ff;
}

body{
  min-height: calc(var(--vh) * 100);
  overflow-x:hidden;

  background-image:url("assets/chronologium.png");
  background-size:cover;
  background-position:center;
  background-attachment:fixed;
}

@media (max-width: 820px){
  body{ background-attachment:scroll; }
}

body.is-locked{
  overflow:hidden !important;
  touch-action:none;
}

body::before,body::after{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:0;
}

body::before{
  background:
    linear-gradient(180deg, rgba(5,6,12,.48) 0%, rgba(6,8,16,.25) 40%, rgba(4,6,10,.50) 100%);
}

body::after{
  background-image:
    repeating-linear-gradient(0deg, rgba(255,255,255,.04), rgba(255,255,255,.04) 1px, transparent 1px, transparent 4px),
    radial-gradient(circle at 20% 20%, rgba(125,220,255,.10), transparent 40%),
    radial-gradient(circle at 80% 15%, rgba(205,170,255,.08), transparent 45%),
    radial-gradient(circle at 40% 80%, rgba(255,220,150,.05), transparent 50%);
  opacity:.6;
  mix-blend-mode:screen;
}

main{
  position:relative;
  z-index:1;
  padding:
    calc(var(--pad-top) + var(--sat))
    6vw
    calc(var(--pad-bottom) + var(--sab));
  display:flex;
  flex-direction:column;
  gap:36px;
}

@media (max-width: 820px){
  main{
    padding-top: calc(100px + var(--sat));
    padding-bottom: calc(160px + var(--sab));
  }
}

header,.panel{
  width:min(1100px, 100%);
  margin:0 auto;

  background:var(--glass);
  border-radius:26px;
  border:1px solid rgba(120,220,255,.2);
  box-shadow:var(--shadow);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);

  padding:32px;
  position:relative;
  overflow:hidden;
}

header::before,
.panel::before{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(135deg, rgba(120,220,255,.10), rgba(198,166,255,.08), transparent 60%);
  opacity:.8;
  pointer-events:none;
}

header > *, .panel > *{
  position:relative;
  z-index:1;
}

/* ★変更：タイトルはみ出し防止のため2段タイトル対応 */
header h1{
  margin:0 0 10px;
  color:var(--cyan);
  letter-spacing:.12em;
  text-shadow:0 0 20px rgba(120,220,255,.20);
}

/* ★追加：2段タイトルのスタイル（収まる／折り返す） */
.title{
  margin:0 0 10px;
  color:var(--cyan);
  letter-spacing:.10em;
  text-shadow:0 0 20px rgba(120,220,255,.20);
  max-width:100%;
  overflow-wrap:anywhere;
}
.title-ja{
  display:block;
  font-size:clamp(1.8rem, 7vw, 2.6rem);
  line-height:1.15;
}
.title-en{
  display:block;
  font-size:clamp(1.4rem, 6.2vw, 2.1rem);
  line-height:1.05;
  overflow-wrap:anywhere;
  word-break:break-word;
}

header p{
  margin:0;
  color:var(--muted);
  letter-spacing:.10em;
  line-height:1.7;
}

.latest{
  display:grid;
  grid-template-columns:minmax(0,1fr) auto;
  gap:24px;
  align-items:start;
}

@media(max-width:820px){
  .latest{ grid-template-columns:1fr; }
}

.latest h2{
  margin:0 0 12px;
  color:var(--amber);
  letter-spacing:.20em;
  font-size:1.1rem;
}

/* ====== LOG WINDOW (枠) ====== */
#latestPreview{
  margin:0;
  background:rgba(6,10,20,.74);
  border:1px solid rgba(120,220,255,.25);
  border-radius:18px;
  padding:18px 20px;

  position:relative;
  overflow:hidden;
  white-space:normal;
  word-break:break-word;

  /* 読みやすさ */
  line-height:1.75;
  font-size:.95rem;

  /* ループ中のタップUX */
  user-select:text;
}

/* scanline */
#latestPreview::after{
  content:"";
  position:absolute;
  inset:-10%;
  pointer-events:none;
  mix-blend-mode:screen;
  opacity:.30;
  background:
    repeating-linear-gradient(
      180deg,
      rgba(255,255,255,.06) 0px,
      rgba(255,255,255,.06) 1px,
      transparent 4px,
      transparent 6px
    );
  animation:scan 7s linear infinite;
}

@keyframes scan{
  from{ transform: translateY(-6%); }
  to  { transform: translateY( 6%); }
}

@media(prefers-reduced-motion:reduce){
  #latestPreview::after{ animation:none; }
}

/* 失敗表示 */
#latestPreview[data-error="true"]{
  color:#ffb1b1;
  border-color:rgba(255,120,120,.35);
}

/* ====== ENDROLL VIEWPORT ====== */
.roll-viewport{
  position:relative;
  height: clamp(220px, 28vh, 340px); /* “今の枠内”で自然に */
  overflow:hidden;
  border-radius:14px;
}

/* 上下フェード：物語が“ログに溶ける” */
.roll-viewport::before,
.roll-viewport::after{
  content:"";
  position:absolute;
  left:0; right:0;
  height:22%;
  pointer-events:none;
  z-index:2;
}
.roll-viewport::before{
  top:0;
  background:linear-gradient(to bottom, rgba(6,10,20,.98), transparent);
}
.roll-viewport::after{
  bottom:0;
  background:linear-gradient(to top, rgba(6,10,20,.98), transparent);
}

/* ループする本文（2連結） */
.roll-track{
  position:absolute;
  left:0; right:0;
  top:0;
  white-space:pre-wrap;
  transform: translate3d(0,0,0);
  will-change: transform;

  /* 読める文字密度 */
  line-height:1.75;
  font-size:.95rem;
  color:#eef7ff;
  opacity:.95;

  animation: roll var(--roll-speed) linear infinite;
}
@keyframes roll{
  from{ transform: translate3d(0,0,0); }
  to  { transform: translate3d(0,-50%,0); }
}

/* ログが“語り始める”とき：区切り線が通過すると発光 */
.roll-track.is-pulsing{
  animation-play-state: running;
}

/* 区切り線（amber） */
.chrono-divider{
  display:block;
  text-align:center;
  margin: 1.2em 0;
  color: var(--amber);
  letter-spacing: .28em;
  font-size: .85rem;
  text-shadow:
    0 0 12px rgba(255,224,166,.55),
    0 0 28px rgba(255,224,166,.25);
  opacity: .96;
}

/* EP番号（amber） */
.ep-mark{
  display:block;
  margin: .2em 0 .6em;
  color: var(--amber);
  letter-spacing: .22em;
  font-weight: 700;
  text-shadow:
    0 0 10px rgba(255,224,166,.45);
}

/* “装置の声”タグ（例：> STATUS:） */
.sys-mark{
  color: rgba(230,240,255,.82);
  letter-spacing: .16em;
  text-transform: uppercase;
}
.sys-mark strong{
  color: var(--cyan);
  font-weight: 700;
  text-shadow: 0 0 14px rgba(127,230,255,.22);
}

/* 区切り線通過フラッシュ（軽量：opacityだけ） */
.flash{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:3;
  opacity:0;
  background:
    radial-gradient(circle at 50% 45%, rgba(255,224,166,.14), transparent 55%),
    linear-gradient(180deg, rgba(255,224,166,.05), transparent 45%, rgba(127,230,255,.05));
  transition: opacity .24s ease;
}
.flash.on{ opacity:1; }

@media(prefers-reduced-motion:reduce){
  .roll-track{ animation:none; transform:none; }
  .flash{ display:none; }
}

/* アクション */
.actions{
  display:flex;
  flex-direction:column;
  gap:14px;
  align-items:stretch;
}

@media (max-width: 820px){
  .actions{
    flex-direction:row;
    flex-wrap:wrap;
  }
  .actions .btn{
    flex:1 1 160px;
  }
}

.btn{
  display:inline-flex;
  justify-content:center;
  align-items:center;
  gap:10px;

  text-decoration:none;
  text-align:center;
  padding:12px 18px;

  border-radius:14px;
  border:1px solid rgba(120,220,255,.45);
  color:#eef7ff;

  letter-spacing:.18em;
  text-transform:uppercase;

  background:linear-gradient(135deg, rgba(24,44,76,.90), rgba(14,22,40,.96));
  box-shadow:0 12px 30px rgba(0,0,0,.35);

  transition: transform .2s ease, box-shadow .2s ease;
}

.btn:hover,
.btn:focus-visible{
  transform:translateY(-2px);
  box-shadow:0 18px 40px rgba(75,190,255,.20);
  outline:none;
}

.btn.secondary{
  border-color:rgba(198,166,255,.45);
  color:var(--violet);
}

/* ログ帯 */
.log-band{
  padding:18px;
  padding-bottom: calc(18px + var(--sab));
  background:rgba(6,10,20,.65);
  border-radius:22px;
  border:1px solid rgba(120,220,255,.18);
  overflow:hidden;

  /* ★追加：縦幅が揺れないよう固定＆中央寄せ */
  height:84px;
  display:flex;
  align-items:center;
}

.log-track{
  display:flex;
  gap:18px;
  align-items:center;
  width:max-content;
  animation:marquee 20s linear infinite;

  /* ★追加：折り返し禁止（縦幅が変わる原因を潰す） */
  flex-wrap:nowrap;
  white-space:nowrap;
}

@keyframes marquee{
  from{ transform: translateX(0); }
  to  { transform: translateX(-50%); }
}

@media(prefers-reduced-motion:reduce){
  .log-track{ animation:none; }
}

.log-item a{
  display:inline-flex;
  align-items:center;
  justify-content:center;

  color:var(--cyan);
  text-decoration:none;

  border:1px solid rgba(120,220,255,.25);
  padding:8px 12px;
  border-radius:999px;

  letter-spacing:.16em;
}

/* オーバーレイ */
.overlay{
  position:fixed;
  inset:0;
  z-index:10;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(3,6,12,.88);
  transition: opacity .35s ease, visibility .35s ease;
}

.overlay.hidden{
  opacity:0;
  visibility:hidden;
}

.boot-panel{
  width:min(620px, 90vw);
  background:var(--glass-strong);
  padding:28px 30px;
  border-radius:20px;
  border:1px solid rgba(120,220,255,.30);
  box-shadow:var(--shadow);
  letter-spacing:.18em;
  color:var(--muted);
  text-transform:uppercase;

  display:flex;
  flex-direction:column;
  gap:12px;
}

.boot-actions{
  display:flex;
  justify-content:flex-end;
}

.skip-button{
  border:1px solid rgba(198,166,255,.55);
  background:transparent;
  color:var(--violet);
  padding:8px 16px;
  border-radius:999px;
  cursor:pointer;
  letter-spacing:.2em;
}

.skip-button:focus-visible{
  outline:2px solid rgba(198,166,255,.6);
  outline-offset:2px;
}
</style>
</head>

<body>
  <div class="overlay" id="bootOverlay" role="dialog" aria-modal="true" aria-label="Chronologium boot">
    <div class="boot-panel">
      <div class="boot-line"></div>
      <div class="boot-line"></div>
      <div class="boot-line"></div>
      <div class="boot-line"></div>
      <div class="boot-line"></div>
      <div class="boot-actions">
        <button class="skip-button" type="button" id="skipBoot" aria-label="skip boot">SKIP</button>
      </div>
    </div>
  </div>

  <main>
    <header>
      <!-- ★変更：タイトルを2段にして必ず収める -->
      <h1 class="title">
        <span class="title-ja">時間記録殿</span>
        <span class="title-en">(Chronologium)</span>
      </h1>
      <p>これはリンク集ではない。<br>記録と不可逆を観測する装置である。</p>
    </header>

    <section class="panel latest" aria-labelledby="latest-title">
      <div>
        <h2 id="latest-title">最新話ログ</h2>

        <!-- ここが“観測窓”：永遠ループ＋区切り線/EP発光 -->
        <div id="latestPreview" aria-live="polite">
          <div class="flash" id="flash"></div>
          <div class="roll-viewport" id="rollViewport" aria-label="Latest log roll">
            <div class="roll-track" id="rollTrack">> LOADING LOG...</div>
          </div>
        </div>

      </div>
      <div class="actions">
        <a class="btn" href="https://ncode.syosetu.com/n8578lq/13/" target="_blank" rel="noopener noreferrer">▶ 再生</a>
        <a class="btn secondary" href="star-memory.html">STAR MEMORY</a>
      </div>
    </section>

    <section class="panel log-band" aria-label="流れるログ帯（タップで停止/再開）">
      <div class="log-track" role="list">
        <div class="log-item" role="listitem"><a href="https://ncode.syosetu.com/n8578lq/" target="_blank" rel="noopener noreferrer">NAROU</a></div>
        <div class="log-item" role="listitem"><a href="https://kakuyomu.jp/works/822139843408910379" target="_blank" rel="noopener noreferrer">KAKUYOMU</a></div>
        <div class="log-item" role="listitem"><a href="https://note.com/shion_uranai369" target="_blank" rel="noopener noreferrer">NOTE</a></div>
        <div class="log-item" role="listitem"><a href="https://x.com/TaroBure" target="_blank" rel="noopener noreferrer">X</a></div>
        <div class="log-item" role="listitem"><a href="https://www.instagram.com/shionverse_official" target="_blank" rel="noopener noreferrer">INSTAGRAM</a></div>
        <div class="log-item" role="listitem"><a href="https://medium.com/@sion.tarot369/tarot-breaker-9145f2cbf9cd" target="_blank" rel="noopener noreferrer">MEDIUM</a></div>

        <div class="log-item" role="listitem"><a href="https://ncode.syosetu.com/n8578lq/" target="_blank" rel="noopener noreferrer">NAROU</a></div>
        <div class="log-item" role="listitem"><a href="https://kakuyomu.jp/works/822139843408910379" target="_blank" rel="noopener noreferrer">KAKUYOMU</a></div>
        <div class="log-item" role="listitem"><a href="https://note.com/shion_uranai369" target="_blank" rel="noopener noreferrer">NOTE</a></div>
        <div class="log-item" role="listitem"><a href="https://x.com/TaroBure" target="_blank" rel="noopener noreferrer">X</a></div>
        <div class="log-item" role="listitem"><a href="https://www.instagram.com/shionverse_official" target="_blank" rel="noopener noreferrer">INSTAGRAM</a></div>
        <div class="log-item" role="listitem"><a href="https://medium.com/@sion.tarot369/tarot-breaker-9145f2cbf9cd" target="_blank" rel="noopener noreferrer">MEDIUM</a></div>
      </div>
    </section>
  </main>

<script>
/* =========================
   1) iOS/Chrome(iOS)ズレ対策：
      実測innerHeightをCSS変数へ
========================= */
function setVH(){
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
setVH();
window.addEventListener('resize', setVH, { passive:true });
window.addEventListener('orientationchange', setVH, { passive:true });
window.addEventListener('pageshow', setVH, { passive:true });

/* =========================
   2) BOOT（表示中スクロールロック）
========================= */
const overlay = document.getElementById("bootOverlay");
const skipButton = document.getElementById("skipBoot");
const bootLines = document.querySelectorAll(".boot-line");

const seed = new Date().getDate();
const bootText = [
  "> CHRONOLOGIUM // BOOT",
  "> LINK : STAR MEMORY",
  "> NAME / REPLY / IRREVERSIBLE",
  seed % 2 ? "> SYNC ... DELTA" : "> SYNC ... STABLE",
  "> ACCESS GRANTED"
];
bootLines.forEach((l,i)=> l.textContent = bootText[i] ?? "");

// 1日1回の起動演出
const today = new Date();
const todayKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;
const storageKey = "chronologium-boot";
const shouldShow = localStorage.getItem(storageKey) !== todayKey;

function lockScroll(lock){
  document.body.classList.toggle("is-locked", lock);
}

function hideOverlay(){
  overlay.classList.add("hidden");
  overlay.setAttribute("aria-hidden","true");
  lockScroll(false);
  localStorage.setItem(storageKey, todayKey);
}

if (shouldShow){
  lockScroll(true);
  const timer = window.setTimeout(hideOverlay, 1800);

  overlay.addEventListener("click", () => {
    window.clearTimeout(timer);
    hideOverlay();
  });

  skipButton.addEventListener("click", (e) => {
    e.stopPropagation();
    window.clearTimeout(timer);
    hideOverlay();
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape"){
      window.clearTimeout(timer);
      hideOverlay();
    }
  });
}else{
  overlay.classList.add("hidden");
  overlay.setAttribute("aria-hidden","true");
  lockScroll(false);
}

/* =========================
   3) LATEST LOG：永遠ロール
      - latest.txtはテキストのまま
      - EP番号/区切り線だけamber化
      - 区切り線通過で一瞬フラッシュ
========================= */
const latestBox = document.getElementById("latestPreview");
const rollTrack  = document.getElementById("rollTrack");
const flash = document.getElementById("flash");

function setError(message){
  latestBox.setAttribute("data-error","true");
  rollTrack.textContent = message;
}

/* HTMLエスケープ（安全） */
function escapeHTML(str){
  return str
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

/* タロブレ演出：UIが語り始める（最小コストで最大効果） */
function stylizeLog(rawText){
  // 1) 安全にエスケープ
  let s = escapeHTML(rawText);

  // 2) EP番号をamber化（行頭 "EP12" / "EP 12" どちらも対応）
  //    ※ 先頭のEPがタイトルでなくても“ログ上のマーカー”として効く
  s = s.replace(/(^|\n)(EP\s*\d+)(?=\n|$)/g, (m, p1, ep) => {
    return `${p1}<span class="ep-mark">${ep}</span>`;
  });

  // 3) 区切り線（— CHRONOLOGIUM —）をamber化
  const divider = "— CHRONOLOGIUM —";
  s = s.replaceAll(divider, `<span class="chrono-divider">${divider}</span>`);

  // 4) “装置の声”っぽい行を軽く強調（例：> STATUS: / > NAME: など）
  //    行頭の "> " をトリガーに、KEY:VALUEのKEYをcyanに
  s = s.replace(/(^|\n)(&gt;\s*)([A-Z0-9_\/ -]{2,20})(\s*:\s*)([^\n]+)/g,
    (m, p1, gt, key, sep, val) => {
      const k = key.trim();
      return `${p1}<span class="sys-mark">${gt}<strong>${k}</strong>${sep}${val}</span>`;
    }
  );

  return s;
}

/* 途切れないループ：2回連結（-50%まで移動） */
function applyLoopHTML(html){
  const spacer = `<span class="chrono-divider">— CHRONOLOGIUM —</span>`;
  rollTrack.innerHTML = html + spacer + html;
}

/* 区切り線通過フラッシュ（時間ベース・軽量） */
let pulseTimer = null;
function startDividerPulse(){
  // ループ速度に応じて“たまに”光る。読み疲れしない程度に。
  // 44s想定で約11sごとに一回（4回/周）＝過剰にならない。
  const interval = Math.max(
    9000,
    Math.floor(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--roll-speed')) * 250)
  );
  if (pulseTimer) clearInterval(pulseTimer);

  pulseTimer = setInterval(() => {
    flash.classList.add("on");
    setTimeout(()=> flash.classList.remove("on"), 260);
  }, interval);
}

/* prefers-reduced-motionならロール停止＆フラッシュ停止 */
const reducedMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

async function loadLatestRoll(){
  try{
    latestBox.removeAttribute("data-error");

    const res = await fetch("./latest.txt", { cache:"no-store" });
    if (!res.ok) throw new Error("HTTP_NOT_OK");

    const raw = await res.text();
    const text = raw.trim();
    if (!text) throw new Error("EMPTY");

    const styled = stylizeLog(raw);

    if (reducedMotion){
      // 動かさない代わりに“装置の画面”として表示
      rollTrack.style.animation = "none";
      rollTrack.style.transform = "none";
      rollTrack.innerHTML = styled;
      flash.style.display = "none";
      return;
    }

    applyLoopHTML(styled);
    startDividerPulse();

  }catch{
    setError("> ERROR: LOG_FETCH_FAILED\n> STATUS: UNAVAILABLE");
  }
}
loadLatestRoll();

/* =========================
   4) ログ帯：タップで停止/再開
========================= */
const band = document.querySelector(".log-band");
const marquee = document.querySelector(".log-band .log-track");
let marqueePaused = false;

band.addEventListener("click", () => {
  marqueePaused = !marqueePaused;
  marquee.style.animationPlayState = marqueePaused ? "paused" : "running";
});

/* おまけ：観測窓（最新話ロール）もタップで一時停止できると“装置感”が増す */
const rollViewport = document.getElementById("rollViewport");
let rollPaused = false;
rollViewport.addEventListener("click", () => {
  if (reducedMotion) return;
  rollPaused = !rollPaused;
  rollTrack.style.animationPlayState = rollPaused ? "paused" : "running";
  // 停止中はフラッシュも抑える
  if (rollPaused && pulseTimer){
    clearInterval(pulseTimer);
    pulseTimer = null;
  }else if(!rollPaused){
    startDividerPulse();
  }
});
</script>
</body>
</html>
