<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>星詠 3枚リーディング</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<main class="wrap">
  <h1>願い事を想像して —— 星詠3枚</h1>

  <label class="wish">
    あなたの願い
    <input id="wish" type="text" placeholder="例：彼との関係を前に進めたい" />
  </label>

  <div class="actions">
    <button id="start" class="btn btn-primary">タロット展開</button>
  </div>

  <!-- 出現する3枚 -->
  <div id="deck" class="deck" aria-live="polite"></div>
  <p id="hint" class="hint" hidden>カードをタップ</p>

  <!-- リーディング結果 -->
  <section id="result" class="result" hidden>
    <div class="result-item" data-trinity="詩">
      <h3 class="r-title">① 現状</h3>
      <p class="r-text"></p>
    </div>
    <div class="result-item" data-trinity="韻">
      <h3 class="r-title">② 未来</h3>
      <p class="r-text"></p>
    </div>
    <div class="result-item" data-trinity="祈">
      <h3 class="r-title">③ 最終結果</h3>
      <p class="r-text"></p>
    </div>
    <p class="closing"></p>
  </section>

  <div id="controls" class="controls" hidden>
    <button id="close" class="btn">タロットクローズ</button>
    <button id="reset" class="btn">リセット</button>
  </div>
</main>

<!-- 画面全体の光 -->
<div id="glow" class="global-glow" aria-hidden="true"></div>

<script>
(() => {
  // ====== 最小データ（差し替え可） ======
  const faces = [
    { name:'The Fool',    img:'assets/tarot/faces/fool.jpg',
      poem:'はじまりの風。恐れよりも一歩を。' },
    { name:'The Magician',img:'assets/tarot/faces/magician.jpg',
      poem:'意志は力。道具はすでに掌中に。' },
    { name:'The High Priestess',img:'assets/tarot/faces/priestess.jpg',
      poem:'静けさの湖。心の声は正確だ。' },
  ];
  // 裏面（変数はCSSで一元管理してもOK）
  const BACK_IMG = 'assets/tarot/back.png';

  const deckEl = document.getElementById('deck');
  const glowEl = document.getElementById('glow');
  const hintEl = document.getElementById('hint');
  const resultEl = document.getElementById('result');
  const controlsEl = document.getElementById('controls');

  const wishEl = document.getElementById('wish');
  const startBtn = document.getElementById('start');
  const closeBtn = document.getElementById('close');
  const resetBtn = document.getElementById('reset');

  let flippedCount = 0;

  // カード要素生成
  function createCard(face) {
    const card = document.createElement('button');
    card.className = 'card is-back';
    card.setAttribute('type','button');
    card.style.setProperty('--card-back-url', `url('${BACK_IMG}')`);
    card.style.setProperty('--face-url', `url('${face.img}')`);
    card.dataset.name = face.name;
    card.dataset.poem = face.poem;

    const back = document.createElement('span');
    back.className = 'face back';
    const front = document.createElement('span');
    front.className = 'face front';
    const label = document.createElement('span');
    label.className = 'face-label';
    label.textContent = face.name;

    front.appendChild(label);
    card.append(back, front);
    return card;
  }

  // 展開開始：全画面の光 → 3枚出現
  startBtn.addEventListener('click', () => {
    // デッキ初期化
    deckEl.innerHTML = '';
    resultEl.hidden = true;
    controlsEl.hidden = true;
    flippedCount = 0;

    // 光を点灯（全画面）
    glowEl.classList.add('is-on');

    // 少し待ってから3枚を配置してフェードイン
    setTimeout(() => {
      faces.forEach((f, i) => {
        const c = createCard(f);
        deckEl.appendChild(c);
        // 横並びで順次出現
        setTimeout(() => c.classList.add('show'), 250 * i);
      });
      hintEl.hidden = false;
    }, 450);

    // 光を収束
    setTimeout(() => glowEl.classList.remove('is-on'), 1300);
  });

  // タップで反転
  deckEl.addEventListener('click', (e) => {
    const card = e.target.closest('.card');
    if (!card || !deckEl.contains(card)) return;
    if (!card.classList.contains('is-back')) return;

    card.classList.remove('is-back');
    card.classList.add('is-flipped');
    flippedCount++;

    if (flippedCount === 3) {
      hintEl.hidden = true;
      // 結果を詩韻思想風に整形
      const wish = (wishEl.value || 'あなたの願い').trim();
      const titles = resultEl.querySelectorAll('.r-title');
      const texts  = resultEl.querySelectorAll('.r-text');

      const picked = [...deckEl.querySelectorAll('.card')].map(c => ({
        name: c.dataset.name, poem: c.dataset.poem
      }));

      titles[0].textContent = `① 現状 — ${picked[0].name}`;
      texts[0].textContent  = `${picked[0].poem}`;

      titles[1].textContent = `② 未来 — ${picked[1].name}`;
      texts[1].textContent  = `${picked[1].poem}`;

      titles[2].textContent = `③ 最終結果 — ${picked[2].name}`;
      texts[2].textContent  = `${picked[2].poem}`;

      resultEl.querySelector('.closing').textContent =
        `「${wish}」は、選ばれた言葉と星の合図を受け取り、静かに光へと帰還する。`;

      resultEl.hidden = false;
      controlsEl.hidden = false;
    }
  });

  // クローズ：淡く消灯
  closeBtn.addEventListener('click', () => {
    document.body.classList.add('is-closed');
    setTimeout(()=>document.body.classList.remove('is-closed'), 1200);
  });

  // リセット
  resetBtn.addEventListener('click', () => {
    deckEl.innerHTML = '';
    resultEl.hidden = true;
    controlsEl.hidden = true;
    hintEl.hidden = true;
    flippedCount = 0;
  });
})();
</script>
</body>
</html>
