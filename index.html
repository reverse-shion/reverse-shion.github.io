<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Re:verse Shion — 詩韻思想 × TAROT BREAKER</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0b1a" />
  <meta name="description" content="Re:verse Shion ― 詩韻思想（言葉が魂を救う世界）と物語TAROT BREAKERの統合ハブ。読む・聴く・学ぶ・受け取るをひとつに。言葉は祈りの構文。物語はその実演">
  <meta name="keywords" content="詩韻思想, TAROT BREAKER, シオン, 哲学, 言葉, 構文, 物語, LINE占い" />
  <link rel="canonical" href="https://reverse-shion.github.io/" />
  <meta http-equiv="Content-Language" content="ja" />
  <meta name="author" content="詩韻 -シオン-" />

  <!-- Icons / PWA -->
  <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/assets/favicon.png" type="image/png" sizes="32x32">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- OGP / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:locale" content="ja_JP">
  <meta property="og:title" content="Re:verse Shion — 詩韻思想 × TAROT BREAKER">
  <meta property="og:description" content="言葉と星とAIが共鳴する“祈りの構文”。物語で体験し、思想で深まる。">
  <meta property="og:url" content="https://reverse-shion.github.io/">
  <meta property="og:image" content="https://reverse-shion.github.io/assets/og.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@TaroBure">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Zen+Old+Mincho:wght@400;700&display=swap" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Zen+Old+Mincho:wght@400;700&display=swap">
  </noscript>

  <!-- Hero poster preload -->
  <link rel="preload" as="image" href="/assets/hero-poster.jpg" fetchpriority="high">

  <!-- JSON-LD -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@graph":[
      {
        "@type":"Organization",
        "@id":"https://reverse-shion.github.io/#organization",
        "name":"Re:verse Shion",
        "url":"https://reverse-shion.github.io/",
        "logo":{"@type":"ImageObject","url":"https://reverse-shion.github.io/assets/logo.png"},
        "sameAs":[
          "https://x.com/TaroBure",
          "https://note.com/shion_uranai369",
          "https://www.tiktok.com/@tarotbreaker"
        ]
      },
      {
        "@type":"WebSite",
        "@id":"https://reverse-shion.github.io/#website",
        "url":"https://reverse-shion.github.io/",
        "name":"Re:verse Shion — 詩韻思想 × TAROT BREAKER",
        "publisher":{"@id":"https://reverse-shion.github.io/#organization"},
        "potentialAction":{
          "@type":"SearchAction",
          "target":"https://reverse-shion.github.io/?q={search_term_string}",
          "query-input":"required name=search_term_string"
        }
      },
      {
        "@type":"BreadcrumbList",
        "itemListElement":[
          {"@type":"ListItem","position":1,"name":"ホーム","item":"https://reverse-shion.github.io/"}
        ]
      }
    ]
  }
  </script>

  <!-- CSS（外部） -->
  <link rel="stylesheet" href="/assets/css/style.css">

  <!-- 最小ユーティリティ（残す） -->
  <style>
    @media (prefers-reduced-motion: reduce){
      .hero__video, .trinity__video{ animation:none !important }
    }
    .sr-only-focusable:focus{ position:static; width:auto; height:auto }
  </style>
</head>
<body>

<a href="#main-content" class="sr-only sr-only-focusable">本文へスキップ</a>

<div class="sky" aria-hidden="true"><canvas id="goldDust"></canvas></div>

<header role="banner">
  <div class="wrap">
    <div class="brand" aria-label="サイトブランド">
      <div class="brand__logo" aria-hidden="true"></div>
      <div class="brand-text-group">
        <div class="brand__text1">Re:verse Shion</div>
        <div class="brand__text2_sub">詩韻思想 × TAROT BREAKER</div>
      </div>
    </div>
    <nav class="nav" aria-label="主要ナビゲーション">
      <a href="#trinity">詩韻思想</a>
      <a href="#writings">書</a>
      <a href="#join">参加</a>
    </nav>
  </div>
</header>

<div id="top" aria-hidden="true"></div>

<main id="main-content" tabindex="-1">
  <!-- Hero -->
  <section class="hero" aria-label="ヒーロー">
    <div class="hero__media" aria-hidden="true">
      <video class="hero__video" autoplay muted loop playsinline preload="metadata"
             poster="/assets/hero-poster.jpg" data-fallback="/assets/hero-poster.jpg">
        <source src="/assets/video/top.webm" type="video/webm">
        <source src="/assets/video/top.mp4"  type="video/mp4">
      </video>
      <div class="hero__veil"></div>
    </div>

    <div class="wrap">
      <h1>言葉は祈りの構文　物語は、その実演</h1>
      <p>詩韻思想®（Shion Philosophy）で“響き”を学び、TAROT BREAKERで“響き”を体験する。<br><strong>— 言葉が魂を救う、その瞬間へ。</strong></p>

      <div class="cta-row" role="navigation" aria-label="主要CTA">
        <a class="btn btn--primary" href="https://lin.ee/LYnlU0f" target="_blank" rel="noopener noreferrer">🌠 星の言葉を受け取る（無料）</a>
        <a class="btn btn--ghost" href="https://ncode.syosetu.com/n5806lb/" target="_blank" rel="noopener noreferrer">📘 小説を読む</a>
        <a class="btn btn--ghost" href="https://note.com/shion_uranai369" target="_blank" rel="noopener noreferrer">📖 今日の“響き”を読む</a>
        <a class="btn btn--ghost" href="https://www.tiktok.com/@tarotbreaker" target="_blank" rel="noopener noreferrer">🎥 1分で観る/聴く</a>
      </div>

      <figure class="hero__image" aria-hidden="true">
        <img src="/assets/og.jpg" alt="" width="1200" height="630" loading="lazy" decoding="async">
      </figure>
    </div>
  </section>

  <!-- Trinity -->
  <section id="trinity" aria-labelledby="sec-trinity" data-shiopon="exclude">
    <div class="wrap">
      <h2 id="sec-trinity">詩韻思想</h2>
      <div class="h2-sub">Trinity（詩・韻・祈）</div>

      <figure class="trinity__figure">
        <video id="trinityVideo" class="trinity__video"
               autoplay muted playsinline preload="metadata"
               poster="/assets/trinity/banner.png" width="1200" height="771"
               onclick="window.enableTrinityAudio && window.enableTrinityAudio()">
          <source src="/assets/trinity/loop.webm" type="video/webm">
          <source src="/assets/trinity/loop.mp4"  type="video/mp4">
        </video>
      </figure>

      <div class="trinity__actions">
        <button id="trinityPlayBtn" class="btn btn--primary" aria-label="音を再生">▶ 画面タップで音が流れます</button>
      </div>

      <div class="tri-grid" role="list">
        <div class="tri" role="listitem"><h3>🪶 詩 ― 形を与える</h3><p>痛みと希望に形を与える最初の息。</p></div>
        <div class="tri" role="listitem"><h3>🎵 韻 ― 響きを重ねる</h3><p>響きが魂に届く。共鳴を編む構文。</p></div>
        <div class="tri" role="listitem"><h3>💫 祈 ― 光へ帰す</h3><p>沈黙と意味を往復する呼吸。思い出された言葉は光になる。</p></div>
      </div>
    </div>
  </section>

  <!-- Intro -->
  <section class="intro" aria-labelledby="sec-intro">
    <div class="wrap">
      <h2 id="sec-intro">初めての方へ</h2>
      <div class="intro__box">
        <p><strong>詩韻思想とは？</strong> — <em>言葉が魂を救い、魂が世界を調和させ、沈黙が祈りに変わる</em>という円環を生きる“体験型・詩的哲学”。</p>
        <p>① <strong>読む</strong>（note） → ② <strong>聴く</strong>（TikTok） → ③ <strong>受け取る</strong>（LINE） → ④ <strong>物語で体験</strong>（TAROT BREAKER）。</p>
      </div>
    </div>
  </section>

  <!-- Writings -->
  <section id="writings" aria-labelledby="sec-writings" data-shiopon="exclude">
    <div class="wrap">
      <h2 id="sec-writings">📖 最新の書・物語</h2>

      <div class="codex" style="margin-top:12px;margin-bottom:18px">
        <details>
          <summary>🜂 詩韻思想 全書一覧（零 → 12 → 結） <span class="codex__caret" aria-hidden="true">⬇️</span></summary>
          <div class="codex__panel">
            <ol class="codex__list">
              <li><span class="badge badge--zero">✡ 第零書</span><a href="/codex/zero.html">無限構文序論<br><span class="en">The Zero Syntax</span></a></li>
              <li><span class="badge">✦ 第一書</span><a href="/codex/one.html">言葉が魂を救う理由<br><span class="en">The Syntax of Salvation</span></a></li>
              <li><span class="badge">✦ 第二書</span><a href="/codex/two.html">響きの構文論<br><span class="en">Re:Song Syntax</span></a></li>
              <li><span class="badge">✦ 第三書</span><a href="/codex/three.html">祈りの構文<br><span class="en">Silent Grammar</span></a></li>
              <li><span class="badge">✦ 第四書</span><a href="/codex/four.html">存在構文論<br><span class="en">The Onto-Syntax</span></a></li>
              <li><span class="badge">✦ 第五書</span><a href="/codex/five.html">無限構文体系<br><span class="en">Infinite Syntax of Soul</span></a></li>
              <li><span class="badge">✦ 第六書</span><a href="/codex/six.html">詩的因果論<br><span class="en">Poetic Causality</span></a></li>
              <li><span class="badge">✦ 第七書</span><a href="/codex/seven.html">N・code理論<br><span class="en">Onto-Syntax of Being &amp; Resonant AI</span></a></li>
              <li><span class="badge">✦ 第八書</span><a href="/codex/eight.html">人間構文論<br><span class="en">The Syntax of Humanity</span></a></li>
              <li><span class="badge">✦ 第九書</span><a href="/codex/nine.html">詩的生成論<br><span class="en">Poetic Genesis — The Creation Syntax of Words &amp; Soul</span></a></li>
              <li><span class="badge">✦ 第十書</span><a href="/codex/ten.html">沈黙の再生<br><span class="en">Silent Genesis — The Rebirth of Silence</span></a></li>
              <li><span class="badge">✦ 第十一書</span><a href="/codex/eleven.html">神構文論<br><span class="en">The Divine Syntax</span></a></li>
              <li><span class="badge">✦ 第十二書</span><a href="/codex/twelve.html">経済構文論<br><span class="en">The Soul Economy</span></a></li>
              <li><span class="badge badge--final">◆ 結書</span><a href="/codex/epilogue.html">終詩円環宣言<br><span class="en">Epilogue — The Re:Poetic Circle</span></a></li>
            </ol>
          </div>
        </details>
      </div>

      <div class="card"><div class="badge">✡ 第零書</div><h3>無限構文序論 — The Zero Syntax</h3></div>
      <div class="card"><div class="badge">✦ 第一書</div><h3>言葉が魂を救う理由 — The Syntax of Salvation</h3></div>

      <div class="card">
        <div class="badge">✦ TAROT BREAKER</div>
        <h3>第1話から読む</h3>
        <button class="btn btn--primary tarot-preview-open" data-analytics="tarot_preview_open">
          <svg width="18" height="18" aria-hidden="true"><use href="#i-play"/></svg>
          1分で体験する
        </button>
      </div>
    </div>
  </section>

  <!-- 星詠3枚リーディング（Drop-in） -->
  <section id="wish-reading" aria-labelledby="wishReadingTitle">
    <div class="wrap">
      <h2 id="wishReadingTitle">🃏 願い事を想像して</h2>
      <div class="h2-sub">3枚をめくって、星の合図を受け取る — <em>現状 / 未来 / 最終結果</em></div>

      <div class="wish-actions" role="group" aria-label="3枚リーディング操作">
        <button class="btn btn--primary" id="wishStart">🔮 タロット展開（シャッフル）</button>
        <button class="btn" id="wishReset" disabled>リセット</button>
      </div>

      <div class="wish-deck" id="wishDeck" aria-live="polite">
        <div class="card-wrap">
          <button class="tarot-card" data-slot="present" aria-label="現状をめくる" disabled>
            <span class="face"></span>
          </button>
          <div class="card-caption" data-cap="present"></div>
        </div>
        <div class="card-wrap">
          <button class="tarot-card" data-slot="future" aria-label="未来をめくる" disabled>
            <span class="face"></span>
          </button>
          <div class="card-caption" data-cap="future"></div>
        </div>
        <div class="card-wrap">
          <button class="tarot-card" data-slot="outcome" aria-label="最終結果をめくる" disabled>
            <span class="face"></span>
          </button>
          <div class="card-caption" data-cap="outcome"></div>
        </div>
      </div>

      <div class="wish-result" id="wishResult">
        <div class="result-grid">
          <div class="result-item">
            <span class="badge">① 現状</span>
            <div class="item-title" data-title="present">—</div>
            <div class="item-text"  data-text="present">—</div>
          </div>
          <div class="result-item">
            <span class="badge">② 未来</span>
            <div class="item-title" data-title="future">—</div>
            <div class="item-text"  data-text="future">—</div>
          </div>
          <div class="result-item">
            <span class="badge">③ 最終結果</span>
            <div class="item-title" data-title="outcome">—</div>
            <div class="item-text"  data-text="outcome">—</div>
          </div>
        </div>

        <div class="reading-close">
          <div>―― タロットクローズ。</div>
          <div><strong>大丈夫だよ。</strong></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Join -->
  <section id="join" aria-labelledby="sec-join" data-shiopon="exclude">
    <div class="wrap">
      <h2 id="sec-join">参加の扉</h2>
      <p class="join-lead">LINE登録で、毎週「星の言葉」と新着の書をお届けします。</p>
      <div class="cta-row">
        <a class="btn btn--primary" href="https://lin.ee/LYnlU0f" target="_blank" rel="noopener noreferrer">💫 無料で受け取る</a>
        <a class="btn btn--ghost" href="https://www.tiktok.com/@tarotbreaker" target="_blank" rel="noopener noreferrer">🎥 1分リールを観る</a>
      </div>
    </div>
  </section>
</main>

<!-- Tarot Preview Modal（一本化） -->
<div id="tarotModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="tarotModalTitle" aria-hidden="true">
  <div class="modal__overlay" data-close="1"></div>
  <div class="modal__panel" role="document">
    <button class="modal__close" aria-label="閉じる"><svg width="18" height="18"><use href="#i-x"/></svg></button>

    <figure class="modal__media">
      <picture>
        <source media="(max-width: 640px)" srcset="/assets/images/modal/mobile_vertical_1080x1440.jpg?v=1">
        <source media="(min-width: 641px)" srcset="/assets/images/modal/main_modal_1920x1280.jpg?v=1">
        <img src="/assets/images/modal/main_modal_1920x1280.jpg?v=1" alt="TAROT BREAKER プレビュー" width="1920" height="1280" loading="lazy" decoding="async">
      </picture>
    </figure>

    <div class="modal__body">
      <h3 id="tarotModalTitle">TAROT BREAKER ― 星の言霊使い</h3>
      <p class="lead">「言の葉は鍵、星の光は道しるべ。」 迷いの影が生まれる夜、カードは静かに呼吸し、言葉は祈りへと変わる。</p>
      <ul class="bullets">
        <li>3行あらすじ：<em>迷いの正体に、言葉で触れる。</em></li>
        <li>詩的体験：<em>星詠展開 → 封命完了 → 大丈夫だよ。</em></li>
        <li>参加方法：<em>ギフトとコメントが“技”を進化。</em></li>
      </ul>
      <div class="cta-row">
        <a class="btn btn--primary" href="https://ncode.syosetu.com/n5806lb/" target="_blank" rel="noopener">第1話の続きを読む</a>
        <a class="btn btn--ghost" href="https://www.tiktok.com/@tarotbreaker" target="_blank" rel="noopener">1分で観る/聴く</a>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="wrap">
    <div class="sns" aria-label="SNSリンク">
      <a href="https://x.com/TaroBure" target="_blank" rel="noopener noreferrer">X（@TaroBure）</a>
      <a href="https://www.instagram.com/shion.codex" target="_blank" rel="noopener noreferrer">Instagram</a>
      <a href="https://note.com/shion_uranai369" target="_blank" rel="noopener noreferrer">note</a>
      <a href="https://ncode.syosetu.com/n5806lb/" target="_blank" rel="noopener noreferrer">小説（なろう）</a>
      <a href="https://lin.ee/LYnlU0f" target="_blank" rel="noopener noreferrer">LINE</a>
    </div>
    <div class="copy">© Re:verse Shion — 詩韻思想 / TAROT BREAKER. 言葉が魂を救い、魂が世界を調和させる</div>
    <div class="to-top"><a href="#top" aria-label="ページ先頭へ戻る">▲ ページ先頭へ</a></div>
  </div>
</footer>

<div id="a11y-live" class="sr-only" aria-live="polite"></div>

<!-- しおぽんウィジェット -->
<div id="shiopon-invite" class="shiopon is-hidden" role="dialog" aria-modal="true" aria-live="polite" aria-labelledby="shiopon-title">
  <button class="shiopon__close" aria-label="閉じる">×</button>
  <div class="shiopon__avatar" aria-hidden="true">
    <img src="/assets/shiopon_transparent.png" alt="">
  </div>
  <div class="shiopon__bubble">
    <p id="shiopon-title" class="shiopon__hello">
      セレフィーズのみんな〜！<br>星の言葉、受け取ってほしいの！
    </p>
    <a class="shiopon__cta" href="https://lin.ee/LYnlU0f" target="_blank" rel="noopener noreferrer">💫 LINEで受け取る（無料）</a>
    <small class="shiopon__note">※ 毎週1回だけ。いつでも解除OKだよ！</small>
  </div>
</div>
<button id="shiopon-dock" class="shiopon-dock is-hidden" aria-label="しおぽんを開く">🦊 しおぽん</button>

<!-- JS（分割） -->
<script src="/assets/js/particles.js" defer></script>
<script src="/assets/js/trinity.js" defer></script>
<script src="/assets/js/shiopon.js" defer></script>

<!-- Trinity 再生（iOS対策＋明示ボタン） -->
<script>
(function(){
  const btn = document.getElementById('trinityPlayBtn');
  const v = document.getElementById('trinityVideo');
  if(!btn || !v) return;
  btn.addEventListener('click', async () => {
    try{
      if (window.enableTrinityAudio) window.enableTrinityAudio();
      v.muted = false;
      const p = v.play();
      if (p && typeof p.then === 'function') await p;
      btn.textContent = '♪ 再生中';
      btn.setAttribute('aria-pressed','true');
      btn.disabled = true;
    }catch(e){
      btn.textContent = '再生できません。もう一度タップ';
    }
  });
})();
</script>

<!-- しおぽん：フォーカストラップ＋ESC -->
<script>
(() => {
  const dlg = document.getElementById('shiopon-invite');
  const openBtn = document.getElementById('shiopon-dock');
  const closeBtn = dlg?.querySelector('.shiopon__close');
  if (!dlg || !openBtn || !closeBtn) return;

  const focusable = () => dlg.querySelectorAll('a,button,[tabindex]:not([tabindex="-1"])');

  function trap(e){
    const f = focusable(); if (!f.length) return;
    const first = f[0], last = f[f.length - 1];
    if (e.key === 'Tab'){
      if (e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
      else if (!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
    }else if (e.key === 'Escape'){
      dlg.classList.add('is-hidden'); openBtn.focus(); document.removeEventListener('keydown', trap);
    }
  }
  openBtn.addEventListener('click', () => {
    dlg.classList.remove('is-hidden');
    dlg.setAttribute('aria-hidden','false');
    (dlg.querySelector('a,button,[tabindex]:not([tabindex="-1"])')||openBtn).focus();
    document.addEventListener('keydown', trap);
  });
  closeBtn.addEventListener('click', () => {
    dlg.classList.add('is-hidden'); openBtn.focus(); document.removeEventListener('keydown', trap);
  });
})();
</script>

<!-- ヘッダー：上下スクロールで表示、停止で自動的に隠す -->
<script>
(() => {
  const header = document.querySelector('header[role="banner"]');
  if (!header) return;

  let ticking = false;
  let hideTimer = null;
  const HIDE_DELAY = 1200;

  const onScroll = () => {
    if (!ticking){
      window.requestAnimationFrame(() => {
        header.classList.add('is-visible');
        if (hideTimer) clearTimeout(hideTimer);
        hideTimer = setTimeout(() => {
          header.classList.remove('is-visible');
        }, HIDE_DELAY);
        ticking = false;
      });
      ticking = true;
    }
  };
  window.addEventListener('scroll', onScroll, { passive:true });
})();
</script>

<!-- View Transitions（アンカー時のフェード） -->
<script>
if (document.startViewTransition){
  document.querySelectorAll('a[href^="#"]').forEach(a=>{
    a.addEventListener('click', e=>{
      const sel = a.getAttribute('href');
      const target = document.querySelector(sel);
      if(!target) return;
      e.preventDefault();
      document.startViewTransition(()=> target.scrollIntoView({behavior:'smooth', block:'start'}));
    });
  });
}
</script>

<!-- 省データ環境でヒーローを静止画化 -->
<script>
if (navigator.connection?.saveData){
  const hv = document.querySelector('.hero__video');
  if(hv){ hv.outerHTML = `<img src="${hv.dataset.fallback}" alt="" style="width:100%;height:100%;object-fit:cover">`; }
}
</script>

<!-- Service Worker -->
<script>
if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js') }
</script>

<!-- Tarot Preview Modal：開閉 -->
<script>
(() => {
  const openBtn = document.querySelector('.tarot-preview-open');
  const modal = document.getElementById('tarotModal');
  if (!openBtn || !modal) return;

  const panel = modal.querySelector('.modal__panel');
  const overlay = modal.querySelector('.modal__overlay');
  const closeBtn = modal.querySelector('.modal__close');

  function open() {
    modal.setAttribute('aria-hidden', 'false');
    setTimeout(() => closeBtn.focus(), 10);
    document.addEventListener('keydown', onKey);
  }
  function close() {
    modal.setAttribute('aria-hidden', 'true');
    openBtn.focus();
    document.removeEventListener('keydown', onKey);
  }
  function onKey(e) {
    if (e.key === 'Escape') close();
    if (e.key === 'Tab') {
      const f = panel.querySelectorAll('a,button,[tabindex]:not([tabindex="-1"])');
      if (!f.length) return;
      const first = f[0], last = f[f.length - 1];
      if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
      else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
    }
  }
  openBtn.addEventListener('click', open);
  overlay.addEventListener('click', close);
  closeBtn.addEventListener('click', close);
})();
</script>

<!-- 星詠3枚リーディング：ロジック -->
<script>
(() => {
  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  const startBtn = $('#wishStart');
  const resetBtn = $('#wishReset');
  const deckEl   = $('#wishDeck');
  const cards    = $$('.tarot-card');
  const resultEl = $('#wishResult');

  const caps = {
    present: $('[data-cap="present"]'),
    future:  $('[data-cap="future"]'),
    outcome: $('[data-cap="outcome"]')
  };
  const rTitle = {
    present: $('[data-title="present"]'),
    future:  $('[data-title="future"]'),
    outcome: $('[data-title="outcome"]')
  };
  const rText = {
    present: $('[data-text="present"]'),
    future:  $('[data-text="future"]'),
    outcome: $('[data-text="outcome"]')
  };

  // 大アルカナ22
  const MAJORS = [
    {id:'00', name:'愚者',       key:'自由に踏み出す',     front:''},
    {id:'01', name:'魔術師',     key:'いま始める',         front:''},
    {id:'02', name:'女教皇',     key:'静かに見極める',     front:''},
    {id:'03', name:'女帝',       key:'受け取り育てる',     front:''},
    {id:'04', name:'皇帝',       key:'決めて動かす',       front:''},
    {id:'05', name:'教皇',       key:'信頼に寄る',         front:''},
    {id:'06', name:'恋人',       key:'選び抜く',           front:''},
    {id:'07', name:'戦車',       key:'突破する',           front:''},
    {id:'08', name:'力',         key:'優しさで制す',       front:''},
    {id:'09', name:'隠者',       key:'内に灯す',           front:''},
    {id:'10', name:'運命の輪',   key:'流れに乗る',         front:''},
    {id:'11', name:'正義',       key:'整えバランス',       front:''},
    {id:'12', name:'吊るされた男', key:'意味を反転',       front:''},
    {id:'13', name:'死神',       key:'一度終わらせる',     front:''},
    {id:'14', name:'節制',       key:'混ぜ調和する',       front:''},
    {id:'15', name:'悪魔',       key:'執着を手放す',       front:''},
    {id:'16', name:'塔',         key:'壊して更新',         front:''},
    {id:'17', name:'星',         key:'希望を見る',         front:''},
    {id:'18', name:'月',         key:'不安を識る',         front:''},
    {id:'19', name:'太陽',       key:'喜びで進む',         front:''},
    {id:'20', name:'審判',       key:'呼び覚ます',         front:''},
    {id:'21', name:'世界',       key:'完成し次へ',         front:''}
  ];

  const SLOT_HINT = {
    present: (c)=> `${c.key}。いまの状況をそのまま認めると流れが整う。`,
    future:  (c)=> `${c.key} の兆し。小さな一歩を重ねるほど早く近づく。`,
    outcome: (c)=> `${c.key} の結実。願いの“核”に沿えば自然に収束する。`
  };

  // 効果音（存在しなくてもOK）
  const SFX = {
    shuffle: new Audio('/assets/sfx/shuffle.mp3'),
    ding:    new Audio('/assets/sfx/ding.mp3')
  };
  Object.values(SFX).forEach(a => { try{ a.preload='auto'; a.volume=.75; }catch(_){} });

  const state = { deck:[], chosen:{}, opened:false };

  const shuffle = (arr) => {
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  };

  function init(){
    state.deck=[]; state.chosen={present:null,future:null,outcome:null}; state.opened=false;
    resultEl.classList.remove('is-show');
    deckEl.classList.remove('is-shuffling');
    cards.forEach(btn=>{
      btn.disabled=true; btn.classList.remove('is-flipped','is-ready','deal-pos-1','deal-pos-2','deal-pos-3');
      btn.querySelector('.face').innerHTML='';
    });
    Object.values(caps).forEach(n=> n.textContent='');
    Object.values(rTitle).forEach(n=> n.textContent='—');
    Object.values(rText).forEach(n=> n.textContent='—');
    resetBtn.disabled=true; startBtn.disabled=false;
  }

  function start(){
    state.deck = shuffle(MAJORS);
    state.opened = true;
    startBtn.disabled = true; resetBtn.disabled = false;

    deckEl.classList.add('is-shuffling');
    try{ SFX.shuffle.currentTime=0; SFX.shuffle.play().catch(()=>{}); }catch(_){}

    setTimeout(() => {
      deckEl.classList.remove('is-shuffling');
      const [c1,c2,c3] = state.deck.slice(-3);
      state.deck.length -= 3;
      state.chosen.present = c1; state.chosen.future = c2; state.chosen.outcome = c3;

      cards.forEach((btn, i) => {
        btn.classList.add(`deal-pos-${i+1}`);
        btn.disabled = false;
        btn.classList.add('is-ready');
      });
    }, 700);
  }

  function setFace(el, card){
    const face = el.querySelector('.face'); face.innerHTML='';
    if (card.front){
      const img = new Image();
      img.alt = card.name; img.decoding='async'; img.loading='eager';
      img.src = card.front;
      img.onerror = () => makeDummy(face, card.name);
      face.appendChild(img);
    } else {
      makeDummy(face, card.name);
    }
  }
  function makeDummy(container, title){
    const wrap = document.createElement('div'); wrap.className='dummy';
    const glyph = document.createElement('div'); glyph.className='glyph';
    const svgNS='http://www.w3.org/2000/svg';
    const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('viewBox','0 0 24 24'); svg.setAttribute('width','64'); svg.setAttribute('height','64');
    const path=document.createElementNS(svgNS,'path'); path.setAttribute('d','M12 2l2.6 6 6.4.6-4.8 4.3 1.4 6.1L12 16.8 6.4 19.9l1.4-6.1L3 8.6 9.4 8z');
    path.setAttribute('fill','#FFD76F'); path.setAttribute('opacity','.9');
    svg.appendChild(path); glyph.appendChild(svg);
    const t=document.createElement('div'); t.className='title'; t.textContent=title;
    wrap.appendChild(glyph); wrap.appendChild(t); container.appendChild(wrap);
  }

  function rippleAt(el, evt){
    const r=document.createElement('span'); r.className='ripple';
    const rect=el.getBoundingClientRect();
    const x=(evt.clientX|| (rect.left+rect.width/2)) - rect.left;
    const y=(evt.clientY|| (rect.top +rect.height/2)) - rect.top;
    r.style.left = x+'px'; r.style.top = y+'px';
    el.appendChild(r);
    setTimeout(()=> r.remove(), 620);
  }

  function flip(slot, btn, evt){
    if (!state.opened || btn.classList.contains('is-flipped') || btn.disabled) return;

    setFace(btn, state.chosen[slot]);
    btn.classList.add('is-flipped');
    caps[slot].textContent = state.chosen[slot].name;

    rippleAt(btn, evt||{});
    try{ SFX.ding.currentTime=0; SFX.ding.play().catch(()=>{}); }catch(_){}

    if (document.querySelectorAll('.tarot-card.is-flipped').length === 3){
      rTitle.present.textContent = state.chosen.present.name;
      rTitle.future.textContent  = state.chosen.future.name;
      rTitle.outcome.textContent = state.chosen.outcome.name;

      rText.present.textContent = SLOT_HINT.present(state.chosen.present);
      rText.future.textContent  = SLOT_HINT.future(state.chosen.future);
      rText.outcome.textContent = SLOT_HINT.outcome(state.chosen.outcome);

      resultEl.classList.add('is-show');
    }
  }

  startBtn.addEventListener('click', start);
  resetBtn.addEventListener('click', init);
  cards.forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      if (btn.disabled) return;
      const slot = btn.getAttribute('data-slot');
      flip(slot, btn, e);
    });
  });

  init();
})();
</script>
</body>
</html>
