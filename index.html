<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>3æšã‚¿ãƒ­ãƒƒãƒˆ | Re:verse Shion</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="preload" as="audio" href="assets/sfx/flip.mp3">
  <link rel="preload" as="audio" href="assets/sfx/ping.mp3">
</head>
<body>
  <main class="wrap">
    <header class="page-head">
      <h1>ğŸƒ 3æšãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆä½“é¨“ï¼‰</h1>
      <p class="sub">ç¾åœ¨ï¼éµï¼é€²ã‚€é“ã€‚ã‚¿ãƒƒãƒ—ã§ã‚ãã‚Œã€æ˜Ÿç´‹ãŒå…‰ã‚‹ã‚ˆã€‚</p>
    </header>

    <section id="reading" aria-labelledby="readingTitle">
      <h2 id="readingTitle" class="sr-only">3æšãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</h2>

      <div class="actions" role="group" aria-label="æ“ä½œ">
        <button id="btnStart" class="btn btn--primary">ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦å§‹ã‚ã‚‹</button>
        <button id="btnReset" class="btn btn--ghost" disabled>ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <div class="stage">
        <canvas id="ripple" aria-hidden="true"></canvas>

        <div class="deck" role="list" aria-label="ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒƒã‚­">
          <!-- 1æšç›® -->
          <div class="card-wrap" role="listitem">
            <button class="tarot-card" data-slot="1" aria-label="1æšç›®ã‚’å¼•ã" disabled>
              <div class="tarot-card-inner">
                <div class="face face-front"><img alt=""></div>
                <div class="face face-back" aria-hidden="true"></div>
              </div>
            </button>
            <div class="cap" data-cap="1" aria-live="polite"></div>
          </div>

          <!-- 2æšç›® -->
          <div class="card-wrap" role="listitem">
            <button class="tarot-card" data-slot="2" aria-label="2æšç›®ã‚’å¼•ã" disabled>
              <div class="tarot-card-inner">
                <div class="face face-front"><img alt=""></div>
                <div class="face face-back" aria-hidden="true"></div>
              </div>
            </button>
            <div class="cap" data-cap="2" aria-live="polite"></div>
          </div>

          <!-- 3æšç›® -->
          <div class="card-wrap" role="listitem">
            <button class="tarot-card" data-slot="3" aria-label="3æšç›®ã‚’å¼•ã" disabled>
              <div class="tarot-card-inner">
                <div class="face face-front"><img alt=""></div>
                <div class="face face-back" aria-hidden="true"></div>
              </div>
            </button>
            <div class="cap" data-cap="3" aria-live="polite"></div>
          </div>
        </div>
      </div>

      <!-- çµæœï¼šå„3è¡Œ -->
      <div id="result" hidden>
        <div class="result-grid">
          <div class="result-item">
            <div class="badge">â‘  ç¾åœ¨</div>
            <h3 class="res-title" data-title="1">â€”</h3>
            <p class="res-text"  data-text="1">â€”</p>
          </div>
          <div class="result-item">
            <div class="badge">â‘¡ éµ</div>
            <h3 class="res-title" data-title="2">â€”</h3>
            <p class="res-text"  data-text="2">â€”</p>
          </div>
          <div class="result-item">
            <div class="badge">â‘¢ é€²ã‚€é“</div>
            <h3 class="res-title" data-title="3">â€”</h3>
            <p class="res-text"  data-text="3">â€”</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- sfx -->
  <audio id="sfxFlip" preload="auto" src="assets/sfx/flip.mp3"></audio>
  <audio id="sfxPing" preload="auto" src="assets/sfx/ping.mp3"></audio>

  <div id="live" class="sr-only" aria-live="polite"></div>

  <script>
  /* ===== ASSETS è¨­å®šï¼ˆã“ã“ã ã‘è‡ªåˆ†ã®ãƒ‘ã‚¹ã«åˆã‚ã›ã¦ã­ï¼‰ ===== */
  const CARD_BACK_URL = 'assets/tarot/back.png';              // è£é¢
  const CARD_IMG_BASE = 'assets/tarot/rws/';                   // è¡¨é¢ã®ãƒ•ã‚©ãƒ«ãƒ€
  // Riderâ€“Waiteï¼ˆãƒ¡ã‚¸ãƒ£ãƒ¼22æšï¼šãƒ•ã‚¡ã‚¤ãƒ«åã¯ä¾‹ã€‚è‡ªåˆ†ã®å‘½åã«åˆã‚ã›ã¦å¤‰æ›´OKï¼‰
  const MAJORS = [
    ['æ„šè€…', '00_fool.jpg',        'è‡ªç”±ã«è¸ã¿å‡ºã™','å¢ƒç•Œã«ç«‹ã¤ã€‚','æœªçŸ¥ã‚’æ€–ã‚Œãªã„ã€‚'],
    ['é­”è¡“å¸«','01_magician.jpg',   'ã„ã¾å§‹ã‚ã‚‹','æ‰‹æœ­ã‚’ä¿¡ã˜ã‚‹ã€‚','è¨€è‘‰ãŒç¾å®Ÿã‚’å‹•ã‹ã™ã€‚'],
    ['å¥³æ•™çš‡','02_priestess.jpg',  'é™ã‹ã«è¦‹æ¥µã‚ã‚‹','å¿ƒã®åº•ã«å…‰ã€‚','æ€¥ãŒãšæ¾„ã¾ã™ã€‚'],
    ['å¥³å¸','03_empress.jpg',      'å—ã‘å–ã‚Šè‚²ã¦ã‚‹','ã‚„ã•ã—ã•ã§æº€ãŸã™ã€‚','å®Ÿã‚Šã‚’æ¥½ã—ã‚€ã€‚'],
    ['çš‡å¸','04_emperor.jpg',      'æ±ºã‚ã¦å‹•ã‹ã™','è»¸ã‚’é€šã™ã€‚','è²¬ä»»ã¯åŠ›ã«ãªã‚‹ã€‚'],
    ['æ•™çš‡','05_hierophant.jpg',   'ä¿¡é ¼ã«å¯„ã‚‹','ã¤ãªãŒã‚Šã«å­¦ã¶ã€‚','ä¼çµ±ãŒè­·ã‚‹ã€‚'],
    ['æ‹äºº','06_lovers.jpg',       'é¸ã³æŠœã','å¿ƒã«æ­£ç›´ã«ã€‚','é¸æŠãŒé“ã«ãªã‚‹ã€‚'],
    ['æˆ¦è»Š','07_chariot.jpg',      'çªç ´ã™ã‚‹','è¿·ã‚ãšé€²ã‚€ã€‚','é›†ä¸­ã¯å‹ã¡ç­‹ã€‚'],
    ['åŠ›','08_strength.jpg',       'å„ªã—ã•ã§åˆ¶ã™','å—å®¹ã¯å‹‡æ°—ã€‚','åŠ›ã¯é™ã‹ã«åƒãã€‚'],
    ['éš è€…','09_hermit.jpg',       'å†…ã«ç¯ã™','ä¸€äººã®æ™‚é–“ã‚’ã€‚','çœŸå®Ÿã¯é™å¯‚ã«ã€‚'],
    ['é‹å‘½ã®è¼ª','10_wheel.jpg',    'æµã‚Œã«ä¹—ã‚‹','å¶ç„¶ã¯åˆå›³ã€‚','æ³¢ã«èº«ä½“ã‚’ä»»ã›ã‚‹ã€‚'],
    ['æ­£ç¾©','11_justice.jpg',      'æ•´ãˆãƒãƒ©ãƒ³ã‚¹','åã‚Šã‚’æˆ»ã™ã€‚','èª å®ŸãŒé€šã‚‹ã€‚'],
    ['åŠã‚‹ã•ã‚ŒãŸç”·','12_hanged.jpg','æ„å‘³ã‚’åè»¢','æ‰‹æ”¾ã—ãŒéµã€‚','ä¾¡å€¤ã¯è¦–ç‚¹ã«å®¿ã‚‹ã€‚'],
    ['æ­»ç¥','13_death.jpg',        'ä¸€åº¦çµ‚ã‚ã‚‰ã›ã‚‹','å¤ã„æ®»ã‚’è„±ãã€‚','å†ç”Ÿã®æº–å‚™ã€‚'],
    ['ç¯€åˆ¶','14_temperance.jpg',   'æ··ãœèª¿å’Œã™ã‚‹','ã»ã©ã‚ˆãã€‚','æµã‚Œã‚’ç¹‹ãã€‚'],
    ['æ‚ªé­”','15_devil.jpg',        'åŸ·ç€ã‚’æ‰‹æ”¾ã™','é–ã¯å¹»ã€‚','æ¬²ã‚’é£¼ã„æ…£ã‚‰ã™ã€‚'],
    ['å¡”','16_tower.jpg',          'å£Šã—ã¦æ›´æ–°','å´©å£Šã¯æµ„åŒ–ã€‚','çœŸå®Ÿã ã‘æ®‹ã‚‹ã€‚'],
    ['æ˜Ÿ','17_star.jpg',           'å¸Œæœ›ã‚’è¦‹ã‚‹','é ãã®å…‰ã‚’ä¿¡ã˜ã‚‹ã€‚','é¡˜ã„ã¯å‹•è©ã€‚'],
    ['æœˆ','18_moon.jpg',           'ä¸å®‰ã‚’è­˜ã‚‹','å½±ã®æ­£ä½“ã‚’è¦‹ã‚‹ã€‚','å¤œã¯æ˜ã‘ã‚‹ã€‚'],
    ['å¤ªé™½','19_sun.jpg',          'å–œã³ã§é€²ã‚€','æ˜ã‚‹ã•ã¯åŠ›ã€‚','å ‚ã€…ã¨ã€‚'],
    ['å¯©åˆ¤','20_judgement.jpg',    'å‘¼ã³è¦šã¾ã™','å†èµ·å‹•ã€‚','åã‚’å‘¼ã³æˆ»ã™ã€‚'],
    ['ä¸–ç•Œ','21_world.jpg',        'å®Œæˆã—æ¬¡ã¸','ä¸€å‘¨å›ã£ã¦å§‹ã¾ã‚Šã€‚','ç¥ç¦ã¨å‡ºç™ºã€‚']
  ];
  /* ======================================================= */

  // å·¥å…·
  const $  = (s,el=document)=>el.querySelector(s);
  const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
  const rand = n => Math.floor(Math.random()*n);

  // è¦ç´ 
  const btnStart = $('#btnStart');
  const btnReset = $('#btnReset');
  const deck     = $('.deck');
  const cards    = $$('.tarot-card', deck);
  const caps     = $$('.cap');
  const ripple   = $('#ripple');
  const resBox   = $('#result');
  const sfxFlip  = $('#sfxFlip');
  const sfxPing  = $('#sfxPing');

  // ã‚­ãƒ£ãƒ³ãƒã‚¹èª¿æ•´
  const fit = () => { ripple.width = ripple.clientWidth; ripple.height = ripple.clientHeight; };
  window.addEventListener('resize', fit, {passive:true}); fit();

  // ç°¡æ˜“ãƒªãƒƒãƒ—ãƒ«
  function rippleAt(x,y){
    const ctx = ripple.getContext('2d');
    const R = Math.max(ripple.width, ripple.height)*0.4;
    let t=0; const dur=420;
    const id = setInterval(()=>{
      t+=16; const p=t/dur; if(p>=1){clearInterval(id); ctx.clearRect(0,0,ripple.width,ripple.height); return;}
      ctx.clearRect(0,0,ripple.width,ripple.height);
      ctx.beginPath();
      ctx.arc(x, y, R*p, 0, Math.PI*2);
      ctx.strokeStyle = `rgba(255,215,111,${1-p})`;
      ctx.lineWidth = 2; ctx.stroke();
    },16);
  }

  // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆè»½é‡ï¼‰
  function shuffle(a){ const n=a.slice(); for(let i=n.length-1;i>0;i--){ const j=rand(i+1); [n[i],n[j]]=[n[j],n[i]] } return n }

  // çŠ¶æ…‹
  let stack = [];         // ã‚·ãƒ£ãƒƒãƒ•ãƒ«çµæœï¼ˆ[name,img,k1,k2,k3]ï¼‰
  let opened = {};        // {1: card, 2: card, 3: card}

  // åˆæœŸåŒ–
  function init(){
    resBox.hidden = true;
    opened = {};
    caps.forEach(c=>c.textContent='');
    cards.forEach(btn=>{
      btn.disabled = true;
      btn.classList.remove('is-flipped');
      // è£é¢å†è¨­å®š
      $('.face-back',btn).style.backgroundImage = `url("${CARD_BACK_URL}")`;
      // è¡¨é¢ã‚¯ãƒªã‚¢
      $('.face-front img',btn).removeAttribute('src');
      $('.face-front img',btn).setAttribute('alt','');
    });
    btnReset.disabled = true;
    btnStart.disabled = false;
  }

  // é–‹å§‹
  function start(){
    const shuf = shuffle(MAJORS);
    stack = shuf.slice(0,3); // 3æšä½¿ã†
    cards.forEach(btn=>btn.disabled=false);
    btnStart.disabled = true;
    btnReset.disabled = false;
  }

  // è¡¨ç¤ºæ›´æ–°
  function showResultIfReady(){
    if(opened[1] && opened[2] && opened[3]){
      resBox.hidden = false;
      for (let i=1;i<=3;i++){
        const [name, , a,b,c] = opened[i];
        $(`.res-title[data-title="${i}"]`).textContent = name;
        $(`.res-text[data-text="${i}"]`).textContent = `${a}ã€‚${b}ã€‚${c}ã€‚`;
      }
      $('#live').textContent = 'ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†ã€‚';
      sfxPing.currentTime=0; sfxPing.play().catch(()=>{});
    }
  }

  // ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚‹
  function flip(slot, btn, e){
    if(opened[slot]) return;
    const card = stack.pop(); if(!card) return;
    opened[slot] = card;

    // è¡¨é¢ç”»åƒã‚’ã‚»ãƒƒãƒˆ
    const img = $('.face-front img', btn);
    img.src = CARD_IMG_BASE + card[1];
    img.alt = card[0];

    // æ˜Ÿç´‹
    const rect = btn.getBoundingClientRect();
    const x = (e?.clientX ?? (rect.left+rect.width/2)) - ripple.getBoundingClientRect().left;
    const y = (e?.clientY ?? (rect.top+rect.height/2))  - ripple.getBoundingClientRect().top;
    rippleAt(x,y);

    // åŠ¹æœéŸ³ï¼‹ãƒ•ãƒªãƒƒãƒ—
    sfxFlip.currentTime=0; sfxFlip.play().catch(()=>{});
    btn.classList.add('is-flipped');

    // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã‚«ãƒ¼ãƒ‰åï¼‰
    $(`.cap[data-cap="${slot}"]`).textContent = card[0];

    // å…¨ã¦é–‹ã„ãŸã‚‰çµæœ
    showResultIfReady();
  }

  // ç›£è¦–
  cards.forEach(btn=>{
    btn.addEventListener('click', (e)=>{ if(!btn.disabled){ flip(btn.dataset.slot, btn, e); } });
  });
  btnStart.addEventListener('click', start);
  btnReset.addEventListener('click', init);

  // åˆå›
  init();
  </script>
</body>
</html>
