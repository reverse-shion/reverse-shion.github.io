<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>詩韻思想 × TAROT BREAKER — 星詠3枚リーディング</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preload" as="image" href="/assets/tarot/back.jpg">
  <link rel="stylesheet" href="/assets/css/style.css">
  <meta name="theme-color" content="#0b0b1a" />
  <style>
    /* --- 念のための衝突回避: 上に覆いかぶさる要素を無効化 --- */
    .hero__media, .hero__veil { pointer-events: none !important; }
  </style>
</head>
<body>

<main class="wrap">

  <!-- 願い（任意） -->
  <section class="wish-head">
    <h1>星詠 3枚リーディング</h1>
    <p class="lead">あなたの願いをひとこと。結果の言葉に織り込みます（空でもOK）</p>
    <label for="wish" class="sr-only">願い</label>
    <input id="wish" class="wish-input" type="text" placeholder="例：もう一度、心から笑えるように">
  </section>

  <!-- ① 束（初期表示） -->
  <section id="deckStage" class="deck-stage" aria-live="polite">
    <div class="deck-stack" aria-label="タロットの束（裏面）">
      <div class="deck-back layer-1"></div>
      <div class="deck-back layer-2"></div>
      <div class="deck-back layer-3"></div>
      <div class="aura"></div>
    </div>

    <div class="controls">
      <button id="dealBtn" class="btn btn--primary" aria-controls="readingArea">タロット展開</button>
      <p class="hint">ボタンを押すと、カードが光に包まれて現れます。</p>
    </div>
  </section>

  <!-- ② 展開後の3枚＆結果 -->
  <section id="readingArea" class="reading-area" hidden>
    <div class="tap-hint" id="tapHint">カードをタップ</div>

    <div class="tarot-row" role="list" aria-label="3枚のカード">
      <!-- JSで .tarot-card * 3 を生成 -->
    </div>

    <canvas id="rippleCanvas" class="ripple" aria-hidden="true"></canvas>

    <div id="result" class="result-grid" aria-live="polite">
      <article class="result-item" data-trinity="詩">
        <span class="badge">詩</span>
        <h3 class="item-title">—</h3>
        <p class="item-text">カードをタップすると、ここに言葉が灯ります。</p>
      </article>
      <article class="result-item" data-trinity="韻">
        <span class="badge">韻</span>
        <h3 class="item-title">—</h3>
        <p class="item-text">カードをタップすると、ここに言葉が灯ります。</p>
      </article>
      <article class="result-item" data-trinity="祈">
        <span class="badge">祈</span>
        <h3 class="item-title">—</h3>
        <p class="item-text">カードをタップすると、ここに言葉が灯ります。</p>
      </article>
    </div>

    <div class="closing" id="closing" hidden>
      <p class="closing-line" id="closingLine"></p>
      <p class="close-text">タロットクローズ。<strong>大丈夫だよ。</strong></p>
      <div class="closing-actions">
        <button id="resetBtn" class="btn">リセット</button>
      </div>
    </div>
  </section>

</main>

<script>
(() => {
  /* ========= 設定 ========= */
  const faces = [
    { name: "The Star（星）",       face: "/assets/tarot/faces/major_17_star.jpg",
      poem: "失われた澄明が、胸の泉に帰る。諦めは古い衣。いま、あなたは静かに光を汲む。" },
    { name: "The Sun（太陽）",       face: "/assets/tarot/faces/major_19_sun.jpg",
      poem: "迷いは影、影は光の証。笑っていい。祝福は、もうここにある。" },
    { name: "Judgement（審判）",   face: "/assets/tarot/faces/major_20_judgement.jpg",
      poem: "古い呼吸を手放し、新しい名で目覚める。赦しは、あなたの中で完了する。" }
  ];

  /* ========= 要素取得（安全ガード付き） ========= */
  const el = {
    deckStage: document.getElementById('deckStage'),
    dealBtn:   document.getElementById('dealBtn'),
    reading:   document.getElementById('readingArea'),
    row:       document.querySelector('.tarot-row'),
    tapHint:   document.getElementById('tapHint'),
    result:    document.getElementById('result'),
    closing:   document.getElementById('closing'),
    closingLine: document.getElementById('closingLine'),
    resetBtn:  null,
    wish:      document.getElementById('wish'),
    ripple:    document.getElementById('rippleCanvas')
  };
  for (const k in el){ if (!el[k]) console.warn('[init warn]', k, 'not found'); }

  let flippedCount = 0;

  /* ========= 小道具 ========= */
  const $ = (q,root=document) => root.querySelector(q);
  const $$ = (q,root=document) => Array.from(root.querySelectorAll(q));

  function createCard(i, data){
    const card = document.createElement('div');
    card.className = 'tarot-card is-back';
    card.role = 'listitem';
    card.dataset.index = i;
    card.setAttribute('tabindex','0');

    const face = document.createElement('div');
    face.className = 'face';
    if (data.face) {
      face.style.setProperty('--face-url', `url('${data.face}')`);
    } else {
      face.classList.add('dummy');
      face.innerHTML = `<div class="glyph">✶</div><div class="title">${data.name}</div>`;
    }

    const rubric = document.createElement('div');
    rubric.className = 'rubric';
    rubric.textContent = ['詩','韻','祈'][i];

    card.appendChild(face);
    card.appendChild(rubric);
    return card;
  }

  function deal(){
    if (!el.deckStage || !el.reading || !el.row) return;

    // 重複起動防止
    el.dealBtn.disabled = true;

    const stack = $('.deck-stack');
    if (stack) stack.classList.add('glow');

    // 束の演出→読み場へ
    setTimeout(() => {
      el.deckStage.hidden = true;
      el.reading.hidden = false;

      // 横並びの3枚を生成
      el.row.innerHTML = '';
      faces.forEach((f,i) => {
        const card = createCard(i, f);
        el.row.appendChild(card);
        requestAnimationFrame(() => {
          setTimeout(() => card.classList.add('show'), 100*i);
        });
      });

      // ヒントON
      el.tapHint.classList.add('on');

      bindCardEvents();
    }, 520);
  }

  function bindCardEvents(){
    $$('.tarot-card', el.row).forEach(card => {
      const onFlip = () => flipCard(card);
      card.addEventListener('click', onFlip);
      card.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onFlip(); }
      });
    });
  }

  function flipCard(card){
    if (card.classList.contains('flipped')) return;

    const i = Number(card.dataset.index);
    const data = faces[i];

    // 裏 → 表
    card.classList.remove('is-back');
    card.classList.add('flipped');

    // 結果描画
    const it = $$('.result-item')[i];
    if (it){
      $('.item-title', it).textContent = data.name;
      $('.item-text',  it).textContent = data.poem;
    }

    flippedCount++;
    if (flippedCount >= 3) onAllRevealed();
  }

  function onAllRevealed(){
    el.tapHint.classList.remove('on');
    const wish = (el.wish?.value || 'あなたの願い').trim();
    el.closingLine.textContent = `「${wish}」は、祈りの円環へと還り、光になる。`;
    el.closing.hidden = false;

    if (!el.resetBtn){
      el.resetBtn = document.getElementById('resetBtn');
      el.resetBtn?.addEventListener('click', resetAll);
    }
  }

  function resetAll(){
    flippedCount = 0;
    el.reading.hidden = true;
    el.deckStage.hidden = false;
    el.dealBtn.disabled = false;
    el.closing.hidden = true;
    el.tapHint.classList.remove('on');
    $$('.result-item').forEach(it => {
      $('.item-title', it).textContent = '—';
      $('.item-text',  it).textContent = 'カードをタップすると、ここに言葉が灯ります。';
    });
  }

  // 起動
  el.dealBtn?.addEventListener('click', deal);
})();
</script>

</body>
</html>
