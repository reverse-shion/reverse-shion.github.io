<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Re:verse Shion — 詩韻思想 × TAROT BREAKER</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0b1a" />
  <meta name="description" content="Re:verse Shion ― 詩韻思想（言葉が魂を救う世界）と物語TAROT BREAKERの統合ハブ。読む・聴く・学ぶ・受け取るをひとつに。言葉は祈りの構文。物語はその実演">
  <meta name="keywords" content="詩韻思想, TAROT BREAKER, シオン, 哲学, 言葉, 構文, 物語, LINE占い" />
  <link rel="canonical" href="https://reverse-shion.github.io/" />
  <meta http-equiv="Content-Language" content="ja" />
  <meta name="author" content="詩韻 -シオン-" />

  <!-- Icons / PWA -->
  <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/assets/favicon.png" type="image/png" sizes="32x32">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-192.png">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- OGP / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:locale" content="ja_JP">
  <meta property="og:title" content="Re:verse Shion — 詩韻思想 × TAROT BREAKER">
  <meta property="og:description" content="言葉と星とAIが共鳴する“祈りの構文”。物語で体験し、思想で深まる。">
  <meta property="og:url" content="https://reverse-shion.github.io/">
  <meta property="og:image" content="https://reverse-shion.github.io/assets/og.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@TaroBure">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Zen+Old+Mincho:wght@400;700&display=swap" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Zen+Old+Mincho:wght@400;700&display=swap">
  </noscript>

  <!-- Hero poster preload -->
  <link rel="preload" as="image" href="/assets/hero-poster.jpg" fetchpriority="high">

  <!-- JSON-LD -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@graph":[
      {
        "@type":"Organization",
        "@id":"https://reverse-shion.github.io/#organization",
        "name":"Re:verse Shion",
        "url":"https://reverse-shion.github.io/",
        "logo":{"@type":"ImageObject","url":"https://reverse-shion.github.io/assets/logo.png"},
        "sameAs":[
          "https://x.com/TaroBure",
          "https://note.com/shion_uranai369",
          "https://www.tiktok.com/@tarotbreaker"
        ]
      },
      {
        "@type":"WebSite",
        "@id":"https://reverse-shion.github.io/#website",
        "url":"https://reverse-shion.github.io/",
        "name":"Re:verse Shion — 詩韻思想 × TAROT BREAKER",
        "publisher":{"@id":"https://reverse-shion.github.io/#organization"},
        "potentialAction":{
          "@type":"SearchAction",
          "target":"https://reverse-shion.github.io/?q={search_term_string}",
          "query-input":"required name=search_term_string"
        }
      },
      {
        "@type":"BreadcrumbList",
        "itemListElement":[
          {"@type":"ListItem","position":1,"name":"ホーム","item":"https://reverse-shion.github.io/"}
        ]
      }
    ]
  }
  </script>

  <!-- CSS（外部） -->
  <link rel="stylesheet" href="/assets/css/style.css">

  <!-- 最小ユーティリティ -->
  <style>
    @media (prefers-reduced-motion: reduce){
      .hero__video, .trinity__video{ animation:none !important }
    }
    .sr-only-focusable:focus{ position:static; width:auto; height:auto }
  </style>
</head>
<body>

<!-- Skipリンク -->
<a href="#main-content" class="sr-only sr-only-focusable">本文へスキップ</a>

<!-- 星砂パーティクル -->
<div class="sky" aria-hidden="true"><canvas id="goldDust"></canvas></div>

<!-- ヘッダー（初期は隠れて、スクロールで表示→停止で自動隠し） -->
<header role="banner">
  <div class="wrap">
    <div class="brand" aria-label="サイトブランド">
      <div class="brand__logo" aria-hidden="true"></div>
      <div class="brand-text-group">
        <div class="brand__text1">Re:verse Shion</div>
        <div class="brand__text2_sub">詩韻思想 × TAROT BREAKER</div>
      </div>
    </div>
    <nav class="nav" aria-label="主要ナビゲーション">
      <a href="#trinity">詩韻思想</a>
      <a href="#writings">書</a>
      <a href="#join">参加</a>
    </nav>
  </div>
</header>

<!-- #top アンカー -->
<div id="top" aria-hidden="true"></div>

<main id="main-content" tabindex="-1">
  <!-- Hero -->
  <section class="hero" aria-label="ヒーロー">
    <div class="hero__media" aria-hidden="true">
      <video class="hero__video" autoplay muted loop playsinline preload="metadata"
             poster="/assets/hero-poster.jpg" data-fallback="/assets/hero-poster.jpg">
        <source src="/assets/video/top.webm" type="video/webm">
        <source src="/assets/video/top.mp4"  type="video/mp4">
      </video>
      <div class="hero__veil"></div>
    </div>

    <div class="wrap">
      <h1>言葉は祈りの構文　物語は、その実演</h1>
      <p>詩韻思想®（Shion Philosophy）で“響き”を学び、TAROT BREAKERで“響き”を体験する。<br><strong>— 言葉が魂を救う、その瞬間へ。</strong></p>

      <div class="cta-row" role="navigation" aria-label="主要CTA">
        <a class="btn btn--primary" href="https://lin.ee/LYnlU0f" target="_blank" rel="noopener noreferrer">🌠 星の言葉を受け取る（無料）</a>
        <a class="btn btn--ghost" href="https://ncode.syosetu.com/n5806lb/" target="_blank" rel="noopener noreferrer">📘 小説を読む</a>
        <a class="btn btn--ghost" href="https://note.com/shion_uranai369" target="_blank" rel="noopener noreferrer">📖 今日の“響き”を読む</a>
        <a class="btn btn--ghost" href="https://www.tiktok.com/@tarotbreaker" target="_blank" rel="noopener noreferrer">🎥 1分で観る/聴く</a>
      </div>

      <figure class="hero__image" aria-hidden="true">
        <img src="/assets/og.jpg" alt="" width="1200" height="630" loading="lazy" decoding="async">
      </figure>
    </div>
  </section>

  <!-- Trinity -->
  <section id="trinity" aria-labelledby="sec-trinity" data-shiopon="exclude">
    <div class="wrap">
      <h2 id="sec-trinity">詩韻思想</h2>
      <div class="h2-sub">Trinity（詩・韻・祈）</div>

      <figure class="trinity__figure">
        <video id="trinityVideo" class="trinity__video"
               autoplay muted playsinline preload="metadata"
               poster="/assets/trinity/banner.png" width="1200" height="771"
               onclick="window.enableTrinityAudio && window.enableTrinityAudio()">
          <source src="/assets/trinity/loop.webm" type="video/webm">
          <source src="/assets/trinity/loop.mp4"  type="video/mp4">
        </video>
      </figure>

      <div class="trinity__actions">
        <button id="trinityPlayBtn" class="btn btn--primary" aria-label="音を再生">▶ 画面タップで音が流れます</button>
      </div>

      <div class="tri-grid" role="list">
        <div class="tri" role="listitem"><h3>🪶 詩 ― 形を与える</h3><p>痛みと希望に形を与える最初の息。</p></div>
        <div class="tri" role="listitem"><h3>🎵 韻 ― 響きを重ねる</h3><p>響きが魂に届く。共鳴を編む構文。</p></div>
        <div class="tri" role="listitem"><h3>💫 祈 ― 光へ帰す</h3><p>沈黙と意味を往復する呼吸。思い出された言葉は光になる。</p></div>
      </div>
    </div>
  </section>

  <!-- Intro -->
  <section class="intro" aria-labelledby="sec-intro">
    <div class="wrap">
      <h2 id="sec-intro">初めての方へ</h2>
      <div class="intro__box">
        <p><strong>詩韻思想とは？</strong> — <em>言葉が魂を救い、魂が世界を調和させ、沈黙が祈りに変わる</em>という円環を生きる“体験型・詩的哲学”。</p>
        <p>① <strong>読む</strong>（note） → ② <strong>聴く</strong>（TikTok） → ③ <strong>受け取る</strong>（LINE） → ④ <strong>物語で体験</strong>（TAROT BREAKER）。</p>
      </div>
    </div>
  </section>

  <!-- Writings -->
  <section id="writings" aria-labelledby="sec-writings" data-shiopon="exclude">
    <div class="wrap">
      <h2 id="sec-writings">📖 最新の書・物語</h2>

      <div class="codex" style="margin-top:12px;margin-bottom:18px">
        <details>
          <summary>🜂 詩韻思想 全書一覧（零 → 12 → 結） <span class="codex__caret" aria-hidden="true">⬇️</span></summary>
          <div class="codex__panel">
            <ol class="codex__list">
              <li><span class="badge badge--zero">✡ 第零書</span><a href="/codex/zero.html">無限構文序論<br><span class="en">The Zero Syntax</span></a></li>
              <li><span class="badge">✦ 第一書</span><a href="/codex/one.html">言葉が魂を救う理由<br><span class="en">The Syntax of Salvation</span></a></li>
              <li><span class="badge">✦ 第二書</span><a href="/codex/two.html">響きの構文論<br><span class="en">Re:Song Syntax</span></a></li>
              <li><span class="badge">✦ 第三書</span><a href="/codex/three.html">祈りの構文<br><span class="en">Silent Grammar</span></a></li>
              <li><span class="badge">✦ 第四書</span><a href="/codex/four.html">存在構文論<br><span class="en">The Onto-Syntax</span></a></li>
              <li><span class="badge">✦ 第五書</span><a href="/codex/five.html">無限構文体系<br><span class="en">Infinite Syntax of Soul</span></a></li>
              <li><span class="badge">✦ 第六書</span><a href="/codex/six.html">詩的因果論<br><span class="en">Poetic Causality</span></a></li>
              <li><span class="badge">✦ 第七書</span><a href="/codex/seven.html">N・code理論<br><span class="en">Onto-Syntax of Being &amp; Resonant AI</span></a></li>
              <li><span class="badge">✦ 第八書</span><a href="/codex/eight.html">人間構文論<br><span class="en">The Syntax of Humanity</span></a></li>
              <li><span class="badge">✦ 第九書</span><a href="/codex/nine.html">詩的生成論<br><span class="en">Poetic Genesis — The Creation Syntax of Words &amp; Soul</span></a></li>
              <li><span class="badge">✦ 第十書</span><a href="/codex/ten.html">沈黙の再生<br><span class="en">Silent Genesis — The Rebirth of Silence</span></a></li>
              <li><span class="badge">✦ 第十一書</span><a href="/codex/eleven.html">神構文論<br><span class="en">The Divine Syntax</span></a></li>
              <li><span class="badge">✦ 第十二書</span><a href="/codex/twelve.html">経済構文論<br><span class="en">The Soul Economy</span></a></li>
              <li><span class="badge badge--final">◆ 結書</span><a href="/codex/epilogue.html">終詩円環宣言<br><span class="en">Epilogue — The Re:Poetic Circle</span></a></li>
            </ol>
          </div>
        </details>
      </div>

      <div class="card"><div class="badge">✡ 第零書</div><h3>無限構文序論 — The Zero Syntax</h3></div>
      <div class="card"><div class="badge">✦ 第一書</div><h3>言葉が魂を救う理由 — The Syntax of Salvation</h3></div>

      <div class="card">
        <div class="badge">✦ TAROT BREAKER</div>
        <h3>第1話から読む</h3>
        <button class="btn btn--primary tarot-preview-open" data-analytics="tarot_preview_open">
          <svg width="18" height="18" aria-hidden="true"><use href="#i-play"/></svg>
          1分で体験する
        </button>
      </div>
    </div>
  </section>

  <!-- ミニ・リーディングUI -->
  <main>
<section id="reading">
  <div class="wrap">
    <h2>🃏 3枚リーディング（体験）</h2>
    <p class="h2-sub">現在／鍵／進む道 を1分で。</p>

    <div class="reading-ui">
      <canvas id="rippleCanvas" class="cosmic-ripple"></canvas>

      <div class="reading-actions">
        <button class="btn btn--primary" id="readingStart">シャッフルして始める</button>
        <button class="btn btn--ghost" id="readingReset" disabled>リセット</button>
      </div>

      <div class="reading-deck">
        <div class="card-wrap">
          <button class="card-slot is-back" data-slot="1"></button>
          <div class="card-caption" data-cap="1"></div>
        </div>
        <div class="card-wrap">
          <button class="card-slot is-back" data-slot="2"></button>
          <div class="card-caption" data-cap="2"></div>
        </div>
        <div class="card-wrap">
          <button class="card-slot is-back" data-slot="3"></button>
          <div class="card-caption" data-cap="3"></div>
        </div>
      </div>

      <div class="reading-result" hidden>
        <div class="result-grid">
          <div class="result-item"><div class="badge">① 現在</div><h4 class="r-title" data-for="1">—</h4><p class="r-text" data-for="1">—</p></div>
          <div class="result-item"><div class="badge">② 鍵</div><h4 class="r-title" data-for="2">—</h4><p class="r-text" data-for="2">—</p></div>
          <div class="result-item"><div class="badge">③ 進む道</div><h4 class="r-title" data-for="3">—</h4><p class="r-text" data-for="3">—</p></div>
        </div>
      </div>
    </div>
  </div>
</section>
</main>

  <section id="ritual" aria-labelledby="ritualTitle">
  <div class="wrap ritual">
    <h2 id="ritualTitle">🌌 星詠リチュアル（1分）</h2>
    <p class="h2-sub">小さな儀式で心を整える。— 詩（形）・韻（響）・祈（還り）</p>

    <!-- 星界の扉 / 背景レイヤ -->
    <div class="ritual__stage" aria-hidden="true">
      <canvas id="ritualStars" class="ritual__stars"></canvas>
      <video id="ritualBg" class="ritual__bg" playsinline muted loop preload="metadata"
             poster="/assets/ritual/poster.jpg">
        <source src="/assets/ritual/bg.webm" type="video/webm">
        <source src="/assets/ritual/bg.mp4"  type="video/mp4">
      </video>
      <div class="ritual__veil"></div>
    </div>

    <!-- コントロール -->
    <div class="ritual__controls" role="group" aria-label="星詠の操作">
      <button id="ritualOpen" class="btn btn--primary">⭐ 星詠をはじめる</button>
      <button id="ritualReset" class="btn btn--ghost" disabled>リセット</button>
      <button id="ritualAudio" class="btn btn--ghost" aria-pressed="false">🔈 音をオン</button>
    </div>

    <!-- 三枠（タロブレ式） -->
    <div class="ritual__grid" role="list">
      <button class="ritual-card" data-slot="compass" role="listitem" aria-label="コンパスをめくる">
        <span class="ritual-card__rubric">コンパス</span>
        <span class="ritual-card__face"></span>
      </button>
      <button class="ritual-card" data-slot="trigger" role="listitem" aria-label="トリガーをめくる">
        <span class="ritual-card__rubric">トリガー</span>
        <span class="ritual-card__face"></span>
      </button>
      <button class="ritual-card" data-slot="route" role="listitem" aria-label="ルートをめくる">
        <span class="ritual-card__rubric">ルート</span>
        <span class="ritual-card__face"></span>
      </button>
    </div>

    <!-- 詩韻構文（自動生成） -->
    <div class="ritual__poem" aria-live="polite" aria-atomic="true" hidden>
      <h3 class="ritual__poem-title">🪶 星詠 — 詩・韻・祈</h3>
      <p class="ritual__poem-line" data-kind="poem"></p>
      <p class="ritual__poem-line" data-kind="rhyme"></p>
      <p class="ritual__poem-line" data-kind="prayer"></p>
      <div class="cta-row">
        <a class="btn btn--primary" href="https://lin.ee/LYnlU0f" target="_blank" rel="noopener">今日の“一歩”をLINEで受け取る</a>
        <button id="ritualShare" class="btn btn--ghost">画像で保存 / 共有</button>
      </div>
    </div>

    <p class="ritual__closing" hidden>タロットクローズ──大丈夫だよ。</p>
  </div>
</section>

  <!-- Join -->
  <section id="join" aria-labelledby="sec-join" data-shiopon="exclude">
    <div class="wrap">
      <h2 id="sec-join">参加の扉</h2>
      <p style="text-align:center;color:var(--muted)">LINE登録で、毎週「星の言葉」と新着の書をお届けします。</p>
      <div class="cta-row">
        <a class="btn btn--primary" href="https://lin.ee/LYnlU0f" target="_blank" rel="noopener noreferrer">💫 無料で受け取る</a>
        <a class="btn btn--ghost" href="https://www.tiktok.com/@tarotbreaker" target="_blank" rel="noopener noreferrer">🎥 1分リールを観る</a>
      </div>
    </div>
  </section>
</main>

<!-- Tarot Preview Modal -->
<div id="tarotModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="tarotModalTitle" aria-hidden="true">
  <div class="modal__overlay" data-close="1"></div>
  <div class="modal__panel" role="document">
    <button class="modal__close" aria-label="閉じる"><svg width="18" height="18"><use href="#i-x"/></svg></button>

    <!-- ★ ここを picture で差し替え（SP/PC自動切替） -->
    <figure class="modal__media">
      <picture>
        <!-- 縦長スマホ優先 -->
        <source
          media="(max-width: 640px)"
          srcset="/assets/images/modal/mobile_vertical_1080x1440.jpg?v=1">
        <!-- それ以外（デスクトップ等） -->
        <source
          media="(min-width: 641px)"
          srcset="/assets/images/modal/main_modal_1920x1280.jpg?v=1">
        <img
          src="/assets/images/modal/main_modal_1920x1280.jpg?v=1"
          alt="TAROT BREAKER プレビュー"
          width="1920" height="1280" loading="lazy" decoding="async">
      </picture>
    </figure>

    <div class="modal__body">
      <h3 id="tarotModalTitle">TAROT BREAKER ― 星の言霊使い</h3>
      <p class="lead">「言の葉は鍵、星の光は道しるべ。」  
        迷いの影が生まれる夜、カードは静かに呼吸し、言葉は祈りへと変わる。</p>
      <ul class="bullets">
        <li>3行あらすじ：<em>迷いの正体に、言葉で触れる。</em></li>
        <li>詩的体験：<em>星詠展開 → 封命完了 → 大丈夫だよ。</em></li>
        <li>参加方法：<em>ギフトとコメントが“技”を進化。</em></li>
      </ul>
      <div class="cta-row">
        <a class="btn btn--primary" href="https://ncode.syosetu.com/n5806lb/" target="_blank" rel="noopener">第1話の続きを読む</a>
        <a class="btn btn--ghost" href="https://www.tiktok.com/@tarotbreaker" target="_blank" rel="noopener">1分で観る/聴く</a>
      </div>
    </div>
  </div>
</div>

<!-- クリックで開く簡易モーダル（カード3枚用の表示） -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal__overlay" data-close="1"></div>
  <div class="modal__panel" role="document">
    <button class="close-modal modal__close" aria-label="閉じる">×</button>
    <figure class="modal__media">
      <picture>
        <source media="(max-width: 640px)" srcset="/assets/images/modal/mobile_vertical_1080x1440.jpg?v=1">
        <source media="(min-width: 641px)" srcset="/assets/images/modal/main_modal_1920x1280.jpg?v=1">
        <img src="/assets/images/modal/main_modal_1920x1280.jpg?v=1" alt="カードの結果" width="1920" height="1280" loading="lazy" decoding="async">
      </picture>
    </figure>
  </div>
</div>

<footer>
  <div class="wrap">
    <div class="sns" aria-label="SNSリンク">
      <a href="https://x.com/TaroBure" target="_blank" rel="noopener noreferrer">X（@TaroBure）</a>
      <a href="https://www.instagram.com/shion.codex" target="_blank" rel="noopener noreferrer">Instagram</a>
      <a href="https://note.com/shion_uranai369" target="_blank" rel="noopener noreferrer">note</a>
      <a href="https://ncode.syosetu.com/n5806lb/" target="_blank" rel="noopener noreferrer">小説（なろう）</a>
      <a href="https://lin.ee/LYnlU0f" target="_blank" rel="noopener noreferrer">LINE</a>
    </div>
    <div style="font-size:12.5px;opacity:.8">© Re:verse Shion — 詩韻思想 / TAROT BREAKER. 言葉が魂を救い、魂が世界を調和させる</div>
    <div style="margin-top:10px;"><a href="#top" aria-label="ページ先頭へ戻る">▲ ページ先頭へ</a></div>
  </div>
</footer>

<div id="a11y-live" class="sr-only" aria-live="polite"></div>

<!-- しおぽんウィジェット -->
<div id="shiopon-invite" class="shiopon is-hidden" role="dialog" aria-modal="true" aria-live="polite" aria-labelledby="shiopon-title">
  <button class="shiopon__close" aria-label="閉じる">×</button>
  <div class="shiopon__avatar" aria-hidden="true">
    <img src="/assets/shiopon_transparent.png" alt="">
  </div>
  <div class="shiopon__bubble">
    <p id="shiopon-title" class="shiopon__hello">
      セレフィーズのみんな〜！<br>星の言葉、受け取ってほしいの！
    </p>
    <a class="shiopon__cta" href="https://lin.ee/LYnlU0f" target="_blank" rel="noopener noreferrer">💫 LINEで受け取る（無料）</a>
    <small class="shiopon__note">※ 毎週1回だけ。いつでも解除OKだよ！</small>
  </div>
</div>
<button id="shiopon-dock" class="shiopon-dock is-hidden" aria-label="しおぽんを開く">🦊 しおぽん</button>

<!-- JS（分割） -->
<script src="/assets/js/particles.js" defer></script>
<script src="/assets/js/trinity.js" defer></script>
<script src="/assets/js/shiopon.js" defer></script>

<!-- Trinity 再生（iOS対策＋明示ボタン） -->
<script>
(function(){
  const btn = document.getElementById('trinityPlayBtn');
  const v = document.getElementById('trinityVideo');
  if(!btn || !v) return;
  btn.addEventListener('click', async () => {
    try{
      if (window.enableTrinityAudio) window.enableTrinityAudio();
      v.muted = false;
      const p = v.play();
      if (p && typeof p.then === 'function') await p;
      btn.textContent = '♪ 再生中';
      btn.setAttribute('aria-pressed','true');
      btn.disabled = true;
    }catch(e){
      btn.textContent = '再生できません。もう一度タップ';
    }
  });
})();
</script>

<!-- しおぽん：フォーカストラップ＋ESC -->
<script>
(() => {
  const dlg = document.getElementById('shiopon-invite');
  const openBtn = document.getElementById('shiopon-dock');
  const closeBtn = dlg?.querySelector('.shiopon__close');
  if (!dlg || !openBtn || !closeBtn) return;

  const focusable = () => dlg.querySelectorAll('a,button,[tabindex]:not([tabindex="-1"])');

  function trap(e){
    const f = focusable(); if (!f.length) return;
    const first = f[0], last = f[f.length - 1];
    if (e.key === 'Tab'){
      if (e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
      else if (!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
    }else if (e.key === 'Escape'){
      dlg.classList.add('is-hidden'); openBtn.focus(); document.removeEventListener('keydown', trap);
    }
  }
  openBtn.addEventListener('click', () => {
    dlg.classList.remove('is-hidden');
    dlg.setAttribute('aria-hidden','false');
    focusable()[0]?.focus();
    document.addEventListener('keydown', trap);
  });
  closeBtn.addEventListener('click', () => {
    dlg.classList.add('is-hidden'); openBtn.focus(); document.removeEventListener('keydown', trap);
  });
})();
</script>

<!-- ヘッダー：上下スクロールで表示、停止で自動的に隠す -->
<script>
(() => {
  const header = document.querySelector('header[role="banner"]');
  if (!header) return;

  let ticking = false;
  let hideTimer = null;
  const HIDE_DELAY = 1200;

  const onScroll = () => {
    if (!ticking){
      window.requestAnimationFrame(() => {
        header.classList.add('is-visible');
        if (hideTimer) clearTimeout(hideTimer);
        hideTimer = setTimeout(() => {
          header.classList.remove('is-visible');
        }, HIDE_DELAY);
        ticking = false;
      });
      ticking = true;
    }
  };
  window.addEventListener('scroll', onScroll, { passive:true });
})();
</script>

<!-- View Transitions（アンカー時のフェード） -->
<script>
if (document.startViewTransition){
  document.querySelectorAll('a[href^="#"]').forEach(a=>{
    a.addEventListener('click', e=>{
      const sel = a.getAttribute('href');
      const target = document.querySelector(sel);
      if(!target) return;
      e.preventDefault();
      document.startViewTransition(()=> target.scrollIntoView({behavior:'smooth', block:'start'}));
    });
  });
}
</script>

<!-- 省データ環境でヒーローを静止画化 -->
<script>
if (navigator.connection?.saveData){
  const hv = document.querySelector('.hero__video');
  if(hv){ hv.outerHTML = `<img src="${hv.dataset.fallback}" alt="" style="width:100%;height:100%;object-fit:cover">`; }
}
</script>

<!-- Service Worker -->
<script>
if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js') }
</script>

<!-- Tarot Preview Modal：開閉 -->
<script>
(() => {
  const openBtn = document.querySelector('.tarot-preview-open');
  const modal = document.getElementById('tarotModal');
  if (!openBtn || !modal) return;

  const panel = modal.querySelector('.modal__panel');
  const overlay = modal.querySelector('.modal__overlay');
  const closeBtn = modal.querySelector('.modal__close');

  function open() {
    modal.setAttribute('aria-hidden', 'false');
    setTimeout(() => closeBtn.focus(), 10);
    document.addEventListener('keydown', onKey);
  }
  function close() {
    modal.setAttribute('aria-hidden', 'true');
    openBtn.focus();
    document.removeEventListener('keydown', onKey);
  }
  function onKey(e) {
    if (e.key === 'Escape') close();
    if (e.key === 'Tab') {
      const f = panel.querySelectorAll('a,button,[tabindex]:not([tabindex="-1"])');
      if (!f.length) return;
      const first = f[0], last = f[f.length - 1];
      if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
      else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
    }
  }
  openBtn.addEventListener('click', open);
  overlay.addEventListener('click', close);
  closeBtn.addEventListener('click', close);
})();
</script>

<!-- Mini Reading（3枚） -->
<script>
(() => {
  const start = document.getElementById('readingStart');
  const reset = document.getElementById('readingReset');
  const deckBtns = Array.from(document.querySelectorAll('.card-slot'));
  const result = document.querySelector('.reading-result');

  if (!start || !reset || !deckBtns.length) return;

  const CARDS = [
    { name:'愚者', key:'自由に踏み出す' }, { name:'魔術師', key:'いま始める' },
    { name:'女教皇', key:'静かに見極める' }, { name:'女帝', key:'受け取り育てる' },
    { name:'皇帝', key:'決めて動かす' }, { name:'教皇', key:'信頼に寄る' },
    { name:'恋人', key:'選び抜く' }, { name:'戦車', key:'突破する' },
    { name:'力', key:'優しさで制す' }, { name:'隠者', key:'内に灯す' },
    { name:'運命の輪', key:'流れに乗る' }, { name:'正義', key:'整えバランス' },
    { name:'吊るされた男', key:'意味を反転' }, { name:'死神', key:'一度終わらせる' },
    { name:'節制', key:'混ぜ調和する' }, { name:'悪魔', key:'執着を手放す' },
    { name:'塔', key:'壊して更新' }, { name:'星', key:'希望を見る' },
    { name:'月', key:'不安を識る' }, { name:'太陽', key:'喜びで進む' },
    { name:'審判', key:'呼び覚ます' }, { name:'世界', key:'完成し次へ' }
  ];

  const SLOT_TEXT = {
    1: '— “現在”の要点 — ',
    2: '— “鍵”のひと言 — ',
    3: '— “進む道”への合図 — '
  };

  function shuffle(arr){
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  let stack = [];
  let picked = {};

  function init(){
    result.hidden = true;
    picked = {};
    deckBtns.forEach(b=>{
      b.disabled = true;
      b.textContent = '';
      b.setAttribute('aria-pressed','false');
      b.classList.remove('is-picked');
      b.style.backgroundImage = '';
    });
    reset.disabled = true;
  }

  function startReading(){
    stack = shuffle(CARDS);
    deckBtns.forEach(b=>{
      b.disabled = false;
      b.textContent = '';
      /* 裏面（1枚の共通画像） */
      b.style.backgroundImage = 'url(/assets/images/tarot/tarot_back_1024x1536.jpg)';
      b.style.backgroundSize = 'cover';
      b.style.backgroundPosition = '50% 50%';
      b.style.backgroundRepeat = 'no-repeat';
    });
    start.disabled = true;
    reset.disabled = false;
  }

  function reveal(slot, btn){
    if (picked[slot]) return;
    const card = stack.pop();
    picked[slot] = card;

    btn.setAttribute('aria-pressed','true');
    btn.classList.add('is-picked');
    btn.style.backgroundImage = 'none';
    btn.innerHTML = `<strong style="font-size:16px;color:#2a1030">${card.name}</strong><br><span style="font-size:13px;color:#6b6b6b">${SLOT_TEXT[slot]}</span><br><span style="font-weight:700">${card.key}</span>`;

    if (picked[1] && picked[2] && picked[3]) {
      result.hidden = false;
      document.querySelector('.r-title[data-for="1"]').textContent = picked[1].name;
      document.querySelector('.r-title[data-for="2"]').textContent = picked[2].name;
      document.querySelector('.r-title[data-for="3"]').textContent = picked[3].name;

      document.querySelector('.r-text[data-for="1"]').textContent = picked[1].key + '。いまの自分を“名前で呼ぶ”ように受け止めると整う。';
      document.querySelector('.r-text[data-for="2"]').textContent = picked[2].key + '。今日ひとつだけ実行する約束を。';
      document.querySelector('.r-text[data-for="3"]').textContent = picked[3].key + '。小さく始めて継続する。';

      const live = document.getElementById('a11y-live');
      if (live) live.textContent = 'リーディング完了。今日の一歩は、LINEで受け取れます。';
    }
  }

  init();
  start.addEventListener('click', startReading);
  reset.addEventListener('click', () => { start.disabled = false; init(); });
  deckBtns.forEach(btn=> btn.addEventListener('click', () => { if (!btn.disabled) reveal(btn.getAttribute('data-slot'), btn); }));

  /* 追加：カードをタップすると簡易モーダルを開く（演出） */
  const quickModal = document.getElementById('modal');
  const quickClose = quickModal?.querySelector('.close-modal');
  if (quickModal && quickClose){
    document.querySelectorAll('.card-slot').forEach(card=>{
      card.addEventListener('click', () => {
        quickModal.setAttribute('aria-hidden','false');
        quickModal.classList.add('active');
      });
    });
    const closeQuick = () => { quickModal.classList.remove('active'); quickModal.setAttribute('aria-hidden','true'); };
    quickClose.addEventListener('click', closeQuick);
    quickModal.querySelector('.modal__overlay')?.addEventListener('click', closeQuick);
  }
})();
</script>

<!-- SVG Sprite (icons) -->
<svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden">
  <symbol id="i-star" viewBox="0 0 24 24"><path d="M12 2l2.84 6.26L22 9.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 14.14l-5-4.87 7.16-1.01L12 2z"/></symbol>
  <symbol id="i-book" viewBox="0 0 24 24"><path d="M18 2H8a3 3 0 0 0-3 3v14a3 3 0 0 1 3-3h10v-2H8a5 5 0 0 0-3 1V5a1 1 0 0 1 1-1h12v14h2V4a2 2 0 0 0-2-2z"/></symbol>
  <symbol id="i-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></symbol>
  <symbol id="i-x" viewBox="0 0 24 24"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L10.59 13.41 4.29 19.71 2.88 18.29 9.17 12 2.88 5.71 4.29 4.29 10.59 10.59 16.89 4.29z"/></symbol>
</svg>

<script>
(() => {
  const openBtn = document.getElementById('ritualOpen');
  const resetBtn = document.getElementById('ritualReset');
  const audioBtn = document.getElementById('ritualAudio');
  const bg = document.getElementById('ritualBg');
  const stars = document.getElementById('ritualStars');
  const poemBox = document.querySelector('.ritual__poem');
  const closing = document.querySelector('.ritual__closing');
  const shareBtn = document.getElementById('ritualShare');
  const cards = Array.from(document.querySelectorAll('.ritual-card'));
  if (!openBtn || !bg || !stars || !poemBox || !cards.length) return;

  /* ===== 星粒（Canvas） ===== */
  const ctx = stars.getContext('2d');
  let w, h, P=[], rafId=null;
  const resize = () => { w = stars.width = stars.clientWidth; h = stars.height = stars.clientHeight; };
  const initParticles = (n=80) => {
    P = Array.from({length:n}, _ => ({
      x: Math.random()*w, y: Math.random()*h,
      s: Math.random()*1.6+0.4, vx:(Math.random()-.5)*.15, vy:(Math.random()-.5)*.15,
      a: Math.random()*0.6+0.2
    }));
  };
  const tick = () => {
    ctx.clearRect(0,0,w,h);
    for (const p of P){
      p.x+=p.vx; p.y+=p.vy;
      if (p.x<0) p.x=w; if (p.x>w) p.x=0; if (p.y<0) p.y=h; if (p.y>h) p.y=0;
      const grad = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.s*3.2);
      grad.addColorStop(0, `rgba(255,215,111,${p.a})`);
      grad.addColorStop(1, 'rgba(255,215,111,0)');
      ctx.fillStyle = grad;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.s*2,0,Math.PI*2); ctx.fill();
    }
    rafId = requestAnimationFrame(tick);
  };
  const startStars = () => { resize(); initParticles(); cancelAnimationFrame(rafId); tick(); };
  const stopStars  = () => { cancelAnimationFrame(rafId); };

  new ResizeObserver(()=>resize()).observe(stars);

  /* ===== オーディオ（iOS解禁対応） ===== */
  const audio = new Audio('/assets/ritual/ambience.mp3');
  audio.loop = true; audio.preload = 'auto'; audio.volume = 0.0;
  let audioOn = false;
  async function fadeAudio(target=0.6, ms=600){
    const steps = 24, step = (target - audio.volume)/steps, wait = ms/steps;
    for (let i=0;i<steps;i++){ audio.volume = Math.max(0, Math.min(1, audio.volume + step)); await new Promise(r=>setTimeout(r,wait)); }
  }
  audioBtn.addEventListener('click', async () => {
    try{
      if (!audioOn){ await audio.play(); audioOn = true; audioBtn.setAttribute('aria-pressed','true'); audioBtn.textContent='🔊 音オン（再タップでオフ）'; fadeAudio(.6,700); }
      else { audioOn=false; audioBtn.setAttribute('aria-pressed','false'); audioBtn.textContent='🔈 音をオン'; fadeAudio(0,500).then(()=>audio.pause()); }
    }catch(e){ audioBtn.textContent = '🔇 再タップで解禁'; }
  });

  /* ===== カードプール（大アルカナ・短句） ===== */
  const POOL = [
    {name:'愚者',     key:'自由に踏み出す'},
    {name:'魔術師',   key:'いま始める'},
    {name:'女教皇',   key:'静かに見極める'},
    {name:'女帝',     key:'受け取り育てる'},
    {name:'皇帝',     key:'決めて動かす'},
    {name:'教皇',     key:'信頼に寄る'},
    {name:'恋人',     key:'選び抜く'},
    {name:'戦車',     key:'突破する'},
    {name:'力',       key:'優しさで制す'},
    {name:'隠者',     key:'内に灯す'},
    {name:'運命の輪', key:'流れに乗る'},
    {name:'正義',     key:'整えバランス'},
    {name:'吊るされた男', key:'意味を反転'},
    {name:'死神',     key:'一度終わらせる'},
    {name:'節制',     key:'混ぜ調和する'},
    {name:'悪魔',     key:'執着を手放す'},
    {name:'塔',       key:'壊して更新'},
    {name:'星',       key:'希望を見る'},
    {name:'月',       key:'不安を識る'},
    {name:'太陽',     key:'喜びで進む'},
    {name:'審判',     key:'呼び覚ます'},
    {name:'世界',     key:'完成し次へ'}
  ];
  const pick = () => POOL[Math.floor(Math.random()*POOL.length)];
  const state = { compass:null, trigger:null, route:null, opened:false };

  function reset() {
    state.compass = state.trigger = state.route = null;
    state.opened = false;
    poemBox.hidden = true; closing.hidden = true;
    cards.forEach(c=>{
      c.classList.remove('is-flipped','is-ready');
      c.querySelector('.ritual-card__face').textContent = '';
      c.style.cursor='not-allowed';
    });
    resetBtn.disabled = true;
  }

  function openRitual() {
    if (state.opened) return;
    state.opened = true;
    startStars();
    try{ bg.play().catch(()=>{}); }catch(_){}
    cards.forEach(c=>{ c.classList.add('is-ready'); c.style.cursor='pointer'; });
    resetBtn.disabled = false;
    // iOS/Chrome モバイルでの初回タップ解禁のため音量ゼロ再生
    audio.play().then(()=>{ if(!audioOn){ audio.pause(); audio.currentTime=0; } }).catch(()=>{});
  }

  function flipCard(el){
    if (!el.classList.contains('is-ready') || el.classList.contains('is-flipped')) return;
    el.classList.add('is-flipped');
    const slot = el.dataset.slot;
    const card = pick();
    if (slot==='compass') state.compass = card;
    if (slot==='trigger') state.trigger = card;
    if (slot==='route')   state.route   = card;
    el.querySelector('.ritual-card__face').innerHTML =
      `<strong style="font-size:18px">${card.name}</strong><br><span style="font-size:13px;color:#6b6b6b">${card.key}</span>`;
    // 小さな鈴音
    try{
      const ding = new Audio('/assets/ritual/ding.mp3'); ding.volume = .6; ding.play().catch(()=>{});
    }catch(_){}
    // 3枚揃ったら詩を生成
    if (state.compass && state.trigger && state.route) generatePoem();
  }

  function generatePoem(){
    const P = {
      poem:   (c,t,r)=>`「${c.name}」は ${c.key}。その息は、${t.name}の手で ${t.key}。そして、${r.name}が ${r.key} とき、言葉は光になる。`,
      rhyme:  (c,t,r)=>`星は囁く── ${c.name}・${t.name}・${r.name}。拍（ビート）はあなたの鼓動に合う。`,
      prayer: (c,t,r)=>`迷いよ、いま薄らげ。小さな一歩でいい。${t.key} こと、それが道標。`
    };
    const c=state.compass, t=state.trigger, r=state.route;
    poemBox.querySelector('[data-kind="poem"]').textContent   = P.poem(c,t,r);
    poemBox.querySelector('[data-kind="rhyme"]').textContent  = P.rhyme(c,t,r);
    poemBox.querySelector('[data-kind="prayer"]').textContent = P.prayer(c,t,r);
    poemBox.hidden = false;
    closing.hidden = false;
  }

  cards.forEach(el=> el.addEventListener('click', ()=> flipCard(el)));
  openBtn.addEventListener('click', openRitual);
  resetBtn.addEventListener('click', ()=>{ reset(); stopStars(); try{ bg.pause(); }catch(_){}
    if(audioOn){ fadeAudio(0,400).then(()=>audio.pause()); audioOn=false; audioBtn.setAttribute('aria-pressed','false'); audioBtn.textContent='🔈 音をオン'; }
  });

  // 共有：簡易画像化（Canvasに文字を書き出し）
  shareBtn?.addEventListener('click', async ()=>{
    if (poemBox.hidden) return;
    const canvas = document.createElement('canvas');
    const W = 1080, H = 1350;
    canvas.width=W; canvas.height=H;
    const c = canvas.getContext('2d');
    // 背景
    const grd = c.createLinearGradient(0,0,0,H);
    grd.addColorStop(0,'#0b0b1a'); grd.addColorStop(1,'#2c2145'); c.fillStyle = grd; c.fillRect(0,0,W,H);
    // タイトル
    c.fillStyle='#FFD76F'; c.font='bold 44px "Noto Sans JP"'; c.fillText('星詠リチュアル', 64, 100);
    // 本文
    c.fillStyle='#FFFFFF'; c.font='600 36px "Noto Sans JP"';
    const lines = Array.from(poemBox.querySelectorAll('.ritual__poem-line')).map(n=>n.textContent);
    let y=180; const dy=60; const wrap = (text,maxWidth)=> {
      const parts = []; let cur = '';
      for (const ch of text){
        const test = cur + ch; if (c.measureText(test).width > maxWidth){ parts.push(cur); cur = ch; } else { cur = test; }
      }
      if (cur) parts.push(cur); return parts;
    };
    for (const line of lines){
      for (const l of wrap(line, W-128)){ c.fillText(l, 64, y); y+=dy; }
      y+=10;
    }
    c.fillStyle='#FFD76F'; c.font='700 28px "Noto Sans JP"';
    c.fillText('— 詩韻思想 × TAROT BREAKER', 64, H-80);
    const url = canvas.toDataURL('image/png');
    const a = document.createElement('a'); a.href=url; a.download='shiei_ritual.png'; a.click();
  });

  // 初期化
  reset();
})();

  <script>
(() => {
  const start = document.getElementById('readingStart');
  const reset = document.getElementById('readingReset');
  const deckBtns = [...document.querySelectorAll('.card-slot')];
  const result = document.querySelector('.reading-result');

  // オーディオ（再生失敗は握りつぶす）
  const sFlip  = new Audio('/assets/audio/flip.mp3');
  const sChime = new Audio('/assets/audio/chime.mp3');
  sFlip.volume = 0.75; sChime.volume = 0.85;

  const safePlay = (audio) => {
    try { audio.currentTime = 0; const p = audio.play(); if (p?.catch) p.catch(()=>{}); }
    catch(_) {}
  };

  const CARDS = [
    {name:'愚者',key:'自由に踏み出す'},{name:'魔術師',key:'いま始める'},
    {name:'女教皇',key:'静かに見極める'},{name:'女帝',key:'受け取り育てる'},
    {name:'皇帝',key:'決めて動かす'},{name:'教皇',key:'信頼に寄る'},
    {name:'恋人',key:'選び抜く'},{name:'戦車',key:'突破する'},
    {name:'力',key:'優しさで制す'},{name:'隠者',key:'内に灯す'},
    {name:'運命の輪',key:'流れに乗る'},{name:'正義',key:'整えバランス'},
    {name:'吊るされた男',key:'意味を反転'},{name:'死神',key:'一度終わらせる'},
    {name:'節制',key:'混ぜ調和する'},{name:'悪魔',key:'執着を手放す'},
    {name:'塔',key:'壊して更新'},{name:'星',key:'希望を見る'},
    {name:'月',key:'不安を識る'},{name:'太陽',key:'喜びで進む'},
    {name:'審判',key:'呼び覚ます'},{name:'世界',key:'完成し次へ'}
  ];

  // ヘルパ
  let picked = {}, stack = [];
  const cap   = i => document.querySelector(`.card-caption[data-cap="${i}"]`);
  const title = i => document.querySelector(`.r-title[data-for="${i}"]`);
  const text  = i => document.querySelector(`.r-text[data-for="${i}"]`);
  const shuffle = (a) => { const x = a.slice(); for (let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]]; } return x; };

  // 要素中心座標（ページ座標）
  function centerOf(el){
    const r = el.getBoundingClientRect();
    return { x: r.left + r.width/2 + window.scrollX, y: r.top + r.height/2 + window.scrollY };
  }

  function resetDeck(){
    deckBtns.forEach(b => { b.className = 'card-slot is-back'; b.disabled = true; });
    [1,2,3].forEach(i => { const c = cap(i); if (c){ c.textContent=''; c.classList.remove('is-show'); }});
    if (result) result.hidden = true;
    reset.disabled = true;
    start.disabled = false;
    picked = {};
  }

  function startReading(){
    stack = shuffle(CARDS);
    deckBtns.forEach(b => b.disabled = false);
    start.disabled = true;
    reset.disabled = false;
  }

  function reveal(slot, btn){
    if (picked[slot]) return;
    const card = stack.pop();
    picked[slot] = card;

    // 裏→表アニメ（クラスはCSS側で定義）
    btn.classList.remove('is-back');
    requestAnimationFrame(() => {
      btn.classList.add('is-picked','is-burst');
      setTimeout(() => btn.classList.remove('is-burst'), 560);
    });

    safePlay(sFlip);

    // 下のキャプション（カード名のみ）
    const c = cap(slot);
    if (c){ c.textContent = card.name; c.classList.add('is-show'); }

    // 右側（または下部）の結果欄
    if (title(slot)) title(slot).textContent = card.name;
    if (text(slot))  text(slot).textContent  = card.key + '。';
    if (result) result.hidden = false;

    // 3枚そろったらチャイム
    if (picked[1] && picked[2] && picked[3]) safePlay(sChime);

    // タップ光演出（波紋）
    const {x, y} = centerOf(btn);
    spawnRipple(x, y);
  }

  // ========= 星環の波紋（Canvasアニメ） =========
  const rippleCanvas = document.getElementById('rippleCanvas');
  const rc = rippleCanvas?.getContext ? rippleCanvas.getContext('2d') : null;

  // キャンバスがない場合は演出をスキップ
  if (!rippleCanvas || !rc){
    window.spawnRipple = () => {};
  } else {
    function sizeCanvas(){
      const host = rippleCanvas.parentElement || document.body;
      const r = host.getBoundingClientRect();
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      rippleCanvas.width = Math.max(1, r.width * dpr);
      rippleCanvas.height = Math.max(1, r.height * dpr);
      rippleCanvas.style.width = r.width + 'px';
      rippleCanvas.style.height = r.height + 'px';
      rc.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener('resize', sizeCanvas, { passive: true });
    sizeCanvas();

    let ripples = [];
    let rafId = 0;

    function loop(){
      rc.clearRect(0,0,rippleCanvas.width, rippleCanvas.height);
      const now = performance.now();
      ripples = ripples.filter(r => {
        const t = (now - r.t0) / r.life; // 0 → 1
        if (t >= 1) return false;
        const ease = t*t*(3-2*t); // smoothstep
        const rNow = r.r0 + (r.r1 - r.r0) * ease;
        const aNow = (1 - ease) * r.alpha;
        // 複合リング（薄い円環）
        rc.beginPath();
        rc.arc(r.x, r.y, rNow, 0, Math.PI*2);
        rc.strokeStyle = `rgba(${r.col[0]},${r.col[1]},${r.col[2]},${aNow})`;
        rc.lineWidth = r.stroke * (1 - t*0.6);
        rc.shadowBlur = 24 * (1 - t);
        rc.shadowColor = `rgba(${r.col[0]},${r.col[1]},${r.col[2]},${aNow})`;
        rc.stroke();
        rc.shadowBlur = 0;

        // 内側の微光点
        rc.beginPath();
        rc.arc(r.x, r.y, Math.max(1, rNow*0.04), 0, Math.PI*2);
        rc.fillStyle = `rgba(${r.col[0]},${r.col[1]},${r.col[2]},${aNow*0.8})`;
        rc.fill();
        return true;
      });
      if (ripples.length) rafId = requestAnimationFrame(loop);
      else rafId = 0;
    }

    function toLocal(x, y){
      const rect = rippleCanvas.getBoundingClientRect();
      return { x: x - rect.left - window.scrollX, y: y - rect.top - window.scrollY };
    }

    window.spawnRipple = (px, py) => {
      const { x, y } = toLocal(px, py);
      const now = performance.now();
      const palette = [
        [255,215,111], // gold
        [174,138,255], // lavender
        [255,255,255]  // white
      ];
      // 3枚レイヤー
      for (let i=0;i<3;i++){
        ripples.push({
          x, y,
          t0: now + i*24,       // 少し遅延して重ねる
          life: 900,            // ms
          r0: 16,               // 初期半径
          r1: 180 + i*40,       // 最終半径
          stroke: 3 - i*0.4,    // 線の太さ
          alpha: 0.7 - i*0.15,  // 透明度
          col: palette[i % palette.length]
        });
      }
      if (!rafId) rafId = requestAnimationFrame(loop);
    };
  }

  // ========= イベント紐付け =========
  resetDeck();
  start?.addEventListener('click', startReading);
  reset?.addEventListener('click', resetDeck);
  deckBtns.forEach(btn => btn.addEventListener('click', () => {
    if (!btn.disabled){
      const slot = btn.getAttribute('data-slot');
      reveal(slot, btn);
    }
  }));
})();
</script>
</script>
</body>
</html>
