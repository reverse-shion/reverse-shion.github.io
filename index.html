<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TAROT BREAKER â€” é¡˜ã„å±•é–‹ Ã— æ˜Ÿç´‹ Ã— è© å”±</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Noto+Sans+JP:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --deep:#0b0b1a; --ink:#eceaff; --gold:#ffd76f; --accent:#7e66ff; --r:16px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  min-height:100vh; background: radial-gradient(1200px 500px at 50% -10%, #1e1b38 0%, #0b0b1a 60%, #050510 100%);
  color:var(--ink); font-family:'Noto Sans JP',sans-serif; line-height:1.85; padding:24px; display:flex; align-items:center; justify-content:center;
}
.app{max-width:1024px; width:100%}
h1{font-family:'Cormorant Garamond',serif; letter-spacing:.04em; color:var(--gold); font-size:clamp(28px,4.2vw,46px); text-align:center}
.sub{opacity:.75; text-align:center; margin:.25rem 0 1.25rem}
.panel{
  position:relative; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.1);
  border-radius:20px; padding:18px; backdrop-filter: blur(6px); overflow:hidden;
}

/* å…¥åŠ›è¡Œ */
.wishbar{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:4px 0 10px}
.wishbar textarea{
  width:min(720px,100%); min-height:64px; border:1px solid rgba(255,255,255,.2); border-radius:14px;
  background:rgba(255,255,255,.05); color:#fff; padding:12px 14px; font-size:1rem; outline:none;
}
.controls{display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin:.25rem 0 1rem}
button{
  appearance:none; border:none; padding:.82rem 1.5rem; border-radius:999px; font-weight:700; cursor:pointer; transition:.25s;
  background:var(--accent); color:white; box-shadow:0 6px 20px rgba(126,102,255,.25);
}
button.secondary{background:#2a2940}
button.ghost{background:transparent; border:1px solid rgba(255,255,255,.25)}
button:hover{transform:translateY(-2px); filter:brightness(1.09)}
button:disabled{opacity:.5; cursor:not-allowed; transform:none; filter:none}

/* ãƒ‡ãƒƒã‚­ï¼ã‚«ãƒ¼ãƒ‰ */
.deck-area{
  display:grid; grid-template-columns: repeat(7, minmax(70px, 1fr)); gap:12px; justify-items:center; margin:10px auto; max-width:880px;
  min-height:230px; position:relative;
}
.card{
  width:120px; height:200px; position:relative; transform-style:preserve-3d; transition:transform 900ms cubic-bezier(.2,.8,.2,1), box-shadow .3s;
  border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.45);
}
.card.is-mini{width:70px; height:115px; border-radius:10px}
.card .face{position:absolute; inset:0; backface-visibility:hidden; border-radius:inherit; overflow:hidden}
.card .front{transform:rotateY(180deg); background:#fff}
.card .front img{width:100%; height:100%; object-fit:cover}
.card .back{display:grid; place-items:center; color:var(--gold); letter-spacing:.2em; font-weight:700;
  background: conic-gradient(from 0deg, #191738, #332d68, #191738);
}
.card.flipped{transform:rotateY(180deg)}

/* ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
.result{
  margin:16px 0 8px; opacity:0; transform: translateY(6px); transition:.6s;
  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:16px;
}
.result.show{opacity:1; transform:none}
.result h3{font-family:'Cormorant Garamond',serif; color:var(--gold); font-size:22px; margin-bottom:.25rem}
.result p{margin:.25rem 0}
.small{font-size:.92rem; opacity:.85}
.kicker{font-style:italic; color:#d9d5ff; text-align:center; margin-top:6px}
.footer-actions{display:flex; gap:10px; justify-content:center; margin-top:10px}

/* æ˜Ÿç´‹ï¼ˆã‚¯ãƒªãƒƒã‚¯æ³¢ç´‹ï¼‰ */
.sigil{
  position:absolute; pointer-events:none; width:12px; height:12px; left:0; top:0; transform:translate(-50%,-50%) scale(1);
  opacity:.9; filter:drop-shadow(0 0 12px rgba(255,215,111,.6));
  animation: sigil-expand .9s ease-out forwards;
}
@keyframes sigil-expand{
  0%{transform:translate(-50%,-50%) scale(.2); opacity:.0}
  10%{opacity:1}
  70%{opacity:.9}
  100%{transform:translate(-50%,-50%) scale(18); opacity:0}
}
/* ä¸­èº«ã¯SVGæ˜Ÿã‚’ä½¿ã† */
.sigil svg{display:block; width:100%; height:100%}

/* è© å”±ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ï¼‰ */
#chant{
  position:absolute; left:0; right:0; bottom:-140px; padding:14px 16px; text-align:center;
  background: linear-gradient(180deg, rgba(10,8,28,.0), rgba(10,8,28,.55));
  color:#efeaff; font-family:'Cormorant Garamond',serif; letter-spacing:.04em;
  transition: transform .85s cubic-bezier(.17,.9,.24,1), opacity .85s; transform: translateY(100px); opacity:0;
}
#chant.show{transform: translateY(0px); opacity:1; bottom:0}
#chant .spell{font-size:clamp(18px,3.2vw,28px)}
#chant .wish{opacity:.85; font-size:.95rem; margin-top:4px}
.badge{display:inline-block; border:1px solid rgba(255,215,111,.35); color:var(--gold); padding:.2rem .6rem; border-radius:999px; font-size:.8rem; margin-left:.5rem}
</style>
</head>
<body>
<div class="app">
  <h1>TAROT BREAKER<span class="badge">é¡˜ã„å±•é–‹</span></h1>
  <p class="sub">é¡˜ã„ã‚’è¨€è‘‰ã« â†’ ã‚¿ãƒ­ãƒƒãƒˆå±•é–‹ â†’ æ˜Ÿç´‹ï¼ˆã‚¿ãƒƒãƒ—æ³¢ç´‹ï¼‰ â†’ 3æšè‡ªå‹•ã‚ªãƒ¼ãƒ—ãƒ³ â†’ è© å”±ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ â†’ ã‚¯ãƒ­ãƒ¼ã‚ºï¼ãƒªã‚»ãƒƒãƒˆ</p>

  <div class="panel" id="panel">
    <!-- é¡˜ã„å…¥åŠ› -->
    <div class="wishbar">
      <textarea id="wish" placeholder="ä¾‹ï¼šå¿ƒã®å¹³ç©ãŒæ¬²ã—ã„â€¦ æ„›ã™ã‚‹äººã¨ã®çµ†ã‚’æ·±ã‚ãŸã„â€¦"></textarea>
    </div>

    <!-- æ“ä½œ -->
    <div class="controls">
      <button id="btnStart">ã‚¿ãƒ­ãƒƒãƒˆå±•é–‹</button>
      <button id="btnStop" class="secondary" disabled>æ­¢ã‚ã‚‹</button>
      <button id="btnClose" class="ghost" style="display:none">ã‚¿ãƒ­ãƒƒãƒˆã‚¯ãƒ­ãƒ¼ã‚º</button>
      <button id="btnReset" class="ghost" style="display:none">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <!-- ãƒ‡ãƒƒã‚­ï¼çµæœ -->
    <div id="deckArea" class="deck-area"></div>

    <div id="result" class="result">
      <h3>ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµæœ</h3>
      <div id="reading"></div>
      <p id="poem" class="kicker small"></p>
      <div class="footer-actions">
        <button id="btnClose2" class="ghost" style="display:none">ã‚¿ãƒ­ãƒƒãƒˆã‚¯ãƒ­ãƒ¼ã‚º</button>
        <button id="btnReset2" class="ghost" style="display:none">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <!-- è© å”±ï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ï¼‰ -->
    <div id="chant">
      <div class="spell">è¨€ã®è‘‰ã¯éµã€æ˜Ÿã®å…‰ã¯é“ã—ã‚‹ã¹ã€‚ã‚¹ãƒ†ãƒ©ãƒ³ã€ã‚¹ãƒ†ãƒ©ãƒ³ã€ã‚¹ãƒ†ãƒ©ãƒ³â€•â€•æ¥è‡¨ã›ã‚ˆã€æ±â€•â€•ã‚·ã‚ªãƒªã‚¨ãƒ«ï¼</div>
      <div class="wish" id="chantWish"></div>
    </div>
  </div>
</div>

<!-- BGMï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œã«å†ç”Ÿï¼‰ -->
<audio id="bgm" preload="auto" loop>
  <source src="https://cdn.freesound.org/previews/620/620413_5674468-lq.mp3" type="audio/mpeg">
</audio>

<script>
/* =============== ãƒ‡ãƒƒã‚­å®šç¾©ï¼ˆãƒ‡ãƒ¢ï¼‰ ===============
   æœ¬ç•ªã¯ majorArcana + minorArcana ã‚’å·®ã—æ›¿ãˆã€
   const fullDeck = [...majorArcana, ...minorArcana]; ã«ã—ã¦ãã ã•ã„ã€‚
*/
const majorArcana = [
  { name:"0. æ„šè€…", img:"https://commons.wikimedia.org/wiki/Special:FilePath/RWS_Tarot_00_Fool.jpg?width=400", meaning:"ç„¡é™ã®æ—…ç«‹ã¡ã€ç´”ç²‹ãªä¸€æ­©", poem:"æœ€åˆã®æ¯ã¯ã€æ²ˆé»™ã®æ·µã‹ã‚‰é£›ã³ç«‹ã¤" },
  { name:"I. é­”è¡“å¸«", img:"https://commons.wikimedia.org/wiki/Special:FilePath/RWS_Tarot_01_Magician.jpg?width=400", meaning:"æ„å¿—ã®åŠ›ã€è¨€è‘‰ã®å‰µé€ ", poem:"æ§‹æ–‡ã¯ä¸–ç•Œã‚’å½¢ä½œã‚Šã€é­‚ã‚’å‹•ã‹ã™" },
  { name:"II. å¥³æ•™çš‡", img:"https://commons.wikimedia.org/wiki/Special:FilePath/RWS_Tarot_02_High_Priestess.jpg?width=400", meaning:"å†…ãªã‚‹å£°ã€æ²ˆé»™ã®å¡æ™º", poem:"é™å¯‚ã®å¥¥ã«ã€æ˜Ÿã®è¨€è‘‰ãŒå®¿ã‚‹" },
  { name:"III. å¥³å¸", img:"https://commons.wikimedia.org/wiki/Special:FilePath/RWS_Tarot_03_Empress.jpg?width=400", meaning:"è±Šç©£ã€æ¯ãªã‚‹æ„›", poem:"å¤§åœ°ã¯å¸Œæœ›ã‚’æŠ±ãã€å‘½ã‚’ç´¡ã" },
  { name:"IV. çš‡å¸", img:"https://commons.wikimedia.org/wiki/Special:FilePath/RWS_Tarot_04_Emperor.jpg?width=400", meaning:"ç§©åºã€ç¢ºã‹ãªç¤", poem:"éª¨çµ„ã¿ã¯ç¥ˆã‚Šã‚’æ”¯ãˆã€å…‰ã‚’å°ã" },
];
// æœ¬ç•ªï¼šconst fullDeck = [...majorArcana, ...minorArcana];
const fullDeck = [...majorArcana]; // ãƒ‡ãƒ¢ç”¨

/* =============== util =============== */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function sample3(deck){ return shuffle([...deck]).slice(0,3); }

/* =============== è¦ç´ å‚ç…§ =============== */
const panel = document.getElementById('panel');
const deckArea = document.getElementById('deckArea');
const btnStart = document.getElementById('btnStart');
const btnStop  = document.getElementById('btnStop');
const btnClose = document.getElementById('btnClose');
const btnReset = document.getElementById('btnReset');
const btnClose2= document.getElementById('btnClose2');
const btnReset2= document.getElementById('btnReset2');
const resultEl = document.getElementById('result');
const readingEl= document.getElementById('reading');
const poemEl   = document.getElementById('poem');
const wishEl   = document.getElementById('wish');
const chantEl  = document.getElementById('chant');
const chantWish= document.getElementById('chantWish');
const bgm      = document.getElementById('bgm');

let shuffleTimer=null, state='idle', bgmPrimed=false;

/* =============== æ˜Ÿç´‹ï¼ˆã‚¿ãƒƒãƒ—æ³¢ç´‹ï¼‰ =============== */
function spawnSigil(x,y){
  const span = document.createElement('span');
  span.className = 'sigil';
  // 8ç‚¹æ˜Ÿã®ç°¡æ˜“SVGï¼ˆstrokeã§å…‰ï¼‰
  span.innerHTML = `
    <svg viewBox="0 0 100 100" aria-hidden="true">
      <g fill="none" stroke="rgba(255,215,111,.9)" stroke-width="2">
        <path d="M50 10 L50 90 M10 50 L90 50 M22 22 L78 78 M78 22 L22 78"/>
        <circle cx="50" cy="50" r="10" stroke-width="1.5" />
      </g>
    </svg>`;
  span.style.left = x + 'px';
  span.style.top  = y + 'px';
  panel.appendChild(span);
  span.addEventListener('animationend',()=> span.remove());
}
// ãƒ‘ãƒãƒ«å†…ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã¨ãã«ç™ºç”Ÿ
panel.addEventListener('pointerdown', (e)=>{
  const rect = panel.getBoundingClientRect();
  spawnSigil(e.clientX - rect.left, e.clientY - rect.top);
});

/* =============== ã‚«ãƒ¼ãƒ‰DOM =============== */
function cardNode(card, mini=false){
  const d = document.createElement('div');
  d.className = 'card' + (mini ? ' is-mini' : '');
  d.innerHTML = `
    <div class="face front"><img src="${card.img}" loading="lazy" alt="${card.name}"></div>
    <div class="face back">âœ¶</div>
  `;
  return d;
}

/* =============== ã‚·ãƒ£ãƒƒãƒ•ãƒ«è¡¨ç¤º =============== */
function renderShuffleGrid(){
  deckArea.innerHTML = '';
  const view = sample3(fullDeck).concat(sample3(fullDeck), sample3(fullDeck), sample3(fullDeck).slice(0,5));
  view.forEach(c => deckArea.appendChild(cardNode(c, true)));
}
function startShuffle(){
  const wish = (wishEl.value || '').trim();
  if (!wish){ alert('ã¾ãšã€Œé¡˜ã„ã€ã‚’è¨€è‘‰ã«ã—ã¦ã­'); wishEl.focus(); return; }

  // åˆå›ã ã‘BGM prime
  if (!bgmPrimed){
    bgm.volume = 0.0;
    bgm.play().then(()=>{
      bgmPrimed = true;
      let v = 0.0;
      const t = setInterval(()=>{ v += 0.05; bgm.volume = Math.min(0.35, v); if (v>=0.35) clearInterval(t); }, 120);
    }).catch(()=>{});
  }

  state='shuffling';
  btnStart.disabled = true; btnStop.disabled = false;
  btnClose.style.display='none'; btnReset.style.display='none';
  resultEl.classList.remove('show'); chantEl.classList.remove('show');

  deckArea.innerHTML = '';

  // ğŸŒŸ å††çŠ¶é…ç½®ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«é–‹å§‹
  const tempDeck = shuffle([...fullDeck]);
  const total = Math.min(tempDeck.length, 22); // è¡¨ç¤ºã¯22æšãã‚‰ã„ã§ååˆ†
  const radius = 150; // å††ã®åŠå¾„
  const centerX = 0, centerY = 0;

  for(let i=0; i<total; i++){
    const c = tempDeck[i];
    const card = cardNode(c,true);
    const angle = (i / total) * 2 * Math.PI;
    const x = Math.cos(angle) * radius;
    const y = Math.sin(angle) * radius;
    card.style.position = 'absolute';
    card.style.left = `calc(50% + ${x}px)`;
    card.style.top  = `calc(50% + ${y}px)`;
    card.style.transform = `rotate(${angle}rad)`;
    deckArea.appendChild(card);
  }

  // å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  let rot = 0;
  shuffleTimer = setInterval(()=>{
    rot += 5; // å›è»¢é€Ÿåº¦
    deckArea.style.transform = `rotate(${rot}deg)`;
  }, 60);
}
/* =============== ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‹è© å”± =============== */
function showReading(cards){
  const [a,b,c] = cards;
  const wish = (wishEl.value || 'ã‚ãªãŸã®é­‚').trim();

  readingEl.innerHTML = `
    <p><strong>â‘  è©© â€” å½¢ã‚’ä¸ãˆã‚‹ï¼š</strong> ${a.name}ï¼${a.meaning}</p>
    <p><strong>â‘¡ éŸ» â€” éŸ¿ãã‚’é‡ã­ã‚‹ï¼š</strong> ${b.name}ï¼${b.meaning}</p>
    <p><strong>â‘¢ ç¥ˆ â€” å…‰ã¸å¸°ã™ï¼š</strong> <strong>${c.name}</strong>ï¼${c.meaning}</p>
    <p class="small" style="margin-top:.5rem">å±•é–‹ã®ç‰©èªï¼š${a.poem} â†’ ${b.poem} â†’ <strong>${c.poem}</strong></p>
  `;
  poemEl.textContent = 'ã€Œã‚¿ãƒ­ãƒƒãƒˆã‚¯ãƒ­ãƒ¼ã‚ºã€â€” é“ã¯é–‹ã‹ã‚ŒãŸã€‚å¤§ä¸ˆå¤«ã ã‚ˆã€‚';

  // è© å”±ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ï¼ˆé¡˜ã„ã‚’å·®ã—è¾¼ã‚€ï¼‰
  chantWish.textContent = `â”€â”€ é¡˜ã„ï¼šã€Œ${wish}ã€`;
  resultEl.classList.add('show');
  setTimeout(()=> chantEl.classList.add('show'), 250);
}

/* =============== ã‚¯ãƒ­ãƒ¼ã‚ºï¼ãƒªã‚»ãƒƒãƒˆ =============== */
function tarotClose(){
  if (state!=='revealed') return;
  resultEl.classList.remove('show');
  chantEl.classList.remove('show');
  state='closed';
}
function resetAll(){
  if (shuffleTimer){ clearInterval(shuffleTimer); shuffleTimer=null; }
  deckArea.innerHTML='';
  readingEl.innerHTML=''; poemEl.textContent='';
  chantEl.classList.remove('show');
  btnStart.disabled=false; btnStop.disabled=true;
  btnClose.style.display='none'; btnReset.style.display='none';
  btnClose2.style.display='none'; btnReset2.style.display='none';
  state='idle';
}

/* =============== ã‚¤ãƒ™ãƒ³ãƒˆ =============== */
btnStart.addEventListener('click', startShuffle);
btnStop .addEventListener('click', stopShuffleAndReveal);
btnClose.addEventListener('click', tarotClose);
btnClose2.addEventListener('click', tarotClose);
btnReset.addEventListener('click', resetAll);
btnReset2.addEventListener('click', resetAll);

// è»½ã„ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆflipç›´å¾Œã®ç™½æŠœã‘é˜²æ­¢ï¼‰
(function preloadFew(){ fullDeck.slice(0,6).forEach(c=>{ const i=new Image(); i.src=c.img; }); })();
</script>
</body>
</html>
