<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>詩韻思想 × TAROT BREAKER ― 星詠3枚リーディング</title>
  <meta name="theme-color" content="#0b0b1a" />
  <link rel="preload" as="image" href="/assets/tarot/back.jpg">
  <link rel="stylesheet" href="assets/css/style.css?v=20251101">
</head>
<body>

<main id="wish-reading" aria-labelledby="title">
  <header class="header">
    <h1 id="title">願い事を想像して――星詠3枚リーディング</h1>
    <p class="sub">「言葉は祈りの構文」——詩・韻・祈の三位一体で受け取る</p>
  </header>

  <!-- 願い入力 -->
  <div class="wishbox">
    <label for="wish" class="visually-hidden">あなたの願い</label>
    <input id="wish" type="text" inputmode="text" placeholder="あなたの願い（例：恋を進めたい、仕事を変えたい…）">
  </div>

  <!-- 初期：束（デッキ） -->
  <section class="stage" aria-live="polite">
    <div class="deck-area">
      <div class="deck-stack" aria-label="タロットの束">
        <div class="deck-back layer-1"></div>
        <div class="deck-back layer-2"></div>
        <div class="deck-back layer-3"></div>
      </div>
      <div class="controls">
        <button id="dealBtn" class="btn btn--primary" type="button">タロット展開</button>
        <button id="resetBtn" class="btn btn--ghost" type="button" hidden>リセット</button>
      </div>
      <p class="hint" id="hintText">ボタンを押すと、カードが光に包まれて3枚あらわれます</p>
    </div>

    <!-- 展開後：3枚横並び（最初は裏面） -->
    <div class="row" id="row" hidden aria-hidden="true">
      <button class="tap-note" type="button" tabindex="-1">カードをタップ</button>

      <div class="tarot-card" data-slot="0" role="button" aria-label="1枚目" tabindex="0">
        <div class="face"></div>
      </div>
      <div class="tarot-card" data-slot="1" role="button" aria-label="2枚目" tabindex="0">
        <div class="face"></div>
      </div>
      <div class="tarot-card" data-slot="2" role="button" aria-label="3枚目" tabindex="0">
        <div class="face"></div>
      </div>
    </div>

    <!-- 結果 -->
    <section class="result" id="result" hidden>
      <div class="result-item" data-trinity="詩（現在）">
        <h3 class="r-title">—</h3>
        <p class="r-text">—</p>
      </div>
      <div class="result-item" data-trinity="韻（未来）">
        <h3 class="r-title">—</h3>
        <p class="r-text">—</p>
      </div>
      <div class="result-item" data-trinity="祈（最終）">
        <h3 class="r-title">—</h3>
        <p class="r-text">—</p>
      </div>

      <p class="closing" id="closing">——</p>

      <div class="cta">
        <button id="closeBtn" class="btn btn--primary" type="button" hidden>タロットクローズ</button>
        <button id="resetBtn2" class="btn btn--ghost" type="button" hidden>リセット</button>
      </div>
    </section>
  </section>
</main>

<script>
(() => {
  // ------- 画像パスをあなたの環境に合わせて用意してね -------
  const DECK = [
    { name: "The Sun（太陽）", img: "/assets/tarot/majors/sun.jpg",
      poem: "迷いはほどけ、心はひらく。あなたの笑顔が道しるべ。" },
    { name: "The Lovers（恋人）", img: "/assets/tarot/majors/lovers.jpg",
      poem: "選ぶのは愛か、恐れか。手を伸ばせば、世界は結ばれる。" },
    { name: "Ace of Cups（杯のエース）", img: "/assets/tarot/minors/cups_ace.jpg",
      poem: "胸の泉がこぼれ落ちる。最初の一滴が、すべてを潤す。" },
    // 必要に応じて他のカードを追加（78枚対応可）
  ];

  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

  const row = $('#row');
  const hint = $('#hintText');
  const result = $('#result');
  const closeBtn = $('#closeBtn');
  const resetBtn = $('#resetBtn');
  const resetBtn2 = $('#resetBtn2');
  const dealBtn = $('#dealBtn');
  const closing = $('#closing');

  const cards = $$('.tarot-card');
  let draw = [];
  let flipped = 0;

  function shuffleDraw() {
    const arr = [...DECK].sort(() => Math.random() - 0.5);
    draw = arr.slice(0,3);
  }

  function deal() {
    shuffleDraw();

    // 束をフェードアウトして横並びを出す
    $('.deck-stack').classList.add('fade-out');
    setTimeout(() => {
      $('.deck-area').style.display = 'none';
      row.hidden = false;
      row.setAttribute('aria-hidden', 'false');
      // 光に包まれて出現
      cards.forEach((c, i) => {
        setTimeout(() => c.classList.add('show'), i * 250);
      });
      // ヒント変更
      hint.innerText = "カードをタップしてめくってね";
    }, 380);
  }

  function flipCard(cardEl, idx) {
    if (cardEl.classList.contains('is-flipped')) return;
    const face = cardEl.querySelector('.face');
    face.style.setProperty('--face-url', `url('${draw[idx].img}')`);
    cardEl.classList.add('is-flipped');
    flipped++;

    if (flipped === 3) {
      // 結果へ
      const names = draw.map(d => d.name);
      const poems = draw.map(d => d.poem);
      const wish = ($('#wish').value || 'あなたの願い').trim();

      const titleEls = $$('.r-title', result);
      const textEls  = $$('.r-text', result);
      names.forEach((n,i) => titleEls[i].textContent = n);
      poems.forEach((p,i) => textEls[i].textContent =
        `${p} —— 「${wish}」は、${names[2]}へと響き、やがて光になる。`);

      result.hidden = false;
      setTimeout(() => result.classList.add('reveal'), 10);
      closeBtn.hidden = false;
      resetBtn2.hidden = false;
    }
  }

  function closeReading() {
    closing.textContent = "タロットクローズ。—— 道は開かれた。大丈夫だよ。";
    closeBtn.disabled = true;
  }

  function resetAll() {
    // ページを素早く初期化
    window.location.reload();
  }

  // イベント
  dealBtn.addEventListener('click', deal);
  resetBtn.addEventListener('click', resetAll);
  resetBtn2.addEventListener('click', resetAll);
  closeBtn.addEventListener('click', closeReading);
  cards.forEach((el, i) => {
    el.addEventListener('click', () => flipCard(el, i));
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); flipCard(el,i); }
    });
  });
})();
</script>
</body>
</html>
