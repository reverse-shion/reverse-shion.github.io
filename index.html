<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>3枚タロット | Re:verse Shion</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="preload" as="audio" href="assets/sfx/flip.mp3">
  <link rel="preload" as="audio" href="assets/sfx/ping.mp3">
</head>
<body>
  <main class="wrap">
    <header class="page-head">
      <h1>🃏 3枚リーディング（体験）</h1>
      <p class="sub">現在／鍵／進む道。タップでめくれ、星紋が光るよ。</p>
    </header>

    <section id="reading" aria-labelledby="readingTitle">
      <h2 id="readingTitle" class="sr-only">3枚リーディング</h2>

      <div class="actions" role="group" aria-label="操作">
        <button id="btnStart" class="btn btn--primary">シャッフルして始める</button>
        <button id="btnReset" class="btn btn--ghost" disabled>リセット</button>
      </div>

      <div class="stage">
        <canvas id="ripple" aria-hidden="true"></canvas>

        <div class="deck" role="list" aria-label="カードデッキ">
          <!-- 1枚目 -->
          <div class="card-wrap" role="listitem">
            <button class="tarot-card" data-slot="1" aria-label="1枚目を引く" disabled>
              <div class="tarot-card-inner">
                <div class="face face-front"><img alt=""></div>
                <div class="face face-back" aria-hidden="true"></div>
              </div>
            </button>
            <div class="cap" data-cap="1" aria-live="polite"></div>
          </div>

          <!-- 2枚目 -->
          <div class="card-wrap" role="listitem">
            <button class="tarot-card" data-slot="2" aria-label="2枚目を引く" disabled>
              <div class="tarot-card-inner">
                <div class="face face-front"><img alt=""></div>
                <div class="face face-back" aria-hidden="true"></div>
              </div>
            </button>
            <div class="cap" data-cap="2" aria-live="polite"></div>
          </div>

          <!-- 3枚目 -->
          <div class="card-wrap" role="listitem">
            <button class="tarot-card" data-slot="3" aria-label="3枚目を引く" disabled>
              <div class="tarot-card-inner">
                <div class="face face-front"><img alt=""></div>
                <div class="face face-back" aria-hidden="true"></div>
              </div>
            </button>
            <div class="cap" data-cap="3" aria-live="polite"></div>
          </div>
        </div>
      </div>

      <!-- 結果：各3行 -->
      <div id="result" hidden>
        <div class="result-grid">
          <div class="result-item">
            <div class="badge">① 現在</div>
            <h3 class="res-title" data-title="1">—</h3>
            <p class="res-text"  data-text="1">—</p>
          </div>
          <div class="result-item">
            <div class="badge">② 鍵</div>
            <h3 class="res-title" data-title="2">—</h3>
            <p class="res-text"  data-text="2">—</p>
          </div>
          <div class="result-item">
            <div class="badge">③ 進む道</div>
            <h3 class="res-title" data-title="3">—</h3>
            <p class="res-text"  data-text="3">—</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- sfx -->
  <audio id="sfxFlip" preload="auto" src="assets/sfx/flip.mp3"></audio>
  <audio id="sfxPing" preload="auto" src="assets/sfx/ping.mp3"></audio>

  <div id="live" class="sr-only" aria-live="polite"></div>

  <script>
  /* ===== ASSETS 設定（ここだけ自分のパスに合わせてね） ===== */
  const CARD_BACK_URL = 'assets/tarot/back.png';              // 裏面
  const CARD_IMG_BASE = 'assets/tarot/rws/';                   // 表面のフォルダ
  // Rider–Waite（メジャー22枚：ファイル名は例。自分の命名に合わせて変更OK）
  const MAJORS = [
    ['愚者', '00_fool.jpg',        '自由に踏み出す','境界に立つ。','未知を怖れない。'],
    ['魔術師','01_magician.jpg',   'いま始める','手札を信じる。','言葉が現実を動かす。'],
    ['女教皇','02_priestess.jpg',  '静かに見極める','心の底に光。','急がず澄ます。'],
    ['女帝','03_empress.jpg',      '受け取り育てる','やさしさで満たす。','実りを楽しむ。'],
    ['皇帝','04_emperor.jpg',      '決めて動かす','軸を通す。','責任は力になる。'],
    ['教皇','05_hierophant.jpg',   '信頼に寄る','つながりに学ぶ。','伝統が護る。'],
    ['恋人','06_lovers.jpg',       '選び抜く','心に正直に。','選択が道になる。'],
    ['戦車','07_chariot.jpg',      '突破する','迷わず進む。','集中は勝ち筋。'],
    ['力','08_strength.jpg',       '優しさで制す','受容は勇気。','力は静かに働く。'],
    ['隠者','09_hermit.jpg',       '内に灯す','一人の時間を。','真実は静寂に。'],
    ['運命の輪','10_wheel.jpg',    '流れに乗る','偶然は合図。','波に身体を任せる。'],
    ['正義','11_justice.jpg',      '整えバランス','偏りを戻す。','誠実が通る。'],
    ['吊るされた男','12_hanged.jpg','意味を反転','手放しが鍵。','価値は視点に宿る。'],
    ['死神','13_death.jpg',        '一度終わらせる','古い殻を脱ぐ。','再生の準備。'],
    ['節制','14_temperance.jpg',   '混ぜ調和する','ほどよく。','流れを繋ぐ。'],
    ['悪魔','15_devil.jpg',        '執着を手放す','鎖は幻。','欲を飼い慣らす。'],
    ['塔','16_tower.jpg',          '壊して更新','崩壊は浄化。','真実だけ残る。'],
    ['星','17_star.jpg',           '希望を見る','遠くの光を信じる。','願いは動詞。'],
    ['月','18_moon.jpg',           '不安を識る','影の正体を見る。','夜は明ける。'],
    ['太陽','19_sun.jpg',          '喜びで進む','明るさは力。','堂々と。'],
    ['審判','20_judgement.jpg',    '呼び覚ます','再起動。','名を呼び戻す。'],
    ['世界','21_world.jpg',        '完成し次へ','一周回って始まり。','祝福と出発。']
  ];
  /* ======================================================= */

  // 工具
  const $  = (s,el=document)=>el.querySelector(s);
  const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
  const rand = n => Math.floor(Math.random()*n);

  // 要素
  const btnStart = $('#btnStart');
  const btnReset = $('#btnReset');
  const deck     = $('.deck');
  const cards    = $$('.tarot-card', deck);
  const caps     = $$('.cap');
  const ripple   = $('#ripple');
  const resBox   = $('#result');
  const sfxFlip  = $('#sfxFlip');
  const sfxPing  = $('#sfxPing');

  // キャンバス調整
  const fit = () => { ripple.width = ripple.clientWidth; ripple.height = ripple.clientHeight; };
  window.addEventListener('resize', fit, {passive:true}); fit();

  // 簡易リップル
  function rippleAt(x,y){
    const ctx = ripple.getContext('2d');
    const R = Math.max(ripple.width, ripple.height)*0.4;
    let t=0; const dur=420;
    const id = setInterval(()=>{
      t+=16; const p=t/dur; if(p>=1){clearInterval(id); ctx.clearRect(0,0,ripple.width,ripple.height); return;}
      ctx.clearRect(0,0,ripple.width,ripple.height);
      ctx.beginPath();
      ctx.arc(x, y, R*p, 0, Math.PI*2);
      ctx.strokeStyle = `rgba(255,215,111,${1-p})`;
      ctx.lineWidth = 2; ctx.stroke();
    },16);
  }

  // シャッフル（軽量）
  function shuffle(a){ const n=a.slice(); for(let i=n.length-1;i>0;i--){ const j=rand(i+1); [n[i],n[j]]=[n[j],n[i]] } return n }

  // 状態
  let stack = [];         // シャッフル結果（[name,img,k1,k2,k3]）
  let opened = {};        // {1: card, 2: card, 3: card}

  // 初期化
  function init(){
    resBox.hidden = true;
    opened = {};
    caps.forEach(c=>c.textContent='');
    cards.forEach(btn=>{
      btn.disabled = true;
      btn.classList.remove('is-flipped');
      // 裏面再設定
      $('.face-back',btn).style.backgroundImage = `url("${CARD_BACK_URL}")`;
      // 表面クリア
      $('.face-front img',btn).removeAttribute('src');
      $('.face-front img',btn).setAttribute('alt','');
    });
    btnReset.disabled = true;
    btnStart.disabled = false;
  }

  // 開始
  function start(){
    const shuf = shuffle(MAJORS);
    stack = shuf.slice(0,3); // 3枚使う
    cards.forEach(btn=>btn.disabled=false);
    btnStart.disabled = true;
    btnReset.disabled = false;
  }

  // 表示更新
  function showResultIfReady(){
    if(opened[1] && opened[2] && opened[3]){
      resBox.hidden = false;
      for (let i=1;i<=3;i++){
        const [name, , a,b,c] = opened[i];
        $(`.res-title[data-title="${i}"]`).textContent = name;
        $(`.res-text[data-text="${i}"]`).textContent = `${a}。${b}。${c}。`;
      }
      $('#live').textContent = 'リーディング完了。';
      sfxPing.currentTime=0; sfxPing.play().catch(()=>{});
    }
  }

  // カードをめくる
  function flip(slot, btn, e){
    if(opened[slot]) return;
    const card = stack.pop(); if(!card) return;
    opened[slot] = card;

    // 表面画像をセット
    const img = $('.face-front img', btn);
    img.src = CARD_IMG_BASE + card[1];
    img.alt = card[0];

    // 星紋
    const rect = btn.getBoundingClientRect();
    const x = (e?.clientX ?? (rect.left+rect.width/2)) - ripple.getBoundingClientRect().left;
    const y = (e?.clientY ?? (rect.top+rect.height/2))  - ripple.getBoundingClientRect().top;
    rippleAt(x,y);

    // 効果音＋フリップ
    sfxFlip.currentTime=0; sfxFlip.play().catch(()=>{});
    btn.classList.add('is-flipped');

    // キャプション（カード名）
    $(`.cap[data-cap="${slot}"]`).textContent = card[0];

    // 全て開いたら結果
    showResultIfReady();
  }

  // 監視
  cards.forEach(btn=>{
    btn.addEventListener('click', (e)=>{ if(!btn.disabled){ flip(btn.dataset.slot, btn, e); } });
  });
  btnStart.addEventListener('click', start);
  btnReset.addEventListener('click', init);

  // 初回
  init();
  </script>
</body>
</html>
