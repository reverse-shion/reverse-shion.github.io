<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>リュミエールの間 | Lumiere Gate</title>
  <style>
    :root {
      --silver: #f3f5ff;
      --lavender: #d9d7ff;
      --lavender-veil: rgba(217, 215, 255, 0.35);
      --pearl: rgba(255, 255, 255, 0.82);
      --gold: #f3d9a3;
      --gold-soft: rgba(243, 217, 163, 0.6);
      --text: #1b1e2a;
      --dialog-max: 900px;
      --glow: 0 0 16px rgba(255, 255, 255, 0.65);
      --shadow: 0 12px 32px rgba(12, 12, 20, 0.25);
      --shadow-soft: 0 8px 20px rgba(12, 12, 20, 0.12);
      --transition: 900ms ease;
      --font-ja: "Hiragino Sans", "Noto Sans JP", "Yu Gothic", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      color: var(--text);
      font-family: var(--font-ja);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    body {
      position: relative;
      background: radial-gradient(circle at 30% 15%, rgba(255, 255, 255, 0.3), transparent 35%),
        radial-gradient(circle at 80% 0%, rgba(255, 255, 255, 0.25), transparent 45%),
        linear-gradient(180deg, #0e0f1a 0%, #0a0b14 40%, #0b0c16 100%);
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    main {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    /* 星粒レイヤー */
    .star-field {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 1;
    }
    .star-field span {
      position: absolute;
      display: block;
      background: radial-gradient(circle, rgba(255,255,255,0.9) 0, rgba(255,255,255,0.2) 45%, transparent 70%);
      border-radius: 50%;
      animation: drift 18s linear infinite;
      opacity: 0.8;
      filter: blur(0.2px);
    }
    @keyframes drift {
      0% { transform: translate3d(0, 0, 0) scale(1); opacity: 0.2; }
      50% { opacity: 0.8; }
      100% { transform: translate3d(0, -40px, 0) scale(1.15); opacity: 0.15; }
    }

    /* シーン共通 */
    .scene {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      transition: opacity var(--transition);
      opacity: 0;
      pointer-events: none;
      z-index: 2;
    }

    .scene::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(5, 7, 16, 0.55) 0%, rgba(17, 18, 35, 0.35) 45%, rgba(38, 35, 58, 0.35) 100%);
      pointer-events: none;
    }

    .scene.is-active {
      opacity: 1;
      pointer-events: auto;
    }

    /* フォイヤー */
    .scene-foyer {
      background-image: url('img/foyer-lumiere.jpg');
    }

    .welcome-text {
      position: relative;
      text-align: center;
      color: #fdfbff;
      text-shadow: 0 0 12px rgba(255, 255, 255, 0.65), 0 0 24px rgba(243, 217, 163, 0.45);
      font-size: clamp(18px, 3vw, 26px);
      line-height: 1.8;
      letter-spacing: 0.08em;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 900ms ease, transform 900ms ease;
      z-index: 3;
      padding: 16px 22px;
    }

    .welcome-text.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* ホール */
    .scene-hall {
      background-image: url('img/lumiere-hall.jpg');
    }

    .hall-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 30%, rgba(255, 255, 255, 0.15), transparent 45%),
        radial-gradient(circle at 20% 70%, rgba(255, 229, 210, 0.16), transparent 45%),
        linear-gradient(180deg, rgba(10, 9, 25, 0.35), rgba(10, 9, 25, 0.48));
      pointer-events: none;
      z-index: 2;
    }

    .lumiere-full {
      position: absolute;
      bottom: 8vh;
      left: 50%;
      transform: translateX(-50%) translateY(10px);
      opacity: 0;
      max-width: min(60vh, 70vw);
      transition: opacity 800ms ease, transform 1600ms ease;
      z-index: 4;
      animation: float 9s ease-in-out infinite;
    }

    .lumiere-full.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    @keyframes float {
      0% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-8px); }
      100% { transform: translateX(-50%) translateY(0); }
    }

    /* バストアップ */
    .lumiere-bust {
      position: absolute;
      bottom: 12vh;
      left: 50%;
      transform: translateX(-50%);
      max-width: min(58vh, 78vw);
      opacity: 0;
      transition: opacity 800ms ease;
      z-index: 5;
    }

    .lumiere-bust.is-visible {
      opacity: 1;
    }

    .lumiere-bust img {
      display: block;
      width: 100%;
      height: auto;
      position: absolute;
      inset: 0;
      object-fit: contain;
    }

    .lumiere-bust .frame {
      position: relative;
      width: 100%;
      padding-bottom: 140%;
    }

    /* セリフウィンドウ */
    .dialogue-window {
      position: absolute;
      left: 50%;
      bottom: 5vh;
      transform: translateX(-50%);
      width: min(var(--dialog-max), 92vw);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.75), rgba(255, 255, 255, 0.58));
      border: 1px solid rgba(243, 217, 163, 0.6);
      border-radius: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      padding: clamp(14px, 3vw, 18px);
      color: #1b1e2a;
      z-index: 6;
      opacity: 0;
      transition: opacity 600ms ease;
    }

    .dialogue-window.is-visible {
      opacity: 1;
    }

    .dialogue-name {
      font-size: 14px;
      letter-spacing: 0.08em;
      color: #6c5c2c;
      margin-bottom: 6px;
    }

    .dialogue-text {
      white-space: pre-line;
      font-size: clamp(15px, 2.5vw, 17px);
      line-height: 1.7;
      min-height: 3.4em;
    }

    .dialogue-next {
      position: absolute;
      right: 14px;
      bottom: 10px;
      font-size: 13px;
      color: #876c2b;
      text-shadow: 0 0 8px rgba(243, 217, 163, 0.7);
      opacity: 0;
      animation: blink 1.4s ease-in-out infinite;
      user-select: none;
    }

    @keyframes blink {
      0%, 60% { opacity: 0; }
      100% { opacity: 1; }
    }

    /* 入力 */
    .name-input {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .name-input label {
      font-size: 14px;
      color: #3b3b52;
    }

    .name-input input {
      flex: 1 1 180px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(27, 30, 42, 0.2);
      font-size: 15px;
      font-family: var(--font-ja);
      background: rgba(255, 255, 255, 0.8);
      outline: none;
      transition: border-color 160ms ease, box-shadow 160ms ease;
    }

    .name-input input:focus {
      border-color: rgba(243, 217, 163, 0.8);
      box-shadow: 0 0 0 3px rgba(243, 217, 163, 0.25);
    }

    .name-input .error {
      width: 100%;
      color: #8a1f2d;
      font-size: 13px;
      margin-top: -4px;
    }

    .gold-button {
      position: relative;
      border: 1px solid rgba(243, 217, 163, 0.8);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.86), rgba(232, 225, 255, 0.8));
      color: #725c1b;
      border-radius: 14px;
      padding: 11px 18px;
      font-size: 15px;
      letter-spacing: 0.05em;
      cursor: pointer;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      transition: transform 160ms ease, box-shadow 160ms ease;
      font-family: var(--font-ja);
    }

    .gold-button:focus-visible {
      outline: 2px solid rgba(243, 217, 163, 0.8);
      outline-offset: 2px;
    }

    .gold-button:hover, .gold-button:active {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(111, 92, 24, 0.25);
    }

    .gold-button::after {
      content: "";
      position: absolute;
      inset: -20%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.45), transparent 50%);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 220ms ease, transform 220ms ease;
      pointer-events: none;
      z-index: 1;
    }

    .gold-button:hover::after, .gold-button:active::after {
      opacity: 1;
      transform: translateY(0);
    }

    .particle-layer {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
      z-index: 0;
    }

    .particle-layer span {
      position: absolute;
      width: 6px;
      height: 6px;
      background: radial-gradient(circle, rgba(255,255,255,0.9) 0, rgba(243, 217, 163, 0.7) 40%, transparent 70%);
      border-radius: 50%;
      opacity: 0;
      animation: sparkle 1200ms ease-out forwards;
    }

    @keyframes sparkle {
      0% { transform: translateY(12px) scale(0.6); opacity: 0; }
      30% { opacity: 1; }
      100% { transform: translateY(-16px) scale(1); opacity: 0; }
    }

    /* メニュー */
    .menu {
      position: absolute;
      left: 50%;
      bottom: 6vh;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      width: min(960px, 94vw);
      z-index: 5;
      opacity: 0;
      transition: opacity 600ms ease;
    }

    .menu.is-visible {
      opacity: 1;
    }

    /* サウンドボタン */
    .sound-toggle {
      position: fixed;
      top: 14px;
      right: 14px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(243, 217, 163, 0.7);
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
      display: grid;
      place-items: center;
      cursor: pointer;
      z-index: 20;
      transition: transform 140ms ease, box-shadow 140ms ease;
    }

    .sound-toggle:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
    .sound-toggle:active { transform: translateY(0); }

    .sound-toggle span {
      font-size: 18px;
      color: #5b4a1c;
      text-shadow: 0 0 6px rgba(243, 217, 163, 0.7);
      user-select: none;
    }

    /* 画面暗転用 */
    .overlay-dim {
      position: fixed;
      inset: 0;
      background: rgba(6, 7, 16, 0.65);
      z-index: 18;
      opacity: 0;
      pointer-events: none;
      transition: opacity 280ms ease;
      display: grid;
      place-items: center;
      color: #fdfbff;
      text-align: center;
      padding: 20px;
      font-size: 16px;
    }

    .overlay-dim.show { opacity: 1; pointer-events: auto; }

    @media (max-width: 720px) {
      .dialogue-window { bottom: 3vh; border-radius: 14px; }
      .menu { bottom: 3vh; gap: 10px; }
      .gold-button { width: calc(50% - 8px); justify-content: center; text-align: center; }
      .name-input { flex-direction: column; align-items: stretch; }
      .name-input input { width: 100%; }
    }

    @media (max-width: 480px) {
      .lumiere-full { bottom: 4vh; }
      .lumiere-bust { bottom: 8vh; }
      .dialogue-window { padding: 12px 14px 18px; }
    }

    /* 全体共通の位置を少し上げる／下げる */
.dialogue-window {
  bottom: 14vh;  /* 5vh → 14vh くらいに */
}

.menu {
  bottom: 4vh;   /* 6vh → 4vh にして画面の一番下寄りへ */
}

/* 画面の縦が短いスマホ向けに、さらに調整してもOK */
@media (max-height: 700px) {
  .dialogue-window { bottom: 18vh; }
  .menu { bottom: 3vh; }
}
  </style>
</head>
<body>
  <div class="star-field" aria-hidden="true"></div>
  <main>
    <section class="scene scene-foyer is-active" aria-label="静かな前室">
      <div class="welcome-text" id="welcomeText">
        <div>……ようこそ。</div>
        <div>ここは、リュミエールの間——星の記憶が静かに灯る場所。</div>
      </div>
    </section>

    <section class="scene scene-hall" aria-label="リュミエールの間">
      <div class="hall-overlay"></div>
      <img src="img/lumiere-full.png" alt="リュミエール全身" class="lumiere-full" id="fullFigure">

      <div class="lumiere-bust" id="bustContainer" aria-hidden="true">
        <div class="frame">
          <img src="img/lumiere-neutral-open.png" alt="リュミエール" id="bustOpen">
          <img src="img/lumiere-neutral-closed.png" alt="リュミエール" id="bustClosed" style="opacity:0;">
        </div>
      </div>

      <div class="dialogue-window" id="dialogueWindow" aria-live="polite">
        <div class="dialogue-name">Lumiere</div>
        <div class="dialogue-text" id="dialogueText"></div>
        <div class="dialogue-next" id="dialogueNext">▶</div>
        <div class="name-input" id="nameInput" style="display:none;">
          <label for="visitorName">あなたの名前</label>
          <input id="visitorName" name="visitorName" type="text" maxlength="20" aria-label="お名前入力欄">
          <button class="gold-button" id="nameSubmit" aria-label="この名前で呼んで">この名前で呼んで</button>
          <div class="error" id="nameError" aria-live="assertive"></div>
        </div>
      </div>

      <div class="menu" id="menu">
        <button class="gold-button" data-action="pray" aria-label="セレフィアスに祈りを捧げる">セレフィアスに祈りを捧げる<div class="particle-layer"></div></button>
        <button class="gold-button" data-action="village" aria-label="始まりの町に行く" style="display:none;">始まりの町に行く<div class="particle-layer"></div></button>
        <button class="gold-button" data-action="talk" aria-label="リュミエールと話す">リュミエールと話す<div class="particle-layer"></div></button>
      </div>
    </section>
  </main>

  <button class="sound-toggle" id="soundToggle" aria-label="BGM 切り替え"><span>♪</span></button>
  <div class="overlay-dim" id="dimOverlay"></div>
  <audio id="bgm" src="audio/lumiere-theme.mp3" loop preload="auto"></audio>

  <script>
    (() => {
      const starField = document.querySelector('.star-field');
      const sceneFoyer = document.querySelector('.scene-foyer');
      const sceneHall = document.querySelector('.scene-hall');
      const welcomeText = document.getElementById('welcomeText');
      const fullFigure = document.getElementById('fullFigure');
      const bustContainer = document.getElementById('bustContainer');
      const bustOpen = document.getElementById('bustOpen');
      const bustClosed = document.getElementById('bustClosed');
      const dialogueWindow = document.getElementById('dialogueWindow');
      const dialogueText = document.getElementById('dialogueText');
      const dialogueNext = document.getElementById('dialogueNext');
      const nameInput = document.getElementById('nameInput');
      const nameError = document.getElementById('nameError');
      const nameField = document.getElementById('visitorName');
      const nameSubmit = document.getElementById('nameSubmit');
      const menu = document.getElementById('menu');
      const menuButtons = menu.querySelectorAll('button');
      const soundToggle = document.getElementById('soundToggle');
      const bgm = document.getElementById('bgm');
      const dimOverlay = document.getElementById('dimOverlay');

      const STORAGE_NAME = 'lumiereVisitorName';
      const STORAGE_MUTE = 'lumiereBgmMuted';
      const blinkMin = 3000;
      const blinkMax = 7000;

      const fallbackLines = {
        sceneA_welcome: ['……ようこそ。', 'ここは、リュミエールの間——', '星の記憶が静かに灯る場所。'],
        sceneB_first: ['……聞こえる？', '星のささやきが、あなたをここまで連れてきたみたい。'],
        sceneB_askName: ['ねえ、あなたのお名前を、教えてくれる？'],
        sceneB_nameFixed: ['……{name}。', 'うん、とてもやさしい響き。', 'これからは、その名前で呼ぶね。'],
        menu_return: ['おかえりなさい、{name}。', '静かな光がまた一つ灯りました。'],
        conversation: ['最近、星たちが少しざわめいているの。', 'でも、大丈夫。あなたがそばにいてくれるから。', '疲れたら、いつでもここで休んでね。']
      };

      let lines = { ...fallbackLines };
      let currentLines = [];
      let lineIndex = 0;
      let typingTimer = null;
      let isTyping = false;
      let cachedName = localStorage.getItem(STORAGE_NAME) || '';
      let isConversation = false;
      let blinkTimer = null;
      let currentExpression = 'neutral';

      // 星粒生成
      const createStars = () => {
        const total = 40;
        for (let i = 0; i < total; i++) {
          const s = document.createElement('span');
          const size = Math.random() * 3 + 1;
          s.style.width = `${size}px`;
          s.style.height = `${size}px`;
          s.style.left = `${Math.random() * 100}%`;
          s.style.top = `${Math.random() * 100}%`;
          s.style.animationDuration = `${14 + Math.random() * 10}s`;
          s.style.animationDelay = `${Math.random() * 12}s`;
          starField.appendChild(s);
        }
      };

      // 粒子演出
      const spawnParticles = (btn) => {
        const layer = btn.querySelector('.particle-layer');
        if (!layer) return;
        layer.innerHTML = '';
        for (let i = 0; i < 6; i++) {
          const p = document.createElement('span');
          p.style.left = `${20 + Math.random() * 60}%`;
          p.style.top = `${60 + Math.random() * 30}%`;
          p.style.animationDelay = `${i * 60}ms`;
          layer.appendChild(p);
        }
      };

      // セリフパース
      const parseLines = (text) => {
        const blocks = text.split(/\n\s*---\s*\n/);
        const result = {};
        blocks.forEach(block => {
          const rows = block.trim().split(/\n/).filter(l => l.length > 0 || /^\s*$/.test(l));
          if (!rows.length) return;
          const idMatch = rows[0].match(/^\[(.+)\]$/);
          if (!idMatch) return;
          const id = idMatch[1].trim();
          const content = rows.slice(1).map(r => r.replace(/^\s+/, ''));
          if (content.length) {
            result[id] = content;
          }
        });
        return result;
      };

      const loadLines = async () => {
        try {
          const res = await fetch('data/lumiere-lines.txt');
          if (!res.ok) throw new Error('failed');
          const text = await res.text();
          const parsed = parseLines(text);
          lines = { ...fallbackLines, ...parsed };
        } catch (e) {
          lines = { ...fallbackLines };
        }
      };

      // タイプライター
      const showLine = (line, onComplete) => {
        clearInterval(typingTimer);
        dialogueNext.style.opacity = 0;
        const chars = line.split('');
        let idx = 0;
        dialogueText.textContent = '';
        isTyping = true;
        typingTimer = setInterval(() => {
          dialogueText.textContent += chars[idx];
          idx++;
          if (idx >= chars.length) {
            clearInterval(typingTimer);
            isTyping = false;
            dialogueNext.style.opacity = 1;
            if (onComplete) onComplete();
          }
        }, 35);
      };

      const showAll = (line) => {
        clearInterval(typingTimer);
        isTyping = false;
        dialogueText.textContent = line;
        dialogueNext.style.opacity = 1;
      };

      const playLines = (list, callback) => {
        currentLines = list.slice();
        lineIndex = 0;
        const next = () => {
          if (lineIndex >= currentLines.length) {
            if (callback) callback();
            return;
          }
          const line = currentLines[lineIndex];
          showLine(line, () => {});
        };
        const advance = () => {
          if (isTyping) {
            showAll(currentLines[lineIndex]);
            return;
          }
          lineIndex++;
          next();
        };
        dialogueWindow.onclick = advance;
        dialogueNext.onclick = advance;
        next();
      };

      // 名前付き置換
      const injectName = (arr) => arr.map(l => l.replace('{name}', cachedName));

      // BGM
      const setMute = (muted) => {
        bgm.muted = muted;
        soundToggle.querySelector('span').textContent = muted ? '♪×' : '♪';
        localStorage.setItem(STORAGE_MUTE, muted ? '1' : '0');
      };

      const ensureBgm = () => {
        if (bgm.dataset.started) return;
        bgm.dataset.started = '1';
        bgm.volume = 0.6;
        if (!bgm.muted) {
          bgm.play().catch(() => {});
        }
      };

      // 瞬き
      const scheduleBlink = () => {
        clearTimeout(blinkTimer);
        const delay = blinkMin + Math.random() * (blinkMax - blinkMin);
        blinkTimer = setTimeout(() => {
          bustClosed.style.opacity = 1;
          setTimeout(() => {
            bustClosed.style.opacity = 0;
            scheduleBlink();
          }, 140);
        }, delay);
      };

      const setExpression = (type) => {
        currentExpression = type;
        const openMap = {
          neutral: 'img/lumiere-neutral-open.png',
          smile: 'img/lumiere-smile-open.png',
          sad: 'img/lumiere-sad-open.png'
        };
        const closedMap = {
          neutral: 'img/lumiere-neutral-closed.png',
          smile: 'img/lumiere-smile-closed.png',
          sad: 'img/lumiere-sad-closed.png'
        };
        bustOpen.src = openMap[type] || openMap.neutral;
        bustClosed.src = closedMap[type] || closedMap.neutral;
      };

      // 画像プリロード
      const preloadImages = () => {
        const files = [
          'img/lumiere-neutral-open.png',
          'img/lumiere-neutral-closed.png',
          'img/lumiere-smile-open.png',
          'img/lumiere-smile-closed.png',
          'img/lumiere-sad-open.png',
          'img/lumiere-sad-closed.png'
        ];
        files.forEach(src => { const img = new Image(); img.src = src; });
      };

      // フロー
      const startFoyer = () => {
        dialogueWindow.classList.remove('is-visible');
        menu.classList.remove('is-visible');
        setTimeout(() => welcomeText.classList.add('show'), 3000);
        setTimeout(() => {
          welcomeText.classList.remove('show');
          sceneFoyer.classList.remove('is-active');
          sceneHall.classList.add('is-active');
          enterHall();
        }, 6200);
      };

      const enterHall = () => {
        fullFigure.classList.add('show');
        setTimeout(() => {
          dialogueWindow.classList.add('is-visible');
          runInitialDialogue();
        }, 1000);
      };

      const runInitialDialogue = () => {
  if (cachedName) {
    fullFigure.classList.remove('show');
    bustContainer.classList.add('is-visible');
    scheduleBlink();
    playLines(injectName(lines.menu_return || fallbackLines.menu_return), () => {
      // ★ここで一度セリフ窓を閉じる
      dialogueWindow.classList.remove('is-visible');
      setTimeout(() => {
        menu.classList.add('is-visible');
        updateMenuForReturn();
      }, 350); // フェードアウトに合わせて少し待つ
    });
    return;
  }

        const firstLines = lines.sceneB_first || fallbackLines.sceneB_first;
        const askLines = lines.sceneB_askName || fallbackLines.sceneB_askName;

        playLines(firstLines, () => {
          playLines(askLines, () => {
            nameInput.style.display = 'flex';
            nameField.focus();
            dialogueWindow.onclick = null;
            dialogueNext.onclick = null;
          });
        });
      };

      const showNameFixed = () => {
  const linesToShow = injectName(lines.sceneB_nameFixed || fallbackLines.sceneB_nameFixed);
  playLines(linesToShow, () => {
    // ★セリフ窓を先に閉じる
    dialogueWindow.classList.remove('is-visible');
    fullFigure.classList.remove('show');
    setTimeout(() => {
      bustContainer.classList.add('is-visible');
      scheduleBlink();
      menu.classList.add('is-visible');
      updateMenuForReturn();
    }, 700);
  });
};
      const updateMenuForReturn = () => {
        const villageBtn = menu.querySelector('[data-action="village"]');
        villageBtn.style.display = cachedName ? 'inline-flex' : 'none';
      };

      // 会話モード
      // 会話モード
const startConversation = () => {
  isConversation = true;

  // メニューは一度消す
  menu.classList.remove('is-visible');

  // ★ここを追加：会話用の状態に切り替え
  // 全身は消して、バストアップを必ず表示
  fullFigure.classList.remove('show');
  bustContainer.classList.add('is-visible');

  // セリフウィンドウも再表示（再訪問時や前回会話後など）
  dialogueWindow.classList.add('is-visible');

  // 表情は会話用にスマイルへ
  setExpression('smile');

  // 会話用セリフを再生
  playLines(lines.conversation || fallbackLines.conversation, endConversation);
};

      const endConversation = () => {
  isConversation = false;
  setExpression('neutral');
  // ★会話が終わったらウィンドウを閉じてからメニュー復帰
  dialogueWindow.classList.remove('is-visible');
  setTimeout(() => {
    menu.classList.add('is-visible');
  }, 350);
};

      // イベント
      nameSubmit.addEventListener('click', () => {
        const value = nameField.value.trim();
        if (!value) {
          nameError.textContent = '……お名前を教えてくれる？';
          return;
        }
        nameError.textContent = '';
        cachedName = value;
        localStorage.setItem(STORAGE_NAME, cachedName);
        nameInput.style.display = 'none';
        showNameFixed();
      });

      menuButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          spawnParticles(btn);
          ensureBgm();
          const action = btn.dataset.action;
          if (action === 'pray') {
            dimOverlay.textContent = '静かに祈りを届けています……';
            dimOverlay.classList.add('show');
            setTimeout(() => { window.location.href = 'serephias-gate.html'; /* TODO: 実際の遷移先に書き換えてください */ }, 900);
          }
          if (action === 'village') {
            dimOverlay.textContent = '風の音が、始まりの町へと導きます。';
            dimOverlay.classList.add('show');
            setTimeout(() => { window.location.href = 'village.html'; /* TODO: 実際の遷移先に書き換えてください */ }, 900);
          }
          if (action === 'talk') {
            dimOverlay.classList.remove('show');
            startConversation();
          }
        });
      });

      soundToggle.addEventListener('click', () => {
        const muted = !(localStorage.getItem(STORAGE_MUTE) === '1');
        setMute(muted);
        ensureBgm();
      });

      document.body.addEventListener('click', ensureBgm, { once: true });

      // 初期化
      const init = async () => {
        createStars();
        preloadImages();
        await loadLines();
        setMute(localStorage.getItem(STORAGE_MUTE) === '1');
        if (cachedName) {
          sceneFoyer.classList.remove('is-active');
          sceneHall.classList.add('is-active');
          fullFigure.classList.remove('show');
          dialogueWindow.classList.add('is-visible');
          setTimeout(() => {
            bustContainer.classList.add('is-visible');
            scheduleBlink();
            playLines(injectName(lines.menu_return || fallbackLines.menu_return), () => {
              menu.classList.add('is-visible');
              updateMenuForReturn();
            });
          }, 400);
        } else {
          startFoyer();
        }
      };

      init();
    })();
  </script>
</body>
</html>
