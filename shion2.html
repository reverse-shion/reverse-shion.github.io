<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>詩韻 Shion — 言葉で魂を救う Code｜無料タロット（詩・韻・祈）</title>
  <meta name="description" content="無料タロットで“詩・韻・祈”。詩韻 Shion の思想（言葉で魂を救う Code）に基づくリーディング。恋愛・復縁・連絡・進路の悩みに。">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Cormorant+Garamond:wght@400;600&display=swap" rel="stylesheet">
  <meta property="og:type" content="website">
  <meta property="og:title" content="詩韻 Shion — 言葉で魂を救う Code｜無料タロット（詩・韻・祈）">
  <meta property="og:description" content="“詩・韻・祈”で読む、思想連動タロット。儀式（星詠リチュアル）→展開→濃密リーディング→次の一歩へ。">
  <meta property="og:image" content="assets/ogp.jpg">
  <meta property="og:url" content="./">
  <style>
    /* 基本変数 */
    :root {
      --ink: #1e1b2b; --ink-strong: #f0f3ff; --muted: #8ea0c8; --violet: #6d4ba8; --lav: #9c7cc9; --gold: #ffd76f;
      --bg: #080a12; --glass: #ffffff1a; --r: 14px; --card-back-url: url("assets/back.png");
      --front0: linear-gradient(135deg, #ffe8b3, #caa8ff); --front1: linear-gradient(135deg, #b3ffe3, #a8b3ff);
      --front2: linear-gradient(135deg, #ffd1f7, #d1fff5);
    }
    @media (color-gamut: p3) { :root { --gold: color(display-p3 1 0.84 0.45); } }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: 'Noto Serif JP', serif; color: #eef1ff;
      background: radial-gradient(1200px 800px at 50% -10%, #16162a 0%, #0b0b1a 55%, #080a12 100%);
      overflow-x: hidden;
    }
    .sr-only { position: absolute !important; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; }

    /* 星屑（文字なぞり） */
    .stardust {
      position: fixed; inset: 0; pointer-events: none; z-index: 0; opacity: 0.35;
      background: radial-gradient(1.5px 1.5px at var(--x, 20%) var(--y, 30%), #ffd76f 0%, #ffd76f00 100%),
                  radial-gradient(2px 2px at var(--x2, 60%) var(--y2, 80%), #a8b3ff 0%, #0000 100%);
      animation: starwrite 8s ease-in-out infinite;
    }
    @keyframes starwrite { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.8; filter: blur(0.5px); } }

    /* ヒーロー（神殿 + AIグリッド） */
    .hero { position: relative; min-height: 100svh; display: grid; place-items: center; text-align: center; isolation: isolate; z-index: 1; }
    .hero__bg {
      position: absolute; inset: 0;
      background: linear-gradient(180deg, #0b0b1a 0%, #0b0b1a80 35%, #0b0b1a 100%),
                  url("assets/temple-altar.jpg") center/cover no-repeat;
      filter: saturate(1.05) brightness(0.98); transform: scale(1.03);
    }
    .hero::before {
      content: ''; position: absolute; inset: 0; z-index: 1; opacity: 0.15; animation: gridpulse 4s ease infinite;
      background: repeating-linear-gradient(90deg, #ffffff08 0px, transparent 1px, transparent 60px, #ffffff08 61px),
                  repeating-linear-gradient(0deg, #ffffff08 0px, transparent 1px, transparent 60px, #ffffff08 61px);
    }
    @keyframes gridpulse { 50% { opacity: 0.25; } }
    .hero__veil {
      position: absolute; inset: 0;
      background: radial-gradient(140px 180px at 50% 74%, #ffffffb0, #ffffff00 60%),
                  radial-gradient(1200px 720px at 50% 86%, #7c62ff33, #7c62ff00 70%);
      mix-blend-mode: screen; opacity: 0; transition: opacity 1.6s ease;
    }
    .hero__veil.is-on { opacity: 0.65; }
    .hero__inner { position: relative; z-index: 2; padding: clamp(16px, 4vw, 40px); max-width: 960px; }
    .hero__title {
      font-family: "Cormorant Garamond", serif; font-size: clamp(28px, 7vw, 56px); letter-spacing: 0.08em;
      background: linear-gradient(92deg, #FFE7A6 0%, #FFD76F 35%, #EEC35A 55%, #FFF5CF 75%, #FFD76F 100%);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      text-shadow: 0 2px 22px rgba(255,215,111,0.55), 0 0 60px rgba(124,98,255,0.28);
      -webkit-text-stroke: 0.3px rgba(10,8,20,0.35); position: relative;
    }
    .hero__title::after {
      content: '聖典'; position: absolute; top: -12px; right: -40px; font-size: 0.4em;
      color: #ffd76f; opacity: 0.6; font-family: 'Cormorant Garamond', serif; letter-spacing: 0.2em;
    }
    .hero__subtitle { margin: 0.8rem auto 0.6rem; max-width: 760px; color: var(--ink-strong); opacity: 0.98; line-height: 1.7; letter-spacing: 0.04em; text-shadow: 0 0 10px rgba(20,24,44,0.35); }
    .hero__poem { margin: 0 auto 1rem; max-width: 720px; color: #e1e6ff; font-style: italic; letter-spacing: 0.06em; line-height: 1.7; text-shadow: 0 0 10px rgba(130,140,255,0.25); }
    .hero__note { display: inline-block; margin: 0.5rem auto 0.8rem; padding: 0.5rem 1rem; border-radius: 999px; background: linear-gradient(90deg, #f9d86b, #caa8ff 60%, #8e79ff); color: #231b3a; font-weight: 700; letter-spacing: 0.06em; box-shadow: 0 8px 22px rgba(140,110,255,0.28), inset 0 0 10px rgba(255,240,210,0.35); }
    .btn-primary {
      appearance: none; border: 0; cursor: pointer; padding: 1rem 2rem; border-radius: 999px; font-weight: 800; font-size: 1.06rem;
      background: linear-gradient(90deg, #f9d86b, #caa8ff 55%, #8e79ff); color: #201a35; text-shadow: 0 1px 0 rgba(255,255,255,0.4);
      box-shadow: 0 14px 34px rgba(140,110,255,0.38), inset 0 0 12px rgba(255,240,200,0.35); transition: transform 0.18s, box-shadow 0.22s, filter 0.22s;
    }
    .btn-primary:hover { transform: translateY(-1px); filter: saturate(1.06); }
    .start-time { margin-top: 0.5rem; font-size: 0.95rem; color: #ffe8b3; opacity: 0; transition: opacity 0.6s ease; }
    .start-time.is-on { opacity: 0.9; }

    /* 儀式（聖典開く） */
    .hidden { display: none !important; }
    .ritual { position: relative; z-index: 2; padding: 60px 18px; text-align: center; }
    .codex { width: min(80vmin, 500px); height: min(60vmin, 380px); margin: 0 auto; position: relative; perspective: 1200px; }
    .codex__page {
      position: absolute; inset: 0; border-radius: 12px; background: linear-gradient(135deg, #1e1b2b, #2d1b3a);
      box-shadow: 0 0 40px #ffd76f33, inset 0 0 20px #caa8ff22; backface-visibility: hidden;
    }
    .codex__page--left { transform-origin: left; background: url("assets/codex-left.jpg") center/cover; }
    .codex__page--right { transform-origin: right; background: url("assets/codex-right.jpg") center/cover; transform: rotateY(0deg); }
    .codex.open .codex__page--left { animation: flipLeft 1.8s ease forwards; }
    .codex.open .codex__page--right { animation: flipRight 1.8s ease forwards; }
    @keyframes flipLeft { 0% { transform: rotateY(0deg); } 50% { transform: rotateY(-135deg); } 100% { transform: rotateY(-180deg); opacity: 0; } }
    @keyframes flipRight { 0% { transform: rotateY(0deg); } 50% { transform: rotateY(135deg); } 100% { transform: rotateY(180deg); opacity: 0; } }
    .codex__glow { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle, #ffd76f55, #ffd76f00 60%); filter: blur(1.5px); animation: pulse 3.2s ease-in-out infinite; }
    @keyframes pulse { 50% { transform: scale(1.06); filter: blur(2px); } }
    .ritual__line { font-size: 1.08rem; letter-spacing: 0.08em; color: #ffe8b3; margin: 0.25rem 0; }

    /* 展開 */
    .main { position: relative; z-index: 1; }
    .section { max-width: 1000px; margin: 0 auto; padding: 28px 16px; }
    .section__title { font-size: 1.1rem; color: var(--gold); letter-spacing: 0.12em; margin-bottom: 12px; }
    .spread { padding: 28px 12px; }
    .spread__labels { display: flex; gap: clamp(16px, 6vw, 40px); justify-content: center; margin-bottom: 12px; opacity: 0.9; }
    .label { width: clamp(100px, 22vw, 150px); text-align: center; color: #cfe2ff; font-size: clamp(12px, 3vw, 14px); letter-spacing: 0.12em; text-shadow: 0 0 10px rgba(174,138,255,0.45); }
    .spread__cards { display: flex; gap: clamp(12px, 3vw, 22px); justify-content: center; align-items: center; width: min(92vw, 980px); margin: 0 auto 10px; }
    .card {
      width: clamp(110px, 22vw, 160px); aspect-ratio: 62/110; perspective: 1100px; position: relative; cursor: pointer; flex: 0 0 auto;
      will-change: transform;
    }
    .card__inner {
      width: 100%; height: 100%; position: relative; border-radius: 12px; overflow: hidden; transition: transform 0.68s cubic-bezier(0.2, 0.7, 0.2, 1);
      transform-style: preserve-3d; box-shadow: 0 10px 30px rgba(0,0,0,0.45), 0 0 20px rgba(255,215,111,0.18);
    }
    .card__face { position: absolute; inset: 0; backface-visibility: hidden; border-radius: 12px; background-position: center; background-size: cover; }
    .card__back { background: #0b0f18 var(--card-back-url) center/cover no-repeat; }
    .card__front { transform: rotateY(180deg); }
    #card0 { background-image: var(--front0); } #card1 { background-image: var(--front1); } #card2 { background-image: var(--front2); }
    .card.is-flipped .card__inner { transform: rotateY(180deg); }
    .tap-hint { display: flex; justify-content: center; margin: 8px 0 4px; opacity: 0.9; }
    .tap-hint__pill {
      font-size: 0.9rem; padding: 8px 14px; border-radius: 999px; border: 1px solid rgba(255,215,111,0.55);
      background: rgba(0,0,0,0.35); color: #ffe7a6; letter-spacing: 0.08em; box-shadow: 0 0 14px rgba(255,215,111,0.15), inset 0 0 10px rgba(255,215,111,0.08); backdrop-filter: blur(6px);
      animation: blink 1.6s ease-in-out infinite;
    }
    @keyframes blink { 50% { opacity: 0.55; } }
    .peel { position: relative; width: min(92vw, 980px); height: 0; margin: 0 auto; }
    .peel.is-run {
      height: 1px; box-shadow: 0 0 80px 40px rgba(255,255,255,0.2); animation: peelFlash 950ms ease forwards;
    }
    @keyframes peelFlash { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0); } 30% { box-shadow: 0 0 140px 80px rgba(255,240,200,0.75); } 100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); } }

    /* About */
    .about__text { line-height: 1.9; color: #eef1ff; background: rgba(127,208,255,0.06); border: 1px solid rgba(127,208,255,0.22); border-radius: 12px; padding: 14px; }

    /* リーディング */
    .reading { background: linear-gradient(180deg, rgba(8,10,18,0.9), rgba(10,12,20,0.96)); border-top: 1px solid rgba(255,255,255,0.06); border-bottom: 1px solid rgba(255,255,255,0.06); }
    .reading__grid { display: grid; gap: 14px; grid-template-columns: 1fr; }
    @media (min-width: 760px) { .reading__grid { grid-template-columns: repeat(3, 1fr); } }
    .reading__item { background: rgba(127,208,255,0.08); border: 1px solid rgba(127,208,255,0.25); border-radius: 12px; padding: 14px; min-height: 110px; }
    .reading__head { color: #cfe2ff; font-size: 0.88rem; letter-spacing: 0.16em; margin-bottom: 6px; }
    .reading__body { line-height: 1.9; color: #eef1ff; }
    .reading.is-active .reading__item { box-shadow: 0 0 22px rgba(174,138,255,0.15); }

    /* 総合結果（鍵付き + 思想誘導） */
    .summary__poem { background: radial-gradient(600px 240px at 50% 0%, rgba(255,215,111,0.08), rgba(124,98,255,0.05)); border: 1px solid rgba(255,215,111,0.18); border-radius: 12px; padding: 16px; line-height: 1.95; color: #eef1ff; }
    .summary__poem p { margin: 0 0 0.4rem; }
    .locked { color: #666; font-style: italic; font-size: 0.9em; background: linear-gradient(90deg, #333, #222); padding: 4px 8px; border-radius: 6px; }
    .unlock { color: #00b900; font-weight: bold; text-decoration: underline; }
    .thought-invite { margin: 20px 0; padding: 16px; border: 1px dashed #ffd76f44; border-radius: 12px; text-align: center; font-size: 0.9em; color: #a8b3ff; }
    .thought-invite a { color: #ffd76f; text-decoration: underline; }
    .closing-line { margin: 18px 0 8px; color: #ffe8b3; opacity: 0.92; letter-spacing: 0.08em; }
    .cta { margin: 18px 0 8px; display: grid; gap: 10px; grid-template-columns: 1fr; }
    @media (min-width: 680px) { .cta { grid-template-columns: repeat(4, 1fr); } }
    .cta__btn {
      display: inline-flex; align-items: center; justify-content: center; padding: 12px 14px; border-radius: 12px; text-decoration: none; color: #ffe7a6;
      border: 1px solid rgba(255,215,111,0.5); background: rgba(0,0,0,0.35); box-shadow: 0 0 16px rgba(255,215,111,0.15), inset 0 0 12px rgba(255,215,111,0.08);
      transition: transform 0.15s, box-shadow 0.2s;
    }
    .cta__btn:hover { transform: translateY(-1px); }
    .cta__btn--line { background: linear-gradient(135deg, #00b900, #00d700); color: white; border-color: transparent; position: relative; overflow: hidden; }
    .cta__btn--line::after {
      content: '★ 個人鑑定で聖典の続きを ★'; position: absolute; inset: 0; background: rgba(0,0,0,0.8); color: #ffd76f; font-size: 0.8em;
      display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;
    }
    .cta__btn--line:hover::after { opacity: 1; }
    .cta__btn--tiktok { background: #000; color: #fff; border-color: #111; }
    .cta__btn--note { background: #fff; color: #333; border-color: #ddd; }
  </style>
</head>
<body>

  <!-- 星砂 -->
  <div class="stardust" aria-hidden="true"></div>

  <!-- ヒーロー -->
  <section class="hero" id="hero">
    <div class="hero__bg" aria-hidden="true"></div>
    <div class="hero__veil" aria-hidden="true"></div>
    <div class="hero__inner">
      <h1 class="hero__title">言葉で魂を救う<span class="hero__code">Code</span></h1>
      <p class="hero__subtitle">占い × 思想 ―― 詩（Poem）・韻（Rhythm）・祈（Prayer）で、あなたの“今”を言葉で照らす。</p>
      <p class="hero__poem">恋も、仕事も、運命も。―― 大丈夫だよ。</p>
      <p class="hero__note" aria-label="無料体験の注記">無料で体験できます／所要1分</p>
      <button id="startRitualBtn" class="btn-primary" type="button" aria-label="星詠リチュアルを始める">はじめる（星詠リチュアル）</button>
      <p class="start-time" id="startTime" aria-live="polite"></p>
    </div>
    <audio id="bgm" src="assets/sound/temple-ambient.mp3" preload="auto" loop playsinline></audio>
  </section>

  <!-- 儀式 -->
  <section id="ritual" class="ritual hidden" aria-live="polite" aria-atomic="true">
    <div class="codex" id="codex">
      <div class="codex__page codex__page--left"></div>
      <div class="codex__page codex__page--right"></div>
      <div class="codex__glow"></div>
    </div>
    <p class="ritual__line">星が、あなたの名を呼んでいる…</p>
  </section>

  <!-- タロット本編 -->
  <main id="main" class="main hidden" aria-labelledby="readingTitle">
    <section class="spread" aria-label="タロット展開">
      <h2 id="readingTitle" class="sr-only">詩・韻・祈 の三枚展開</h2>
      <div class="spread__labels" aria-hidden="true">
        <div class="label">詩</div><div class="label">韻</div><div class="label">祈</div>
      </div>
      <div class="spread__cards">
        <div class="card" data-idx="0" aria-label="詩のカード"><div class="card__inner"><div class="card__face card__back"></div><div class="card__face card__front" id="card0" role="img" aria-label="詩のカード 表面画像"></div></div></div>
        <div class="card" data-idx="1" aria-label="韻のカード"><div class="card__inner"><div class="card__face card__back"></div><div class="card__face card__front" id="card1" role="img" aria-label="韻のカード 表面画像"></div></div></div>
        <div class="card" data-idx="2" aria-label="祈のカード"><div class="card__inner"><div class="card__face card__back"></div><div class="card__face card__front" id="card2" role="img" aria-label="祈のカード 表面画像"></div></div></div>
      </div>
      <div class="tap-hint" id="tapHint"><div class="tap-hint__pill">カードを順にタップ</div></div>
      <div class="peel" id="peel" aria-hidden="true"></div>
    </section>

    <section class="about section">
      <h3 class="section__title">詩韻祈（しおんき）とは？</h3>
      <p class="about__text">あなたの魂がいま必要としている言葉を、<strong>三つの層</strong>（詩＝核／韻＝運び／祈＝帰路）で受け取る短詩リーディングです。<br>各カードは<strong>二行の詩</strong>として現れ、最後に<strong>九行の総合詩</strong>で「つまり、こういうこと」を示します。</p>
    </section>

    <section class="reading section" id="reading">
      <h3 class="section__title">詩・韻・祈 のリーディング</h3>
      <div class="reading__grid">
        <article class="reading__item"><div class="reading__head">詩（Poem）</div><div class="reading__body" id="body0">カードを開くと、ここに“詩”が現れます。</div></article>
        <article class="reading__item"><div class="reading__head">韻（Rhythm）</div><div class="reading__body" id="body1">カードを開くと、ここに“韻”が現れます。</div></article>
        <article class="reading__item"><div class="reading__head">祈（Prayer）</div><div class="reading__body" id="body2">カードを開くと、ここに“祈”が現れます。</div></article>
      </div>
    </section>

    <section class="summary section" id="summary">
      <h3 class="section__title">総合結果 ― つまり、こういうこと。</h3>
      <div class="summary__poem" id="summaryPoem">カードをすべて開くと、ここに九行のメッセージが現れます。</div>
      <div class="thought-invite">
        <p>この言葉は、<a href="https://note.com/your_note/m/magazine" target="_blank" rel="noopener">詩韻思想</a>の「星詠コード」から生まれた。</p>
        <p>もっと深く知りたい？ → <a href="https://note.com/your_note/m/magazine" target="_blank" rel="noopener">聖典を読む</a></p>
      </div>
      <p class="closing-line">大丈夫だよ。言葉は、あなたの光だから。</p>
      <nav class="cta">
        <a class="cta__btn" href="#" id="retry">もう一度占う</a>
        <a class="cta__btn cta__btn--line" href="https://lin.ee/9RBqOl4" target="_blank" rel="noopener">LINEで個人鑑定</a>
        <a class="cta__btn cta__btn--tiktok" href="https://www.tiktok.com/@your_tiktok" target="_blank" rel="noopener">TikTok配信を見る</a>
        <a class="cta__btn cta__btn--note" href="https://note.com/your_note/m/magazine" target="_blank" rel="noopener">詩韻思想を読む</a>
      </nav>
    </section>
  </main>

  <audio id="flipSe" src="https://freesound.org/data/previews/351/351408_5665338-lq.mp3" preload="auto"></audio>

  <script>
    // デッキ
    const deck = [
      { name: 'The Fool', idx: 0, two: ['最初の一歩は、恐れよりも軽い風。', '失敗は合図――世界は君に開く。'], kw: '始まり' },
      { name: 'The Magician', idx: 1, two: ['意志は手を、言葉は現実を動かす。', '足りないものは、すでに君の中にある。'], kw: '創造' },
      // ... (他のカードは元のまま、省略して簡潔に。実際には全22枚をコピー)
      { name: 'The World', idx: 21, two: ['輪は閉じて、道は開く。', '完成形は、次のスタートライン。'], kw: '成就' }
    ];

    // 要素
    const bgm = document.getElementById('bgm');
    const startBtn = document.getElementById('startRitualBtn');
    const startTimeEl = document.getElementById('startTime');
    const ritualSec = document.getElementById('ritual');
    const mainSec = document.getElementById('main');
    const peel = document.getElementById('peel');
    const tapHint = document.getElementById('tapHint');
    const summaryPoem = document.getElementById('summaryPoem');
    const retryBtn = document.getElementById('retry');
    const flipSe = document.getElementById('flipSe');
    const cardEls = document.querySelectorAll('.card');
    const fronts = [document.getElementById('card0'), document.getElementById('card1'), document.getElementById('card2')];
    const bodies = [document.getElementById('body0'), document.getElementById('body1'), document.getElementById('body2')];
    const defaultBodies = ['カードを開くと、ここに“詩”が現れます。', 'カードを開くと、ここに“韻”が現れます。', 'カードを開くと、ここに“祈”が現れます。'];
    let selected = []; let opened = 0;

    function kickBgm() { try { bgm.volume = 0.55; bgm.play().catch(() => {}); } catch (e) {} }

    function drawThree() {
      const pool = [...deck];
      const picks = [];
      for (let i = 0; i < 3; i++) {
        const r = crypto.getRandomValues(new Uint32Array(1))[0] % pool.length;
        picks.push(pool.splice(r, 1)[0]);
      }
      return picks;
    }

    function resetView() {
      opened = 0;
      bodies.forEach((el, i) => el.textContent = defaultBodies[i]);
      document.querySelector('.reading')?.classList.remove('is-active');
      summaryPoem.textContent = 'カードをすべて開くと、ここに九行のメッセージが現れます。';
      tapHint.style.opacity = 1;
      cardEls.forEach((el) => { el.classList.remove('is-flipped'); el.style.pointerEvents = 'auto'; });
    }

    function beginReading() { selected = drawThree(); resetView(); }

    async function beginRitual() {
      kickBgm();
      const now = new Date();
      const jst = new Intl.DateTimeFormat('ja-JP', { timeZone: 'Asia/Tokyo', hour: '2-digit', minute: '2-digit', year: 'numeric', month: '2-digit', day: '2-digit' }).format(now);
      startTimeEl.textContent = `星が動き出した時間：${jst}`;
      startTimeEl.classList.add('is-on');
      ritualSec.classList.remove('hidden');
      const codex = document.getElementById('codex');
      codex.classList.add('open');
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance('星が、あなたの名を呼んでいる…');
        utterance.lang = 'ja-JP'; utterance.rate = 0.9;
        speechSynthesis.speak(utterance);
      }
      await new Promise(resolve => setTimeout(resolve, 3800));
      ritualSec.classList.add('hidden');
      mainSec.classList.remove('hidden');
      peel.classList.add('is-run');
      peel.addEventListener('animationend', () => peel.classList.remove('is-run'), { once: true });
      beginReading();
      mainSec.scrollIntoView({ behavior: 'smooth', block: 'start' });
      generateCardsWithAI();
    }

    function generateCardsWithAI() {
      cardEls.forEach((card, i) => {
        setTimeout(() => {
          card.style.opacity = '0'; card.style.transform = 'scale(0.8)'; card.style.transition = 'all 0.6s ease';
          setTimeout(() => {
            card.style.background = 'radial-gradient(circle, #ffd76f, #caa8ff)'; card.style.opacity = '1'; card.style.transform = 'scale(1)';
          }, 300);
        }, i * 400);
      });
    }

    function twoLineText(card) { return `<span class="line">${card.two[0]}</span><br><span class="line">${card.two[1]}</span>`; }

    function buildSummaryPoem(sel) {
      const keys = sel.map(c => c.kw);
      const names = sel.map(c => c.name.replace('The ', ''));
      const lines = [
        `きみが扉を叩いた瞬間、時間は「味方」に変わった。`,
        `三つの言葉が、同じ方向を指している。`,
        `「${names[0]}」は告げる――${keys[0]}は、心の中心に種を置くこと。`,
        `「${names[1]}」は進めという――${keys[1]}は、迷いを動詞に変えること。`,
        `「${names[2]}」は還れという――${keys[2]}は、光へ戻る手順のこと。`,
        `だから焦らなくていい。速さより、整いを選べばいい。`,
        `<span class="locked">【鍵付き】この先の言葉は、個人鑑定で解錠されます。</span>`,
        `<span class="locked">→ <a href="https://lin.ee/9RBqOl4" class="unlock" target="_blank" rel="noopener">LINEで今すぐ鑑定</a></span>`,
        `大丈夫だよ。言葉は、必ず君を連れていく。`
      ];
      return lines.map(l => `<p>${l}</p>`).join('');
    }

    function onFlip(idx) {
      const cardEl = cardEls[idx];
      if (cardEl.classList.contains('is-flipped') || opened >= 3) return;
      try { flipSe.currentTime = 0; flipSe.play(); } catch (e) {}
      cardEl.classList.add('is-flipped'); opened++;
      const label = ['【詩】', '【韻】', '【祈】'][idx];
      bodies[idx].innerHTML = `<strong>${label}</strong> 《${selected[idx].name}》<br>${twoLineText(selected[idx])}`;
      if (opened === 3) {
        tapHint.style.opacity = 0; cardEls.forEach(c => c.style.pointerEvents = 'none');
        document.querySelector('.reading').classList.add('is-active');
        summaryPoem.innerHTML = buildSummaryPoem(selected);
        document.getElementById('summary').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    function onRetry(e) {
      e.preventDefault();
      document.getElementById('hero').scrollIntoView({ behavior: 'smooth' });
      setTimeout(beginReading, 600);
    }

    // イベント
    window.addEventListener('load', () => {
      document.querySelector('.spread__cards').addEventListener('click', e => {
        const card = e.target.closest('.card');
        if (card) onFlip(Number(card.dataset.idx));
      });
      startBtn.addEventListener('click', beginRitual);
      retryBtn.addEventListener('click', onRetry);
      setTimeout(() => document.querySelector('.hero__veil').classList.add('is-on'), 350);
    });

    window.addEventListener('touchstart', () => kickBgm(), { passive: true, once: true });
  </script>
</body>
</html>
